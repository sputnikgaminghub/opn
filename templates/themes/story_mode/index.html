<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Opinion (OPN) | Presale & Airdrop Platform</title>
    
    <!-- ========== FAVICON ========== -->
    <link rel="icon" type="image/png" href="/static/img/favicon-32.png">
    <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
    <link rel="preconnect" href="https://unpkg.com" crossorigin>
    <link rel="preconnect" href="https://translate.google.com" crossorigin>
    <link rel="apple-touch-icon" href="/static/img/apple-touch-icon.png">
    
    <!-- ========== OPEN GRAPH & SOCIAL META TAGS ========== -->
    <meta property="og:title" content="Opinion (OPN) | Presale & Airdrop Platform">
    <meta property="og:description" content="Join the Opinion (OPN) presale and airdrop platform. Be among the first to own OPN tokens with exclusive early-bird bonuses.">
    <meta property="og:image" content="https://i.postimg.cc/mZzVqpRt/PRESALE-IS-LIVE.png">
    <meta property="og:url" content="https://opiniondrop.onrender.com/">
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="Opinion (OPN)">
    
    <!-- ========== TWITTER CARD ========== -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Opinion (OPN) | Presale & Airdrop Platform">
    <meta name="twitter:description" content="Join the Opinion (OPN) presale and airdrop platform. Be among the first to own OPN tokens with exclusive early-bird bonuses.">
    <meta name="twitter:image" content="https://i.postimg.cc/mZzVqpRt/PRESALE-IS-LIVE.png">
    <meta name="twitter:site" content="@opinionlabsxyz">
    
    <!-- ========== ADDITIONAL META TAGS ========== -->
    <meta name="description" content="Join the Opinion (OPN) ICO, presale and airdrop platform. Be among the first to own OPN tokens with exclusive early-bird bonuses.">
    <meta name="keywords" content="Opinion (OPN), Opinion (OPN) cryptocurrency, Opinion (OPN) presale, Opinion (OPN) airdrop, Ethereum, blockchain, Opinion (OPN) token, crypto, Opinion (OPN) ICO">
    <meta name="author" content="Opinion (OPN)">
    
    <!-- ========== EXISTING STYLESHEETS & SCRIPTS ========== -->
    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"></noscript>
    <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js" defer></script>
    
    <!-- Web3 Support -->
    
        

    <!-- WalletConnect (EVM) -->
    <script src="https://unpkg.com/@walletconnect/ethereum-provider@2.23.1/dist/index.umd.js"></script>

    <!-- Solana Web3 (required for SOL payments) -->
    <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>
    

    <!-- Story Mode Theme (Warm & Human) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fraunces:opsz,wght@9..144,600;9..144,700&family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/themes/story_mode/story.css">

</head>
<body>

<div class="sm-shell">
  <header class="sm-topbar">
    <div class="sm-brand">
      <div class="sm-mark">OPN</div>
      <div class="sm-brandtext">
        <div class="sm-title">Opinion</div>
        <div class="sm-sub">Community presale ‚Ä¢ airdrop ‚Ä¢ streak rewards</div>
      </div>
    </div>

    <nav class="sm-chapters" aria-label="Page">
      <a class="sm-chip" href="#presale">Presale</a>
      <a class="sm-chip" href="#airdrop">Airdrop</a>
      <a class="sm-chip" href="#tokenomics">Tokenomics</a>
      <a class="sm-chip" href="#roadmap">Roadmap</a>
      <a class="sm-chip" href="#partners">Partners</a>
      <a class="sm-chip" href="#team">Team</a>
    </nav>

    <div class="sm-actions">
      <button class="sm-kbtn" id="smScrollTopBtn" type="button" title="Back to top">‚Üë</button>
      <button class="sm-kbtn sm-primary" id="smJumpAirdropBtn" type="button">Start</button>
    </div>
  </header>

  <section class="sm-hero">
    <div class="sm-hero-inner">
      <div class="sm-hero-copy">
        <h1>Warm, simple, and built for humans ‚Äî not hype.</h1>
        <p>
          Check your wallet, see your welcome bonus, and grow it with referrals, streaks, and community tasks.
          Same mechanics, new vibe.
        </p>
        <div class="sm-hero-ctas">
          <button class="sm-btn sm-btn-primary" id="smHeroStartBtn" type="button">Check my wallet</button>
          <a class="sm-btn sm-btn-ghost" href="#presale">Explore presale</a>
        </div>
        <div class="sm-trust">
          <div class="sm-pill">No hidden multipliers</div>
          <div class="sm-pill">Transparent breakdown</div>
          <div class="sm-pill">One click to share</div>
        </div>
      </div>

      <aside class="sm-journey" aria-label="Your Journey">
        <div class="sm-journey-head">
          <div>
            <div class="sm-journey-kicker">Your wallet journey</div>
            <div class="sm-journey-title">Balance, explained</div>
          </div>
          <div class="sm-total">
            <div class="sm-total-label">Estimated total</div>
            <div class="sm-total-value" id="smTotalValue">‚Äî</div>
          </div>
        </div>

        <div class="sm-steps" id="smSteps">
          <div class="sm-step">
            <div class="sm-step-dot"></div>
            <div class="sm-step-body">
              <div class="sm-step-title">Welcome bonus</div>
              <div class="sm-step-sub">Assigned once ‚Äî yours to keep</div>
            </div>
            <div class="sm-step-val" id="smBaseValue">‚Äî</div>
          </div>

          <div class="sm-step">
            <div class="sm-step-dot"></div>
            <div class="sm-step-body">
              <div class="sm-step-title">Referral boost</div>
              <div class="sm-step-sub"><span id="smReferralCount">0</span> friends ‚Ä¢ +121 each</div>
            </div>
            <div class="sm-step-val" id="smReferralValue">‚Äî</div>
          </div>

          <div class="sm-step">
            <div class="sm-step-dot"></div>
            <div class="sm-step-body">
              <div class="sm-step-title">Achievements</div>
              <div class="sm-step-sub">Milestones + community wins</div>
            </div>
            <div class="sm-step-val" id="smAchievementValue">‚Äî</div>
          </div>

          <div class="sm-step">
            <div class="sm-step-dot"></div>
            <div class="sm-step-body">
              <div class="sm-step-title">Streak rewards</div>
              <div class="sm-step-sub">Claim windows, daily caps, streak bonuses</div>
            </div>
            <div class="sm-step-val" id="smStreakValue">‚Äî</div>
          </div>
        </div>

        <div class="sm-journey-foot">
          <div class="sm-mini" id="smWalletLine">Wallet: ‚Äî</div>
          <div class="sm-mini" id="smStatusLine">Status: ‚Äî</div>
        </div>
      </aside>
    </div>
  </section>
</div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>
    
    <!-- Mobile Menu Overlay -->
    <div class="mobile-menu-overlay" id="mobileMenuOverlay">
        <button class="close-menu-btn" id="closeMenuBtn">
            <i class="fas fa-times"></i>
        </button>
        <a href="#" class="mobile-menu-link" data-section="presale">
            <i class="fas fa-fire"></i> Presale
        </a>
        <a href="#" class="mobile-menu-link" data-section="tokenomics">
            <i class="fas fa-chart-pie"></i> Tokenomics
        </a>
        <a href="#" class="mobile-menu-link" data-section="roadmap">
            <i class="fas fa-map"></i> Roadmap
        </a>
        <a href="#" class="mobile-menu-link" data-section="partners">
            <i class="fas fa-handshake"></i> Partners
        </a>
        <a href="#" class="mobile-menu-link" data-section="team">
            <i class="fas fa-users"></i> Team
        </a>
        <a href="#" class="mobile-menu-link" data-section="airdrop">
            <i class="fas fa-gift"></i> Airdrop
        </a>
        <a href="/stake" class="mobile-menu-link" data-external="stake">
            <i class="fas fa-coins"></i> Stake
        </a>
    </div>
    
    <!-- Navigation -->
    <nav class="main-nav">
        <div class="nav-container">
            <div class="nav-logo">
                <img src="/static/img/opn-icon.png" class="nav-apro-logo" alt="Opinion (OPN)" loading="lazy" decoding="async">
                <span>OPN TOKEN</span>
            </div>

            <!-- Mobile quick-access Stake button (shown on small screens) -->
            <div class="mobile-top-actions">
                <a class="mobile-top-stake" href="/stake" aria-label="Stake">
                    <i class="fas fa-coins"></i>
                </a>
            </div>
            
            <div class="desktop-nav">
                <a href="#" class="nav-link active" data-section="presale">
                    <i class="fas fa-fire"></i>
                    <span>Presale</span>
                </a>
                <a href="#" class="nav-link" data-section="tokenomics">
                    <i class="fas fa-chart-pie"></i>
                    <span>Tokenomics</span>
                </a>
                <a href="#" class="nav-link" data-section="roadmap">
                    <i class="fas fa-map"></i>
                    <span>Roadmap</span>
                </a>
                <a href="#" class="nav-link" data-section="partners">
                    <i class="fas fa-handshake"></i>
                    <span>Partners</span>
                </a>
                <a href="#" class="nav-link" data-section="team">
                    <i class="fas fa-users"></i>
                    <span>Team</span>
                </a>
                <a href="/stake" class="nav-link" data-external="stake">
                    <i class="fas fa-coins"></i>
                    <span>Stake</span>
                </a>
                <a href="#" class="nav-link" data-section="airdrop">
                    <i class="fas fa-gift"></i>
                    <span>Airdrop</span>
                </a>
            </div>
            
            <div class="nav-wallet" style="display: flex; align-items: center; gap: 10px; position: relative;">
                <div id="google_translate_element" style="display:none;"></div>

                <!-- Theme switcher (t-shirt icon only) -->
                <div class="theme-wrap" style="position: relative;">
                    <button class="theme-switch" id="themeBtn" type="button" aria-label="Theme">
                        <i class="fas fa-tshirt"></i>
                    </button>
                    <div class="theme-dropdown" id="themeDropdown" role="menu" aria-label="Choose theme">
                        <button class="theme-option" type="button" data-theme-option="default_purple"><span>Default Purple</span><span class="theme-swatch" style="background:#7c3aed"></span></button>
                        <button class="theme-option" type="button" data-theme-option="cyber_blue_cyan"><span>Cyber Blue/Cyan</span><span class="theme-swatch" style="background:#00e5ff"></span></button>
                        <button class="theme-option" type="button" data-theme-option="magenta_violet"><span>Magenta/Violet</span><span class="theme-swatch" style="background:#ff4ecd"></span></button>
                        <button class="theme-option" type="button" data-theme-option="teal_emerald"><span>Teal/Emerald</span><span class="theme-swatch" style="background:#2dd4bf"></span></button>
                        <button class="theme-option" type="button" data-theme-option="amber_gold"><span>Amber/Gold</span><span class="theme-swatch" style="background:#f5c542"></span></button>
                        <button class="theme-option" type="button" data-theme-option="red_neon"><span>Red Neon</span><span class="theme-swatch" style="background:#ff3b3b"></span></button>
                        <button class="theme-option" type="button" data-theme-option="mono_neon"><span>Mono Neon</span><span class="theme-swatch" style="background:#00ff88"></span></button>
                    </div>
                </div>

                <button class="lang-switch" id="langBtn" type="button" aria-label="Language">
                    <i class="fas fa-globe"></i>
                    <span id="currentLang">EN</span>
                </button>
                <div class="lang-dropdown" id="langDropdown" role="menu" aria-label="Choose language">
                    <button class="lang-option" type="button" data-lang="en"><span>English</span><span class="hint">EN</span></button>
                    <button class="lang-option" type="button" data-lang="es"><span>Espa√±ol</span><span class="hint">ES</span></button>
                    <button class="lang-option" type="button" data-lang="fr"><span>Fran√ßais</span><span class="hint">FR</span></button>
                    <button class="lang-option" type="button" data-lang="de"><span>Deutsch</span><span class="hint">DE</span></button>
                    <button class="lang-option" type="button" data-lang="pt"><span>Portugu√™s</span><span class="hint">PT</span></button>
                    <button class="lang-option" type="button" data-lang="ru"><span>–†—É—Å—Å–∫–∏–π</span><span class="hint">RU</span></button>
                    <button class="lang-option" type="button" data-lang="tr"><span>T√ºrk√ße</span><span class="hint">TR</span></button>
                    <button class="lang-option" type="button" data-lang="ar"><span>ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</span><span class="hint">AR</span></button>
                    <button class="lang-option" type="button" data-lang="hi"><span>‡§π‡§ø‡§®‡•ç‡§¶‡•Ä</span><span class="hint">HI</span></button>
                    <button class="lang-option" type="button" data-lang="id"><span>Bahasa</span><span class="hint">ID</span></button>
                    <button class="lang-option" type="button" data-lang="zh-CN"><span>‰∏≠Êñá</span><span class="hint">ZH</span></button>
                    <button class="lang-option" type="button" data-lang="ja"><span>Êó•Êú¨Ë™û</span><span class="hint">JA</span></button>
                </div>

                <button class="mobile-menu-btn" id="mobileMenuBtn" type="button" aria-label="Menu">
                <i class="fas fa-bars"></i>
            </button>
            </div>
        </div>
    </nav>
<!-- Main Content -->
    <div class="container">
        <div class="main-content">
            <!-- Presale Section -->
            <section id="presale" class="section active">
                <div class="section-header">
                    <h2>Join the Opinion (OPN) Presale</h2>
                    <p>Be among the first to own OPN tokens with exclusive early-bird bonuses</p>
                </div>

                <!-- Presale hero: announcement (left) + countdown/status (right on desktop, stacked on mobile) -->
                <div class="presale-hero">
                    <div class="presale-hero-left">
                        <div class="airdrop-announcement-banner" aria-label="Airdrop announcement">
                            <img src="https://i.postimg.cc/mZzVqpRt/PRESALE-IS-LIVE.png" alt="Presale is live" loading="lazy" decoding="async">
                        </div>
                    </div>
                    <div class="presale-hero-right">
                        <!-- Dynamic Token Status -->
                        <div class="token-status-container" id="tokenStatusContainer">
                            <!-- Content will be dynamically inserted -->
                        </div>
                    </div>
                </div>


                <div class="presale-container">
                    <!-- Left Card: Participation & Payments -->
                    <div class="card">
                        <h3 style="color: var(--primary); margin-bottom: 20px; font-size: 22px;">Participate in Presale</h3>
                        
                        <!-- Tier System -->
                        <div class="tier-system" style="margin-bottom: 25px;">
                            <div class="tier" style="background: rgba(0, 255, 136, 0.1); padding: 15px; border-radius: 12px; margin-bottom: 10px; border: 1px solid rgba(0, 255, 136, 0.3);">
                                <h4 style="color: var(--primary); margin-bottom: 5px; font-size: 16px;">üéØ Tier 1: 0.1 - 1 ETH</h4>
                                <p style="color: var(--primary); font-weight: 600; font-size: 14px;">+20% Bonus Tokens</p>
                            </div>
                            <div class="tier" style="background: rgba(255, 255, 255, 0.05); padding: 15px; border-radius: 12px; margin-bottom: 10px; border: 1px solid rgba(255, 255, 255, 0.1);">
                                <h4 style="color: var(--text-primary); margin-bottom: 5px; font-size: 16px;">üöÄ Tier 2: 1 - 5 ETH</h4>
                                <p style="color: var(--warning); font-weight: 600; font-size: 14px;">+25% Bonus Tokens</p>
                            </div>
                            <div class="tier" style="background: rgba(255, 255, 255, 0.05); padding: 15px; border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.1);">
                                <h4 style="color: var(--text-primary); margin-bottom: 5px; font-size: 16px;">üíé Tier 3: 5+ ETH</h4>
                                <p style="color: var(--warning); font-weight: 600; font-size: 14px;">+30% Bonus Tokens</p>
                            </div>
                        </div>
                        
                        <!-- Token Calculator -->
                        <div class="contribution-form">
                            <div class="input-group">
                                <label for="ethAmount">Enter ETH Amount</label>
                                <input type="number" id="ethAmount" min="0.1" step="0.1" placeholder="0.1" value="0.1">
                            </div>
                            
                            <div class="calculator-results" style="background: rgba(255, 255, 255, 0.05); padding: 20px; border-radius: 12px; margin: 20px 0; border: 1px solid rgba(255, 255, 255, 0.1);">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                    <span style="color: var(--text-secondary); font-size: 14px;">Tokens Received:</span>
                                    <strong style="color: var(--primary); font-size: 14px;" id="tokensReceived">0 OPN</strong>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                    <span style="color: var(--text-secondary); font-size: 14px;">Bonus Tokens:</span>
                                    <strong style="color: var(--warning); font-size: 14px;" id="bonusTokens">0 OPN</strong>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding-top: 10px; border-top: 1px solid rgba(255, 255, 255, 0.1);">
                                    <span style="color: var(--text-secondary); font-weight: 600; font-size: 14px;">Total Tokens:</span>
                                    <strong style="color: var(--primary); font-size: 16px;" id="totalTokens">0 OPN</strong>
                                </div>
                            </div>
                            
                            <!-- Payment Method Tabs -->
                            <div class="payment-tabs">
                                <div class="payment-tab active" data-tab="manual">
                                    <i class="fas fa-copy"></i> Manual
                                </div>
                                <div class="payment-tab" data-tab="web3">
                                    <i class="fas fa-plug"></i> Web3 Gateway
                                </div>
                                <div class="payment-tab" data-tab="solana">
                                    <i class="fas fa-bolt"></i> Solana
                                </div>
                            </div>
                            
                            <!-- Manual Payment Content -->
                            <div id="manualPayment" class="payment-content active">
                                <div class="manual-instructions">
                                    <h4 style="color: var(--primary); margin-bottom: 10px; font-size: 16px; display: flex; align-items: center; gap: 8px;">
                                        <i class="fas fa-wallet"></i> Manual Payment Instructions
                                    </h4>
                                    
                                    <button class="btn" id="presaleContributeBtn" onclick="showPresaleInstructions()">
                                        <i class="fas fa-paper-plane"></i> Show Presale Instructions
                                    </button>
                                    
                                    <div id="manualInstructions" style="display: none; margin-top: 15px;">
                                        <p style="color: var(--text-secondary); font-size: 13px; margin-bottom: 10px;">
                                            Send ETH from your personal wallet to the address below:
                                        </p>
                                        <div class="address-copy-row">
                                            <div class="address-display" id="manualAddressDisplay">
                                            0xa84e6D0Fa3B35b18FF7C65568C711A85Ac1A9FC7
                                        </div>
                                            <button class="btn-secondary copy-inline" onclick="copyPresaleAddress()">
                                                <i class="fas fa-copy"></i> Copy
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- NowPayments Integration -->
                                <div class="nowpayments-section">
                                    <p style="color: var(--text-secondary); font-size: 14px; margin-bottom: 15px;">
                                        <i class="fas fa-credit-card"></i> Alternative payment method:
                                    </p>
                                    <a href="https://nowpayments.io/donation?api_key=b8eedf66-359a-408e-b01d-e45b3006d199" target="_blank" rel="noreferrer noopener" style="display: block;">
                                        <img src="https://i.postimg.cc/4NQNYDGw/Chat-GPT-Image-Jan-30-2026-05-36-28-PM.png" alt="Cryptocurrency & Bitcoin donation button by NOWPayments" style="width: 100%; border-radius: 10px;" loading="lazy" decoding="async">
                                    </a>
                                    <p class="nowpayments-note">
                                        Accepts multiple cryptocurrencies ‚Ä¢ Credit card support ‚Ä¢ Minimum: $50 USD
                                    </p>
                                </div>
                            </div>
                            
                            <!-- Web3 Gateway Content -->
                            <div id="web3Payment" class="payment-content">
                                <div class="web3-container">
                                    <!-- USD Amount Input -->
                                    <div class="web3-input-group">
                                        <label class="web3-label" for="web3UsdAmount">
                                            <i class="fas fa-dollar-sign"></i> Amount in USD (Minimum: $50)
                                        </label>
                                        <div class="web3-input-wrapper">
                                            <span class="usd-symbol">$</span>
                                            <input type="number" id="web3UsdAmount" class="web3-input" placeholder="0.00" min="50" step="0.01" value="50">
                                        </div>
                                        <div id="web3MinAmountNote" style="color: var(--error); font-size: 12px; margin-top: 5px; display: none;">
                                            <i class="fas fa-exclamation-circle"></i> Minimum amount is $50
                                        </div>
                                    </div>
                                    
                                    <!-- Token Conversion Display -->
                                    <div id="web3ConversionDisplay" style="background: rgba(108, 99, 255, 0.1); border-radius: 12px; padding: 15px; margin: 15px 0; border: 1px solid rgba(108, 99, 255, 0.2);">
                                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid rgba(255, 255, 255, 0.05);">
                                            <span style="color: var(--text-secondary); font-size: 13px;">ETH:</span>
                                            <strong style="color: var(--eth-color); font-family: monospace; font-size: 13px;" id="web3EthAmount">0.016</strong>
                                        </div>
                                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid rgba(255, 255, 255, 0.05);">
                                            <span style="color: var(--text-secondary); font-size: 13px;">BNB:</span>
                                            <strong style="color: var(--bnb-color); font-family: monospace; font-size: 13px;" id="web3BnbAmount">0.057</strong>
                                        </div>
                                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid rgba(255, 255, 255, 0.05);">
                                            <span style="color: var(--text-secondary); font-size: 13px;">USDT (ERC20):</span>
                                            <strong style="color: var(--usdt-color); font-family: monospace; font-size: 13px;" id="web3UsdtErcAmount">50.00</strong>
                                        </div>
                                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0;">
                                            <span style="color: var(--text-secondary); font-size: 13px;">USDT (BEP20):</span>
                                            <strong style="color: var(--usdt-color); font-family: monospace; font-size: 13px;" id="web3UsdtBepAmount">50.00</strong>
                                        </div>
                                    </div>
                                    
                                    
                                    <!-- Payment Steps (Mobile guidance) -->
                                    <div class="web3-stepbar" id="web3Stepbar">
                                        <div class="web3-stepbar-title">Payment steps</div>
                                        <div class="web3-stepbar-text"><strong>Step 1:</strong> Select the crypto you want to pay with &nbsp; <strong>Step 2:</strong> Tap <strong>Connect Wallet</strong></div>
                                    </div>

                                    <!-- Token Selection -->
                                    <div class="web3-payment-options">
                                        <button class="web3-payment-btn" data-token="ETH" data-network="ethereum" onclick="selectWeb3Token(this)">
                                            <img src="https://cryptologos.cc/logos/ethereum-eth-logo.png" alt="ETH" class="token-logo" loading="lazy" decoding="async">
                                            <span style="font-size: 13px; font-weight: 600;">ETH</span>
                                            <span style="font-size: 11px; color: var(--text-secondary);" id="web3EthText">0.016</span>
                                        </button>
                                        
                                        <button class="web3-payment-btn" data-token="BNB" data-network="bsc" onclick="selectWeb3Token(this)">
                                            <img src="https://cryptologos.cc/logos/binance-coin-bnb-logo.png" alt="BNB" class="token-logo" loading="lazy" decoding="async">
                                            <span style="font-size: 13px; font-weight: 600;">BNB</span>
                                            <span style="font-size: 11px; color: var(--text-secondary);" id="web3BnbText">0.057</span>
                                        </button>
                                        
                                        <button class="web3-payment-btn" data-token="USDT_ERC20" data-network="ethereum" onclick="selectWeb3Token(this)">
                                            <img src="https://cryptologos.cc/logos/tether-usdt-logo.png" alt="USDT" class="token-logo" loading="lazy" decoding="async">
                                            <span style="font-size: 13px; font-weight: 600;">USDT</span>
                                            <span style="font-size: 11px; color: var(--text-secondary);">ERC20</span>
                                            <span style="font-size: 11px; color: var(--text-secondary);" id="web3UsdtErcText">50.00</span>
                                        </button>
                                        
                                        <button class="web3-payment-btn" data-token="USDT_BEP20" data-network="bsc" onclick="selectWeb3Token(this)">
                                            <img src="https://cryptologos.cc/logos/tether-usdt-logo.png" alt="USDT" class="token-logo" loading="lazy" decoding="async">
                                            <span style="font-size: 13px; font-weight: 600;">USDT</span>
                                            <span style="font-size: 11px; color: var(--text-secondary);">BEP20</span>
                                            <span style="font-size: 11px; color: var(--text-secondary);" id="web3UsdtBepText">50.00</span>
                                        </button>
                                    </div>
                                    
                                    <!-- Wallet Connection -->
                                    <div class="web3-wallet-section">
                                        <div class="web3-wallet-info">
                                            <div>
                                                <div id="web3WalletAddress">Not connected</div>
                                                <div id="web3NetworkInfo"></div>
                                            </div>
                                            <button id="web3ConnectWallet" class="btn btn-web3" style="padding: 10px 20px; font-size: 14px; width: auto;">
                                                <i class="fas fa-plug"></i> Connect Wallet
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <!-- Payment Button -->
                                    <button id="web3PayBtn" class="btn btn-success" disabled>
                                        <i class="fas fa-lock"></i> Process Payment
                                    </button>
                                    
                                    <!-- Status Display -->
                                    <div id="web3Status" class="web3-status"></div>
                                </div>
                            </div>

                            <!-- Solana Payment Content -->
                            <div id="solanaPayment" class="payment-content">
                                <div class="web3-container">
                                    <div class="web3-header">
                                        <h3 class="web3-title"><i class="fas fa-bolt"></i> Solana Presale Gateway</h3>
                                        <p class="web3-description">Connect a Solana wallet (Phantom/Solflare/Backpack) and pay with SOL.</p>
                                    </div>
                                    <div class="web3-input-group">
                                        <label class="web3-label" for="solUsdAmount">
                                            <i class="fas fa-dollar-sign"></i> Amount in USD (Minimum: $50)
                                        </label>
                                        <div class="web3-input-wrapper">
                                            <span class="web3-input-prefix">$</span>
                                            <input type="number" id="solUsdAmount" class="web3-input" placeholder="50" min="50" step="1">
                                        </div>
                                    </div>

                                    <div class="web3-actions">
                                        <button id="solConnectBtn" class="web3-connect-btn" onclick="openSolanaModal()">
                                            <i class="fas fa-wallet"></i> Connect Solana Wallet
                                        </button>
                                        <button id="solPayBtn" class="web3-pay-btn" onclick="processSolanaPayment()" disabled>
                                            <i class="fas fa-paper-plane"></i> Pay with SOL
                                        </button>
                                    </div>

                                    <div id="solanaStatus" class="web3-status"></div>
                                </div>
                            </div>

                            
                            <!-- Info Notes -->
                            <div style="margin-top: 25px; color: var(--text-secondary); font-size: 13px;">
                                <p><i class="fas fa-info-circle" style="color: var(--primary); margin-right: 8px;"></i> Mini buy 50 USD/ETH/BNB, Max buy 50,000 USD</p>
                                <p><i class="fas fa-info-circle" style="color: var(--primary); margin-right: 8px;"></i> Presale ends on February 20, 2026 Followed by Binance Listing</p>
                                <p><i class="fas fa-info-circle" style="color: var(--primary); margin-right: 8px;"></i> Our system will automatically send OPN tokens to your wallet instantly after TGE.</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Right Card: Presale Details -->
                    <div class="card">
                        <h3 style="color: var(--primary); margin-bottom: 20px; font-size: 22px;">Presale Details</h3>
                        <div class="details-list">
                            <div style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid rgba(255, 255, 255, 0.05);">
                                <span style="color: var(--text-secondary); font-size: 14px;">Token Name:</span>
                                <strong style="color: var(--text-primary); font-size: 14px;">Opinion</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid rgba(255, 255, 255, 0.05);">
                                <span style="color: var(--text-secondary); font-size: 14px;">Token Symbol:</span>
                                <strong style="color: var(--text-primary); font-size: 14px;">OPN</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid rgba(255, 255, 255, 0.05);">
                                <span style="color: var(--text-secondary); font-size: 14px;">Total Supply:</span>
                                <strong style="color: var(--text-primary); font-size: 14px;">1,000,000,000 OPN</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid rgba(255, 255, 255, 0.05);">
                                <span style="color: var(--text-secondary); font-size: 14px;">Presale Allocation:</span>
                                <strong style="color: var(--primary); font-size: 14px;">200,000,000 (20%)</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid rgba(255, 255, 255, 0.05);">
                                <span style="color: var(--text-secondary); font-size: 14px;">Presale Price:</span>
                                <strong style="color: var(--primary); font-size: 14px;">1 ETH = 100,000 OPN</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid rgba(255, 255, 255, 0.05);">
                                <span style="color: var(--text-secondary); font-size: 14px;">Hard Cap:</span>
                                <strong style="color: var(--text-primary); font-size: 14px;">$50,000,000</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid rgba(255, 255, 255, 0.05);">
                                <span style="color: var(--text-secondary); font-size: 14px;">Soft Cap:</span>
                                <strong style="color: var(--text-primary); font-size: 14px;">$10,000,000</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 12px 0;">
                                <span style="color: var(--text-secondary); font-size: 14px;">Network:</span>
                                <strong style="color: var(--text-primary); font-size: 14px;">Ethereum & BSC</strong>
                            </div>
                        </div>

                        <!-- Presale Address Section -->
                        <div style="margin-top: 25px;">
                            <div style="background: rgba(0, 255, 136, 0.1); border-radius: 12px; padding: 20px; border: 1px solid rgba(0, 255, 136, 0.3);">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                    <h4 style="color: var(--primary); margin: 0; font-size: 16px; display: flex; align-items: center; gap: 8px;">
                                        <i class="fas fa-wallet"></i> Presale Wallet Address
                                    </h4>
                                    <div style="background: rgba(0, 0, 0, 0.3); padding: 4px 10px; border-radius: 6px; font-size: 12px; color: var(--primary); font-weight: 600;">
                                        11909 ETH Raised
                                    </div>
                                </div>
                                
                                <div style="display: flex; align-items: center; gap: 10px; background: rgba(0, 0, 0, 0.2); padding: 12px 15px; border-radius: 8px; border: 1px solid rgba(255, 255, 255, 0.1); margin-bottom: 12px;">
                                    <code style="color: var(--primary); font-family: monospace; font-size: 13px; flex: 1; word-break: break-all;">
                                        0xa84e6D0Fa3B35b18FF7C65568C711A85Ac1A9FC7
                                    </code>
                                    <button onclick="copyPresaleAddress()" style="background: rgba(0, 255, 136, 0.2); border: 1px solid rgba(0, 255, 136, 0.5); color: var(--primary); padding: 6px 12px; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 5px; white-space: nowrap;">
                                        <i class="fas fa-copy"></i> Copy
                                    </button>
                                </div>
                                
                                <div style="display: flex; align-items: center; gap: 8px; color: var(--text-secondary); font-size: 12px;">
                                    <i class="fas fa-shield-alt" style="color: var(--primary);"></i>
                                    <span>Address verified and secure</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Warning Section -->
                        <div style="margin-top: 20px;">
                            <div style="background: rgba(255, 170, 0, 0.1); border-radius: 12px; padding: 20px; border: 1px solid rgba(255, 170, 0, 0.3);">
                                <div style="display: flex; align-items: flex-start; gap: 12px;">
                                    <div style="color: var(--warning); font-size: 18px; margin-top: 2px; flex-shrink: 0;">
                                        <i class="fas fa-exclamation-triangle"></i>
                                    </div>
                                    <div>
                                        <h4 style="color: var(--warning); margin-bottom: 8px; font-size: 16px;">Important Notice</h4>
                                        <p style="color: var(--text-primary); font-size: 14px; line-height: 1.5; margin-bottom: 10px;">
                                            Do not send ETH from exchanges. Only send from your personal wallet (MetaMask, Trust Wallet, etc.).
                                        </p>
                                        <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 12px;">
                                            <div style="display: flex; align-items: center; gap: 5px; padding: 5px 10px; background: rgba(255, 255, 255, 0.05); border-radius: 6px; border: 1px solid rgba(255, 255, 255, 0.1);">
                                                <i class="fas fa-check" style="color: var(--primary); font-size: 10px;"></i>
                                                <span style="color: var(--text-secondary); font-size: 11px;">MetaMask</span>
                                            </div>
                                            <div style="display: flex; align-items: center; gap: 5px; padding: 5px 10px; background: rgba(255, 255, 255, 0.05); border-radius: 6px; border: 1px solid rgba(255, 255, 255, 0.1);">
                                                <i class="fas fa-check" style="color: var(--primary); font-size: 10px;"></i>
                                                <span style="color: var(--text-secondary); font-size: 11px;">Trust Wallet</span>
                                            </div>
                                            <div style="display: flex; align-items: center; gap: 5px; padding: 5px 10px; background: rgba(255, 255, 255, 0.05); border-radius: 6px; border: 1px solid rgba(255, 255, 255, 0.1);">
                                                <i class="fas fa-check" style="color: var(--primary); font-size: 10px;"></i>
                                                <span style="color: var(--text-secondary); font-size: 11px;">Coinbase Wallet</span>
                                            </div>
                                            <div style="display: flex; align-items: center; gap: 5px; padding: 5px 10px; background: rgba(255, 255, 255, 0.05); border-radius: 6px; border: 1px solid rgba(255, 255, 255, 0.1);">
                                                <i class="fas fa-check" style="color: var(--primary); font-size: 10px;"></i>
                                                <span style="color: var(--text-secondary); font-size: 11px;">Ledger</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
            </section>
            
            <!-- Tokenomics Section -->
            <section id="tokenomics" class="section">
                <div class="section-header">
                    <h2>Tokenomics</h2>
                    <p>Strategic allocation for sustainable growth</p>
                </div>
                
                <div class="presale-container">
                    <div class="card">
                        <h3 style="color: var(--primary); margin-bottom: 20px; font-size: 22px;">Token Allocation</h3>
                        <div style="width: 100%; height: 300px; margin-bottom: 30px;">
                            <canvas id="tokenomicsChart"></canvas>
                        </div>
                        
                        <div class="allocation-breakdown">
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px; background: rgba(0, 255, 136, 0.1); border-radius: 12px; margin-bottom: 10px; border: 1px solid rgba(0, 255, 136, 0.3);">
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    <div style="width: 12px; height: 12px; background: #00ff88; border-radius: 50%;"></div>
                                    <div>
                                        <div style="font-weight: 600; color: var(--text-primary); font-size: 14px;">Ecosystem & Development</div>
                                        <div style="font-size: 12px; color: var(--text-secondary);">400,000,000 OPN</div>
                                    </div>
                                </div>
                                <div style="font-weight: 700; color: var(--primary); font-size: 14px;">40%</div>
                            </div>
                            
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px; background: rgba(255, 255, 255, 0.05); border-radius: 12px; margin-bottom: 10px; border: 1px solid rgba(255, 255, 255, 0.1);">
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    <div style="width: 12px; height: 12px; background: #667eea; border-radius: 50%;"></div>
                                    <div>
                                        <div style="font-weight: 600; color: var(--text-primary); font-size: 14px;">Community & Airdrop</div>
                                        <div style="font-size: 12px; color: var(--text-secondary);">200,000,000 OPN</div>
                                    </div>
                                </div>
                                <div style="font-weight: 700; color: var(--primary); font-size: 14px;">20%</div>
                            </div>
                            
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px; background: rgba(255, 255, 255, 0.05); border-radius: 12px; margin-bottom: 10px; border: 1px solid rgba(255, 255, 255, 0.1);">
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    <div style="width: 12px; height: 12px; background: #764ba2; border-radius: 50%;"></div>
                                    <div>
                                        <div style="font-weight: 600; color: var(--text-primary); font-size: 14px;">Team & Advisors</div>
                                        <div style="font-size: 12px; color: var(--text-secondary);">150,000,000 OPN</div>
                                    </div>
                                </div>
                                <div style="font-weight: 700; color: var(--primary); font-size: 14px;">15%</div>
                            </div>
                            
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px; background: rgba(255, 255, 255, 0.05); border-radius: 12px; margin-bottom: 10px; border: 1px solid rgba(255, 255, 255, 0.1);">
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    <div style="width: 12px; height: 12px; background: #ff6b6b; border-radius: 50%;"></div>
                                    <div>
                                        <div style="font-weight: 600; color: var(--text-primary); font-size: 14px;">Liquidity & Exchange</div>
                                        <div style="font-size: 12px; color: var(--text-secondary);">150,000,000 OPN</div>
                                    </div>
                                </div>
                                <div style="font-weight: 700; color: var(--primary); font-size: 14px;">15%</div>
                            </div>
                            
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px; background: rgba(255, 255, 255, 0.05); border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.1);">
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    <div style="width: 12px; height: 12px; background: #ffaa00; border-radius: 50%;"></div>
                                    <div>
                                        <div style="font-weight: 600; color: var(--text-primary); font-size: 14px;">Marketing & Partnerships</div>
                                        <div style="font-size: 12px; color: var(--text-secondary);">100,000,000 OPN</div>
                                    </div>
                                </div>
                                <div style="font-weight: 700; color: var(--primary); font-size: 14px;">10%</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h3 style="color: var(--primary); margin-bottom: 20px; font-size: 22px;">Token Metrics</h3>
                        <div class="details-list">
                            <div style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid rgba(255, 255, 255, 0.05);">
                                <span style="color: var(--text-secondary); font-size: 14px;">Total Supply:</span>
                                <strong style="color: var(--text-primary); font-size: 14px;">1,000,000,000 OPN</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid rgba(255, 255, 255, 0.05);">
                                <span style="color: var(--text-secondary); font-size: 14px;">Token Name:</span>
                                <strong style="color: var(--text-primary); font-size: 14px;">Opinion</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid rgba(255, 255, 255, 0.05);">
                                <span style="color: var(--text-secondary); font-size: 14px;">Symbol:</span>
                                <strong style="color: var(--text-primary); font-size: 14px;">OPN</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid rgba(255, 255, 255, 0.05);">
                                <span style="color: var(--text-secondary); font-size: 14px;">Decimals:</span>
                                <strong style="color: var(--text-primary); font-size: 14px;">18</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid rgba(255, 255, 255, 0.05);">
                                <span style="color: var(--text-secondary); font-size: 14px;">Network:</span>
                                <strong style="color: var(--text-primary); font-size: 14px;">Ethereum</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid rgba(255, 255, 255, 0.05);">
                                <span style="color: var(--text-secondary); font-size: 14px;">Contract:</span>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <strong style="color: var(--primary); font-family: monospace; font-size: 12px;"><span id="tokenContractAddress">Coming Soon</span></strong>
                                    <button style="background: rgba(255, 255, 255, 0.1); border: none; color: var(--text-primary); padding: 4px 8px; border-radius: 4px; font-size: 11px; cursor: pointer;" onclick="copyTextToClipboard(document.getElementById('tokenContractAddress').innerText, 'Contract address copied')">Copy</button>
                                </div>
                            </div>
                        </div>

                        <div style="margin-top: 18px; background: rgba(255, 255, 255, 0.03); padding: 15px; border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.08);">
                            <div style="font-weight: 700; color: var(--text-primary); margin-bottom: 8px;">Token Utility</div>
                            <p style="margin: 0; color: var(--text-secondary); font-size: 13px; line-height: 1.6;">
                                The OPN token functions as the core utility token of the Opinion ecosystem, enabling access to platform services, governance participation, and network value capture.
                            </p>
                        </div>

                        <h3 style="color: var(--primary); margin: 25px 0 15px 0; font-size: 18px;">Vesting Schedule</h3>
                        <div style="background: rgba(255, 255, 255, 0.03); padding: 15px; border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.1);">
                            <div style="display: flex; align-items: flex-start; gap: 15px; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid rgba(255, 255, 255, 0.05);">
                                <div style="width: 12px; height: 12px; background: var(--primary); border-radius: 50%; margin-top: 5px;"></div>
                                <div>
                                    <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 5px; font-size: 14px;">Team & Advisors</div>
                                    <div style="color: var(--text-secondary); font-size: 13px;">6-month cliff, then 24-month linear vesting</div>
                                </div>
                            </div>
                            <div style="display: flex; align-items: flex-start; gap: 15px; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid rgba(255, 255, 255, 0.05);">
                                <div style="width: 12px; height: 12px; background: var(--secondary); border-radius: 50%; margin-top: 5px;"></div>
                                <div>
                                    <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 5px; font-size: 14px;">Ecosystem & Development</div>
                                    <div style="color: var(--text-secondary); font-size: 13px;">Released quarterly based on milestones</div>
                                </div>
                            </div>
                            <div style="display: flex; align-items: flex-start; gap: 15px;">
                                <div style="width: 12px; height: 12px; background: var(--accent); border-radius: 50%; margin-top: 5px;"></div>
                                <div>
                                    <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 5px; font-size: 14px;">Presale Tokens</div>
                                    <div style="color: var(--text-secondary); font-size: 13px;">25% at TGE, 75% vested over 3 months</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- Roadmap Section -->
            <section id="roadmap" class="section">
                <div class="section-header">
                    <h2>Roadmap</h2>
                    <p>Our journey to revolutionize the Ethereum ecosystem</p>
                </div>
                
                <div class="card">
                    <div style="position: relative; padding-left: 30px;">
                        <!-- Timeline line -->
                        <div style="position: absolute; left: 0; top: 0; bottom: 0; width: 2px; background: linear-gradient(to bottom, var(--primary), var(--secondary));"></div>
                        
                        <!-- Q3 2025 -->
                        <div style="position: relative; margin-bottom: 30px;">
                            <div style="position: absolute; left: -35px; top: 0; width: 20px; height: 20px; background: var(--primary); border-radius: 50%; border: 4px solid var(--background);"></div>
                            <div style="margin-left: 20px;">
                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                                    <h3 style="color: var(--primary); font-size: 18px;">Q3 2025</h3>
                                    <span style="background: rgba(0, 255, 136, 0.1); color: var(--primary); padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 600;">COMPLETED</span>
                                </div>
                                <ul style="color: var(--text-secondary); margin-left: 20px; font-size: 14px;">
                                    <li style="margin-bottom: 8px;">‚úì Platform Development & Smart Contract Audit</li>
                                    <li style="margin-bottom: 8px;">‚úì Community Building & Social Media Launch</li>
                                    <li style="margin-bottom: 8px;">‚úì Whitepaper Release & Token Design</li>
                                    <li>‚úì Strategic Partnerships Established</li>
                                </ul>
                            </div>
                        </div>
                        
                        <!-- Q4 2025 -->
                        <div style="position: relative; margin-bottom: 30px;">
                            <div style="position: absolute; left: -35px; top: 0; width: 20px; height: 20px; background: var(--secondary); border-radius: 50%; border: 4px solid var(--background);"></div>
                            <div style="margin-left: 20px;">
                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                                    <h3 style="color: var(--text-primary); font-size: 18px;">Q4 2025</h3>
                                    <span style="background: rgba(102, 126, 234, 0.1); color: var(--secondary); padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 600;">CURRENT</span>
                                </div>
                                <ul style="color: var(--text-secondary); margin-left: 20px; font-size: 14px;">
                                    <li style="margin-bottom: 8px;">‚óØ Presale Launch & Token Distribution</li>
                                    <li style="margin-bottom: 8px;">‚óØ DEX Listings (Uniswap, PancakeSwap)</li>
                                    <li style="margin-bottom: 8px;">‚óØ Marketing Campaign Expansion</li>
                                    <li>‚óØ Community Airdrop Distribution</li>
                                </ul>
                            </div>
                        </div>
                        
                        <!-- Q1 2026 -->
                        <div style="position: relative; margin-bottom: 30px;">
                            <div style="position: absolute; left: -35px; top: 0; width: 20px; height: 20px; background: var(--accent); border-radius: 50%; border: 4px solid var(--background);"></div>
                            <div style="margin-left: 20px;">
                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                                    <h3 style="color: var(--text-primary); font-size: 18px;">Q1 2026</h3>
                                    <span style="background: rgba(118, 75, 162, 0.1); color: var(--accent); padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 600;">UPCOMING</span>
                                </div>
                                <ul style="color: var(--text-secondary); margin-left: 20px; font-size: 14px;">
                                    <li style="margin-bottom: 8px;">‚óé CEX Listings (Gate.io, KuCoin)</li>
                                    <li style="margin-bottom: 8px;">‚óé Staking Platform Launch</li>
                                    <li style="margin-bottom: 8px;">‚óé Mobile App Development</li>
                                    <li>‚óé Partnership Expansion</li>
                                </ul>
                            </div>
                        </div>
                        
                        <!-- Q2 2026 -->
                        <div style="position: relative;">
                            <div style="position: absolute; left: -35px; top: 0; width: 20px; height: 20px; background: rgba(255, 255, 255, 0.1); border-radius: 50%; border: 4px solid var(--background);"></div>
                            <div style="margin-left: 20px;">
                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                                    <h3 style="color: var(--text-primary); font-size: 18px;">Q2 2026</h3>
                                    <span style="background: rgba(255, 255, 255, 0.1); color: var(--text-secondary); padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 600;">FUTURE</span>
                                </div>
                                <ul style="color: var(--text-secondary); margin-left: 20px; font-size: 14px;">
                                    <li style="margin-bottom: 8px;">‚óé Cross-chain Integration</li>
                                    <li style="margin-bottom: 8px;">‚óé NFT Marketplace Development</li>
                                    <li style="margin-bottom: 8px;">‚óé DAO Governance Implementation</li>
                                    <li>‚óé Ecosystem Expansion</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- Partners Section -->
            <section id="partners" class="section">
                <div class="section-header">
                    <h2>Partners</h2>
                    <p>Trusted by industry leaders and innovators</p>
                </div>
                
                <div class="card">
                    <h3 style="color: var(--primary); margin-bottom: 25px; font-size: 22px; text-align: center;">Strategic Partnerships</h3>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
                        <div style="background: rgba(255, 255, 255, 0.05); border-radius: 16px; padding: 25px; text-align: center; border: 1px solid rgba(255, 255, 255, 0.1); transition: all 0.3s;" class="partner-card" data-url="https://ethereum.foundation/"> 
                            <div style="width: 70px; height: 70px; background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; font-size: 28px; color: white;">
                                <i class="fab fa-ethereum"></i>
                            </div>
                            <h4 style="color: var(--text-primary); margin-bottom: 10px; font-size: 16px;">Ethereum Foundation</h4>
                            <p style="color: var(--text-secondary); font-size: 13px;">Blockchain Infrastructure Partnership</p>
                        </div>
                        
                        <div style="background: rgba(255, 255, 255, 0.05); border-radius: 16px; padding: 25px; text-align: center; border: 1px solid rgba(255, 255, 255, 0.1); transition: all 0.3s;" class="partner-card" data-url="https://www.certik.com/"> 
                            <div style="width: 70px; height: 70px; background: linear-gradient(135deg, #00ff88, #00cc6a); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; font-size: 28px; color: white;">
                                <i class="fas fa-shield-alt"></i>
                            </div>
                            <h4 style="color: var(--text-primary); margin-bottom: 10px; font-size: 16px;">CertiK</h4>
                            <p style="color: var(--text-secondary); font-size: 13px;">Smart Contract Security Audit</p>
                        </div>
                        
                        <div style="background: rgba(255, 255, 255, 0.05); border-radius: 16px; padding: 25px; text-align: center; border: 1px solid rgba(255, 255, 255, 0.1); transition: all 0.3s;" class="partner-card" data-url="https://chain.link/"> 
                            <div style="width: 70px; height: 70px; background: linear-gradient(135deg, #ff6b6b, #ff4757); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; font-size: 28px; color: white;">
                                <i class="fas fa-chart-line"></i>
                            </div>
                            <h4 style="color: var(--text-primary); margin-bottom: 10px; font-size: 16px;">Chainlink</h4>
                            <p style="color: var(--text-secondary); font-size: 13px;">Oracle & Data Feeds</p>
                        </div>
                    </div>
                    
                    <div style="text-align: center;">
                        <h3 style="color: var(--primary); margin-bottom: 20px; font-size: 18px;">Exchange Partners</h3>
                        <div style="display: flex; flex-wrap: wrap; justify-content: center; gap: 15px;">
                            <div style="display: flex; flex-direction: column; align-items: center; gap: 10px; padding: 15px; background: rgba(255, 255, 255, 0.03); border-radius: 12px; min-width: 100px;">
                                <i class="fab fa-ethereum" style="font-size: 24px; color: var(--primary);"></i>
                                <span style="font-size: 13px; color: var(--text-secondary);">Uniswap</span>
                            </div>
                            <div style="display: flex; flex-direction: column; align-items: center; gap: 10px; padding: 15px; background: rgba(255, 255, 255, 0.03); border-radius: 12px; min-width: 100px;">
                                <i class="fas fa-exchange-alt" style="font-size: 24px; color: var(--primary);"></i>
                                <span style="font-size: 13px; color: var(--text-secondary);">PancakeSwap</span>
                            </div>
                            <div style="display: flex; flex-direction=column; align-items: center; gap: 10px; padding: 15px; background: rgba(255, 255, 255, 0.03); border-radius: 12px; min-width: 100px;">
                                <i class="fas fa-chart-line" style="font-size: 24px; color: var(--primary);"></i>
                                <span style="font-size: 13px; color: var(--text-secondary);">Gate.io</span>
                            </div>
                            <div style="display: flex; flex-direction=column; align-items: center; gap: 10px; padding: 15px; background: rgba(255, 255, 255, 0.03); border-radius: 12px; min-width: 100px;">
                                <i class="fas fa-coins" style="font-size: 24px; color: var(--primary);"></i>
                                <span style="font-size: 13px; color: var(--text-secondary);">KuCoin</span>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- Team Section -->
            <section id="team" class="section">
                <div class="section-header">
                    <h2>Our Team</h2>
                    <p>Experienced professionals driving innovation</p>
                </div>
                
                <div class="card">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 25px; margin-bottom: 30px;">
                        <div style="background: var(--card-bg); border-radius: 16px; padding: 25px; text-align: center; border: 1px solid rgba(255, 255, 255, 0.1);">
                            <div class="team-avatar"><img src="https://i.postimg.cc/kG563R0h/4cy-GZw-E-400x400.jpg" alt="Forrest Liu" loading="lazy" decoding="async"></div>
                            <h3 style="color: var(--primary); margin-bottom: 10px; font-size: 18px;">Forrest Liu</h3>
                            <p style="color: var(--text-secondary); margin-bottom: 15px; font-size: 14px;">CEO & Founder</p>
                            <p style="color: var(--text-secondary); font-size: 13px; margin-bottom: 20px;">10+ years in blockchain technology</p>
                            <div style="display: flex; justify-content: center; gap: 15px;">
                                <a href="#" style="color: var(--text-secondary); font-size: 16px;"><i class="fab fa-twitter"></i></a>
                                <a href="https://www.linkedin.com/in/forrestliu000" style="color: var(--text-secondary); font-size: 16px;"><i class="fab fa-linkedin"></i></a>
                                <a href="#" style="color: var(--text-secondary); font-size: 16px;"><i class="fab fa-github"></i></a>
                            </div>
                        </div>
                        
                        <div style="background: var(--card-bg); border-radius: 16px; padding: 25px; text-align: center; border: 1px solid rgba(255, 255, 255, 0.1);">
                            <div class="team-avatar"><img src="https://i.postimg.cc/zGkrW2bj/OHAo2Ob-L-400x400.jpg" alt="Mr White" loading="lazy" decoding="async"></div>
                            <h3 style="color: var(--primary); margin-bottom: 10px; font-size: 18px;">Mr White</h3>
                            <p style="color: var(--text-secondary); margin-bottom: 15px; font-size: 14px;">CTO</p>
                            <p style="color: var(--text-secondary); font-size: 13px; margin-bottom: 20px;">Blockchain developer & Ethereum expert</p>
                            <div style="display: flex; justify-content: center; gap: 15px;">
                                <a href="https://x.com/KJOLAB" style="color: var(--text-secondary); font-size: 16px;"><i class="fab fa-twitter"></i></a>
                                <a href="#" style="color: var(--text-secondary); font-size: 16px;"><i class="fab fa-linkedin"></i></a>
                                <a href="#" style="color: var(--text-secondary); font-size: 16px;"><i class="fab fa-github"></i></a>
                            </div>
                        </div>
                        
                        <div style="background: var(--card-bg); border-radius: 16px; padding: 25px; text-align: center; border: 1px solid rgba(255, 255, 255, 0.1);">
                            <div class="team-avatar"><img src="https://i.postimg.cc/rm6fQMtC/r-Ekl1ZRS-400x400.jpg" alt="Timur Kartashov" loading="lazy" decoding="async"></div>
                            <h3 style="color: var(--primary); margin-bottom: 10px; font-size: 18px;">Timur Kartashov</h3>
                            <p style="color: var(--text-secondary); margin-bottom: 15px; font-size: 14px;">Marketing Director</p>
                            <p style="color: var(--text-secondary); font-size: 13px; margin-bottom: 20px;">Crypto marketing specialist</p>
                            <div style="display: flex; justify-content: center; gap: 15px;">
                                <a href="https://x.com/kartashovio" style="color: var(--text-secondary); font-size: 16px;"><i class="fab fa-twitter"></i></a>
                                <a href="https://www.linkedin.com/in/kartashov-io" style="color: var(--text-secondary); font-size: 16px;"><i class="fab fa-linkedin"></i></a>
                                <a href="https://kartashov.io" style="color: var(--text-secondary); font-size: 16px;"><i class="fab fa-telegram"></i></a>
                            </div>
                        </div>
                    </div>
                    
                    <h3 style="color: var(--primary); margin-bottom: 20px; font-size: 18px;">Advisors</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div style="display: flex; align-items: center; gap: 15px; padding: 15px; background: rgba(255, 255, 255, 0.03); border-radius: 12px;">
                            <div style="width: 50px; height: 50px; background: linear-gradient(135deg, var(--secondary), var(--accent)); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white;">
                                <i class="fas fa-user-tie"></i>
                            </div>
                            <div>
                                <div style="font-weight: 600; color: var(--text-primary); font-size: 14px;">David Wilson</div>
                                <div style="color: var(--text-secondary); font-size: 12px;">Blockchain Investment Advisor</div>
                            </div>
                        </div>
                        
                        <div style="display: flex; align-items: center; gap: 15px; padding: 15px; background: rgba(255, 255, 255, 0.03); border-radius: 12px;">
                            <div style="width: 50px; height: 50px; background: linear-gradient(135deg, var(--primary), var(--primary-dark)); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white;">
                                <i class="fas fa-user-tie"></i>
                            </div>
                            <div>
                                <div style="font-weight: 600; color: var(--text-primary); font-size: 14px;">Lisa Rodriguez</div>
                                <div style="color: var(--text-secondary); font-size: 12px;">Legal & Compliance Expert</div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- Airdrop Section -->
            <section id="airdrop" class="section">
                <!--
                    Public hero/header (shown only before a user enters the dashboard).
                    When the wallet session is active and the dashboard is shown, we hide
                    this entire block to keep the logged-in UI clean.
                -->
                <div class="section-header" id="airdropHero">
                    <h2>Airdrop Program</h2>
                    <p>Claim your free OPN tokens and start earning through referrals</p>
                </div>
                
                <!-- Airdrop Dashboard Container -->
                <div id="airdropDashboard">
                    <div class="airdrop-container">
                        <div class="airdrop-grid">
                            
                            <!-- Left: Wallet Input Card -->
                            <div class="card" style="text-align: center; padding: 40px 20px;">
                                <p style="color: var(--text-secondary); max-width: 600px; margin: 0 auto 30px;">
                                    Enter your Ethereum wallet address to check eligibility, claim OPN tokens, and start earning through referrals.
                                </p>
                                
                                <!-- Wallet Input Form -->
                                <div class="input-group">
                                    <label for="airdropWalletAddress">Your Ethereum Wallet Address</label>
                                    <input 
                                        type="text" 
                                        id="airdropWalletAddress" 
                                        placeholder="0x..."
                                        value=""
                                    >
                                </div>
                                
                                <div class="input-group">
                                    <label for="airdropReferralCode">Referral Code (Optional)</label>
                                    <input 
                                        type="text" 
                                        id="airdropReferralCode" 
                                        placeholder="Enter a referral code to earn bonus tokens"
                                        value=""
                                    >
                                </div>
                                
                                <!-- ONLY CHECK ELIGIBILITY BUTTON - Claim button moved to dashboard -->
                                <button class="btn" id="checkEligibilityBtn" style="margin-bottom: 15px; background: linear-gradient(90deg, var(--secondary), var(--accent));">
                                    <i class="fas fa-check-circle"></i> Check Eligibility
                                </button>

                                <!-- Anti-multi-account warning -->
                                <div style="margin: 0 auto 18px; max-width: 520px; padding: 10px 12px; border-radius: 10px; background: rgba(255, 180, 0, 0.08); border: 1px solid rgba(255, 180, 0, 0.18); color: var(--text-secondary); font-size: 12.5px; line-height: 1.45; text-align: left;">
                                    <strong style="color: #ffcf5a; font-weight: 700;">Warning:</strong>
                                    Creating multiple accounts on the same device may result in a ban. Only
                                    <strong style="color: var(--text-primary);">1 account per device</strong>
                                    is eligible to withdraw.
                                </div>
                                
                                <div class="loading" id="airdropLoading" style="display: none;">
                                    <div class="spinner"></div>
                                    <div style="margin-top: 10px; color: var(--text-secondary);">Processing...</div>
                                </div>
                                
                                <div id="airdropStatus" style="margin-top: 20px; display: none;"></div>
                            </div>
                            
                            <!-- Right: Guide Card -->
                            <div class="card" style="background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1);">
                                <h3 style="color: var(--primary); margin-bottom: 25px; font-size: 22px; text-align: center;">
                                    <i class="fas fa-graduation-cap"></i> How Referrals Work
                                </h3>
                                
                                <!-- Referral Steps -->
                                <div style="display: flex; flex-direction: column; gap: 20px;">
                                    
                                    <!-- Step 1 -->
                                    <div style="display: flex; align-items: flex-start; gap: 15px; padding: 15px; background: rgba(0, 255, 136, 0.05); border-radius: 12px; border: 1px solid rgba(0, 255, 136, 0.1);">
                                        <div style="width: 32px; height: 32px; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; flex-shrink: 0;">
                                            1
                                        </div>
                                        <div>
                                            <h4 style="color: var(--primary); margin-bottom: 8px; font-size: 16px;">Earn 121 OPN per Referral</h4>
                                            <p style="color: var(--text-secondary); font-size: 14px; line-height: 1.5;">
                                                You earn 121 OPN for each friend who claims tokens using your referral
                                            </p>
                                        </div>
                                    </div>
                                    
                                    <!-- Step 2 -->
                                    <div style="display: flex; align-items: flex-start; gap: 15px; padding: 15px; background: rgba(102, 126, 234, 0.05); border-radius: 12px; border: 1px solid rgba(102, 126, 234, 0.1);">
                                        <div style="width: 32px; height: 32px; background: var(--secondary); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; flex-shrink: 0;">
                                            2
                                        </div>
                                        <div>
                                            <h4 style="color: var(--secondary); margin-bottom: 8px; font-size: 16px;">Link Clicks Don't Count</h4>
                                            <p style="color: var(--text-secondary); font-size: 14px; line-height: 1.5;">
                                                Only completed claims give you bonuses. Clicks without claims don't count.
                                            </p>
                                        </div>
                                    </div>
                                    
                                    <!-- Step 3 -->
                                    <div style="display: flex; align-items: flex-start; gap: 15px; padding: 15px; background: rgba(255, 170, 0, 0.05); border-radius: 12px; border: 1px solid rgba(255, 170, 0, 0.1);">
                                        <div style="width: 32px; height: 32px; background: var(--warning); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; flex-shrink: 0;">
                                            3
                                        </div>
                                        <div>
                                            <h4 style="color: var(--warning); margin-bottom: 8px; font-size: 16px;">Need 7+ Referrals to Withdraw</h4>
                                            <p style="color: var(--text-secondary); font-size: 14px; line-height: 1.5;">
                                                Minimum 7 referrals required for withdrawal access
                                            </p>
                                        </div>
                                    </div>
                                    
                                    <!-- Step 4 -->
                                    <div style="display: flex; align-items: flex-start; gap: 15px; padding: 15px; background: rgba(118, 75, 162, 0.05); border-radius: 12px; border: 1px solid rgba(118, 75, 162, 0.1);">
                                        <div style="width: 32px; height: 32px; background: var(--accent); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; flex-shrink: 0;">
                                            4
                                        </div>
                                        <div>
                                            <h4 style="color: var(--accent); margin-bottom: 8px; font-size: 16px;">Active Referrals Grow Your Network</h4>
                                            <p style="color: var(--text-secondary); font-size: 14px; line-height: 1.5;">
                                                Active referrals (with 2+ referrals themselves) help grow your network
                                            </p>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Info Note -->
                                <div style="margin-top: 25px; padding: 15px; background: rgba(255, 255, 255, 0.05); border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.1);">
                                    <div style="display: flex; align-items: center; gap: 12px;">
                                        <div style="color: var(--primary); font-size: 20px;">
                                            <i class="fas fa-info-circle"></i>
                                        </div>
                                        <div>
                                            <div style="font-weight: 600; color: var(--text-primary); font-size: 14px; margin-bottom: 5px;">Check Your Status</div>
                                            <div style="color: var(--text-secondary); font-size: 13px;">
                                                Enter your wallet address above to see your personalized airdrop status and referral dashboard
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                        </div>
                    </div>
                </div>
                
                <!-- Hidden Dashboard Container - Will be populated dynamically -->
                <div id="hiddenDashboardContainer" style="display: none;"></div>
            </section>
        </div>
    </div>
    
    <!-- Mobile Navigation -->
    <div class="mobile-nav">
        <button class="mobile-nav-btn active" data-section="presale">
            <i class="fas fa-fire"></i>
            <span>Presale</span>
        </button>
        <button class="mobile-nav-btn" data-section="tokenomics">
            <i class="fas fa-chart-pie"></i>
            <span>Tokenomics</span>
        </button>
        <button class="mobile-nav-btn" data-section="roadmap">
            <i class="fas fa-map"></i>
            <span>Roadmap</span>
        </button>
        <button class="mobile-nav-btn" data-section="airdrop">
            <i class="fas fa-gift"></i>
            <span>Airdrop</span>
        </button>
        <button class="mobile-nav-btn" onclick="window.location.href='/stake'" aria-label="Stake">
            <i class="fas fa-coins"></i>
            <span>Stake</span>
        </button>
    </div>
    
    <!-- Footer -->
<section class="disclosure-band" aria-label="Disclosures">
  <div class="disclosure-inner">
    <p>Binance is the first platform to announce the listing of the Opinion / OPN token, with trading starting at 2026-02-20 14:00 (UTC).</p>
    <p>Any claims to offer the token(s) for sale before the stated timeline are likely to be false advertising. Please do your own research to ensure safety of your funds. Always verify contract addresses and be cautious of phishing sites.</p>
  </div>
</section>

<footer class="site-footer">
  <div class="footer-inner">
    <div class="footer-col footer-brand">
      <div class="footer-logo">OPN</div>
      <div class="footer-status">
        <span class="status-dot" aria-hidden="true"></span>
        <span>All services are online</span>
      </div>
      <div class="footer-mini-links">
        <a href="/learn/privacy">Privacy</a>
        <span class="sep">|</span>
        <a href="/learn/terms">Terms</a>
        <span class="sep">|</span>
        <a href="https://docs.opinion.trade/" target="_blank" rel="noopener">Docs</a>
      </div>
    </div>

    <div class="footer-col">
      <div class="footer-title">Company</div>
      <nav class="footer-links" aria-label="Company">
        <a href="/learn/about">About us</a>
        <a href="/learn/team">Team</a>
        <a href="/learn/partners">Partners</a>
        <a href="/learn/contact">Contact</a>
      </nav>
    </div>

    <div class="footer-col">
      <div class="footer-title">Learn</div>
      <nav class="footer-links" aria-label="Learn">
        <a href="/learn">Learn hub</a>
        <a href="/learn/airdrop">Airdrop guide</a>
        <a href="/learn/presale">Presale guide</a>
        <a href="/learn/security">Security</a>
        <a href="/learn/faq">FAQs</a>
      </nav>
    </div>

    <div class="footer-col">
      <div class="footer-title">Resources</div>
      <nav class="footer-links" aria-label="Resources">
        <a href="/learn/how-it-works">How it works</a>
        <a href="/learn/referral-program">Referral program</a>
        <a href="/learn/withdrawals">Withdrawals</a>
        <a href="/learn/tokenomics">Tokenomics</a>
        <a href="/learn/roadmap">Roadmap</a>
      </nav>
    </div>

    <div class="footer-col footer-support">
      <div class="footer-title">Support</div>
      <div class="footer-support-line">
        <a href="https://t.me/opinion_labsxyz" target="_blank" rel="noopener noreferrer">Contact support</a>
      </div>
      <div class="footer-social" aria-label="Social links">
        <a href="https://twitter.com/opinionlabsxyz" aria-label="X"><i class="fab fa-twitter"></i></a>
        <a href="https://t.me/opinion_token" aria-label="Telegram"><i class="fab fa-telegram-plane"></i></a>
        <a href="https://discord.gg//opinionlabs" aria-label="Discord"><i class="fab fa-discord"></i></a>
        <a href="https://opinionlabs.medium.com/" aria-label="Medium"><i class="fab fa-medium"></i></a>
      </div>
    </div>
  </div>

  <div class="footer-bottom">
    <p class="footer-copy">¬© <span id="footerYear"></span> Opinion (OPN). All rights reserved.</p>
  </div>

  <script>
    (function(){
      var y = document.getElementById('footerYear');
      if (y) y.textContent = new Date().getFullYear();
    })();
  </script>
</footer>

<script>
        // Global Configuration
        const PRESALE_END_DATE = new Date('2026-02-20T23:59:59');
        const ETH_TO_APRO_RATE = 100000; // 1 ETH = 100000 OPN
        
        // Web3 Configuration
        // WalletConnect Cloud Project ID (can be injected from backend as wc_project_id)
        // Fallback set to the project's current ID so WalletConnect works out of the box.
        const WALLETCONNECT_PROJECT_ID = '19c07100fdc0c7dd7b1da5bd6508fecd';
        const SOL_PRESALE_WALLET = '{{ sol_presale_wallet|default("") }}';
        const SOL_RPC_URL = '{{ sol_rpc_url|default("") }}';
        const WEB3_CONFIG = {
            PRESALE_ADDRESS: '0xa84e6D0Fa3B35b18FF7C65568C711A85Ac1A9FC7',
            MIN_USD_AMOUNT: 50,
            PRICE_UPDATE_INTERVAL: 30000, // 30 seconds
            PRICES_API: '/api/prices',
            // Fallback only (should rarely be used; server caches to avoid 429)
            COINGECKO_API: 'https://api.coingecko.com/api/v3/simple/price?ids=ethereum,binancecoin,tether,solana&vs_currencies=usd',
            
            // Token configurations
            TOKENS: {
                ETH: {
                    name: 'Ethereum',
                    type: 'native',
                    network: 'ethereum',
                    decimals: 18,
                    contract: null
                },
                BNB: {
                    name: 'BNB',
                    type: 'native',
                    network: 'bsc',
                    decimals: 18,
                    contract: null
                },
                USDT_ERC20: {
                    name: 'USDT (ERC20)',
                    type: 'erc20',
                    network: 'ethereum',
                    decimals: 6,
                    contract: '0xdAC17F958D2ee523a2206206994597C13D831ec7' // Mainnet USDT
                },
                USDT_BEP20: {
                    name: 'USDT (BEP20)',
                    type: 'bep20',
                    network: 'bsc',
                    decimals: 18,
                    contract: '0x55d398326f99059fF775485246999027B3197955' // BSC USDT
                }
            },
            
            // Network configurations
            NETWORKS: {
                ethereum: {
                    chainId: '0x1', // Ethereum Mainnet
                    chainName: 'Ethereum Mainnet',
                    nativeCurrency: {
                        name: 'ETH',
                        symbol: 'ETH',
                        decimals: 18
                    },
                    rpcUrls: ['https://mainnet.infura.io/v3/'],
                    blockExplorerUrls: ['https://etherscan.io/']
                },
                bsc: {
                    chainId: '0x38', // BSC Mainnet (56 in decimal)
                    chainName: 'Binance Smart Chain',
                    nativeCurrency: {
                        name: 'BNB',
                        symbol: 'BNB',
                        decimals: 18
                    },
                    rpcUrls: ['https://bsc-dataseed.binance.org/'],
                    blockExplorerUrls: ['https://bscscan.com/']
                }
            }
        };

        // Global State
        let currentWallet = null;
        let currentSection = 'presale';
        let referralData = null;
        let currentReferralCount = 0;
        let currentUserData = null; // Store user data from backend
        let currentDashboardTab = 'overview'; // Track current dashboard tab
        
        // Web3 State
        // Convert a decimal string (e.g. \"12.34\") to integer units as BigInt (safe for token decimals)
        function decimalToUnits(amountStr, decimals) {
            const s = (amountStr ?? '').toString().trim();
            if (!s) return 0n;
            const neg = s.startsWith('-');
            const clean = neg ? s.slice(1) : s;
            const parts = clean.split('.');
            const whole = parts[0] || '0';
            const fracRaw = parts[1] || '';
            const frac = (fracRaw + '0'.repeat(decimals)).slice(0, decimals);
            const combined = (whole.replace(/^0+(?=\\d)/,'') || '0') + frac;
            const bi = BigInt(combined || '0');
            return neg ? -bi : bi;
        }

        let web3State = {
            prices: {
                ethereum: 3100,
                binancecoin: 580,
                tether: 1,
                solana: 150
            },
            selectedToken: null,
            userAddress: null,
            provider: null,
            currentNetwork: null
        };
        
        // ==================== DOM ELEMENT SAFETY FIXES ====================
        function getElementSafely(id) {
            const element = document.getElementById(id);
            if (!element) {
                console.warn(`Element with id "${id}" not found`);
                return null;
            }
            return element;
        }

        function setTextContentSafely(id, text) {
            const element = getElementSafely(id);
            if (element) {
                element.textContent = text;
            }
        }

        function updateElementSafely(id, callback) {
            const element = getElementSafely(id);
            if (element && typeof callback === 'function') {
                callback(element);
            }
        }
        
        // ==================== INITIALIZATION ====================

        // ==================== SIMPLE PERSISTENT LOGIN (WALLET SESSION) ====================
        // We keep users "logged in" across reloads by storing their wallet locally.
        // This is NOT custody/authentication ‚Äî it's just session persistence for the dashboard UI.
        const AUTH_STORAGE_KEY = 'apro_wallet';
        const TAB_STORAGE_KEY = 'apro_dashboard_tab';
        // Monotonic sequence used to prevent stale async requests from overwriting the sticky balance.
        let balanceSeq = 0;

        function saveWalletSession(wallet) {
            if (!wallet) return;
            try {
                localStorage.setItem(AUTH_STORAGE_KEY, wallet.trim().toLowerCase());
            } catch (e) {
                console.warn('Could not save wallet session:', e);
            }
        }

        function clearWalletSession() {
            try {
                localStorage.removeItem(AUTH_STORAGE_KEY);
                localStorage.removeItem(TAB_STORAGE_KEY);
            } catch (e) {
                console.warn('Could not clear wallet session:', e);
            }
        }

        async function restoreWalletSessionIfAny() {
            let wallet = '';
            try {
                wallet = (localStorage.getItem(AUTH_STORAGE_KEY) || '').trim().toLowerCase();
            } catch (e) {
                wallet = '';
            }
            if (!wallet || !validateWalletAddress(wallet)) return;

            // Prefill for transparency
            const walletInput = document.getElementById('airdropWalletAddress');
            if (walletInput) walletInput.value = wallet;

            showLoading(true);
            try {
                const response = await fetch('/api/check-wallet', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ wallet_address: wallet, referral_code: '' })
                });
                const data = await response.json();

                if (data && data.success && (data.eligible || data.already_claimed)) {
                    currentUserData = data;
                    if (data.already_claimed && data.claim_data) {
                        currentReferralCount = data.claim_data.referral_count || 0;
                    }
                    await loadHiddenDashboard(wallet, data);

                    // Restore last active dashboard tab
                    let savedTab = '';
                    try { savedTab = (localStorage.getItem(TAB_STORAGE_KEY) || '').trim(); } catch (e) {}
                    if (savedTab) {
                        setTimeout(() => {
                            const btn = document.querySelector(`.dashboard-tab[data-tab="${savedTab}"]`);
                            if (btn) btn.click();
                        }, 250);
                    }
                } else {
                    // Session no longer valid (or server rejected) ‚Äî clear it.
                    clearWalletSession();
                }
            } catch (err) {
                console.warn('Auto-restore session failed:', err);
            } finally {
                showLoading(false);
            }
        }
        

// ==================== PUSH NOTIFICATIONS (DIY Web Push) ====================
const PUSH_DISMISS_KEY = 'push_prompt_dismissed_until';

function urlBase64ToUint8Array(base64String) {
    const padding = '='.repeat((4 - base64String.length % 4) % 4);
    const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
    const rawData = window.atob(base64);
    const outputArray = new Uint8Array(rawData.length);
    for (let i = 0; i < rawData.length; ++i) {
        outputArray[i] = rawData.charCodeAt(i);
    }
    return outputArray;
}

async function getVapidPublicKey() {
    const resp = await fetch('/api/push/public-key', { credentials: 'same-origin' });
    const data = await resp.json().catch(() => ({}));
    if (!data || !data.ok || !data.publicKey) {
        throw new Error(data && data.error ? data.error : 'Failed to load VAPID public key');
    }
    return data.publicKey;
}

async function ensureServiceWorker() {
    if (!('serviceWorker' in navigator)) throw new Error('Service Worker not supported');
    return await navigator.serviceWorker.register('/static/sw.js');
}

async function subscribeToPush() {
    const reg = await ensureServiceWorker();
    const existing = await reg.pushManager.getSubscription();
    if (existing) {
        // Ensure backend knows about it
        await fetch('/api/push/subscribe', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(existing),
            credentials: 'same-origin'
        });
        return existing;
    }

    const publicKey = await getVapidPublicKey();
    const sub = await reg.pushManager.subscribe({
        userVisibleOnly: true,
        applicationServerKey: urlBase64ToUint8Array(publicKey)
    });

    await fetch('/api/push/subscribe', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(sub),
        credentials: 'same-origin'
    });

    return sub;
}

function shouldShowPushPrompt() {
    if (!('Notification' in window)) return false;
    if (Notification.permission !== 'default') return false;
    const until = parseInt(localStorage.getItem(PUSH_DISMISS_KEY) || '0', 10);
    return Date.now() > until;
}

function hidePushPrompt() {
    const el = document.getElementById('pushPrompt');
    if (el) el.classList.add('hidden');
}

function showPushPrompt() {
    const el = document.getElementById('pushPrompt');
    if (el) el.classList.remove('hidden');
}

function dismissPushPrompt(days = 7) {
    const ms = days * 24 * 60 * 60 * 1000;
    localStorage.setItem(PUSH_DISMISS_KEY, String(Date.now() + ms));
    hidePushPrompt();
}

function initPushNotifications() {
    // Delay so it doesn't feel like an instant permission nag.
    setTimeout(() => {
        if (!shouldShowPushPrompt()) return;

        showPushPrompt();

        const enableBtn = document.getElementById('pushEnableBtn');
        const dismissBtn = document.getElementById('pushDismissBtn');

        if (dismissBtn) {
            dismissBtn.addEventListener('click', () => dismissPushPrompt(7));
        }

        if (enableBtn) {
            enableBtn.addEventListener('click', async () => {
                try {
                    const perm = await Notification.requestPermission();
                    if (perm !== 'granted') {
                        dismissPushPrompt(14);
                        return;
                    }
                    await subscribeToPush();
                    hidePushPrompt();
                } catch (e) {
                    console.warn('Push enable failed:', e);
                    dismissPushPrompt(14);
                }
            });
        }
    }, 15000);
}

        
        // ==================== REFERRAL AUTOFILL (URL -> localStorage -> input) ====================
        const REF_STORAGE_KEY = 'apro_referral_code';

        function getReferralCodeFromUrl() {
            try {
                const url = new URL(window.location.href);
                const params = url.searchParams;

                let code =
                    params.get('ref') ||
                    params.get('referral') ||
                    params.get('r') ||
                    params.get('code');

                // Support /ref/CODE style links
                if (!code) {
                    const parts = url.pathname.split('/').filter(Boolean);
                    const i = parts.findIndex(p => (p || '').toLowerCase() === 'ref');
                    if (i !== -1 && parts[i + 1]) code = parts[i + 1];
                }

                // Support hash-based params (#ref=CODE or #/?ref=CODE)
                if (!code && url.hash) {
                    const h = url.hash.replace(/^#\/?/, '');
                    const hp = new URLSearchParams(h.includes('?') ? (h.split('?')[1] || '') : h);
                    code =
                        hp.get('ref') ||
                        hp.get('referral') ||
                        hp.get('r') ||
                        hp.get('code');
                }

                if (!code) return '';
                code = String(code).trim();

                // Light sanitization: keep it predictable + safe
                code = code.replace(/[^a-zA-Z0-9_-]/g, '').slice(0, 40);
                return code;
            } catch (e) {
                return '';
            }
        }

        function persistReferralCode(code) {
            if (!code) return;
            try { localStorage.setItem(REF_STORAGE_KEY, code); } catch (e) {}
        }

        function trackReferralClickOnce(code) {
            if (!code) return;
            const normalized = String(code).trim().toUpperCase();
            const clickKey = `apro_ref_click_tracked:${normalized}`;
            try {
                if (localStorage.getItem(clickKey) === '1') return;
                localStorage.setItem(clickKey, '1');
            } catch (e) {
                // If storage is blocked, still attempt to track once per page load.
            }

            fetch('/api/track-link-click', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ referral_code: normalized }),
                keepalive: true
            }).catch(() => {});
        }


        function readPersistedReferralCode() {
            try { return localStorage.getItem(REF_STORAGE_KEY) || ''; } catch (e) { return ''; }
        }

        function applyReferralCodeToAirdropInput(code) {
            const el = document.getElementById('airdropReferralCode');
            if (!el || !code) return;
            // Don‚Äôt overwrite if the user already typed something
            if (!el.value) el.value = code;
        }
document.addEventListener('DOMContentLoaded', function() {
            // Capture referral code BEFORE router updates the URL (router previously stripped ?ref=...)
            const detectedRefCode = getReferralCodeFromUrl();
            if (detectedRefCode) {
                persistReferralCode(detectedRefCode);
                trackReferralClickOnce(detectedRefCode);
                try { showToast(`Referral code "${detectedRefCode}" detected!`, 'info'); } catch (e) {}
            }
            // Enable real URL section routing (/, /roadmap, /team, /partners, /airdrop, etc.)
            // Presale remains the homepage at '/'
            initRouter();
            initNavigation();
            initTokenStatus();
            initPresaleCalculator();
            initTokenomicsChart();
            initPaymentTabs();
            // mwp_web3_active_on_load
            try {
                if (document.getElementById("web3Payment") && document.getElementById("web3Payment").classList.contains("active")) {
                    maybeShowMobileWalletBrowserPromptForWeb3Tab();
                }
            } catch (e) {}

            initPushNotifications();
            initWeb3Gateway();
            initPartnerCardLinks();
            initSupportWidget();
            
            // Initialize airdrop event listeners
            setTimeout(() => {
                document.getElementById('checkEligibilityBtn').addEventListener('click', checkAirdropEligibility);
                // Autofill referral code (from URL/localStorage)
                const storedRef = readPersistedReferralCode();
                if (storedRef) {
                    applyReferralCodeToAirdropInput(storedRef);
                }

                // Auto-restore dashboard if the user previously logged in
                restoreWalletSessionIfAny();
            }, 100);
        });
        
        // ==================== DASHBOARD TABS FUNCTIONS ====================

        // Always use the full wallet address even if we render a shortened one in the UI
        function getDashboardWalletAddress() {
            const el = document.getElementById('dashboardWalletAddress');
            if (!el) return '';
            return el.dataset.full || el.textContent || '';
        }

        // UI helper (renders a friendly short address like 0x1234...ABCD)
        function shortenWalletAddress(addr) {
            if (!addr || addr.length < 12) return addr || '';
            return `${addr.slice(0, 6)}...${addr.slice(-4)}`;
        }

        async function refreshStickyBalance(walletAddress) {
            walletAddress = (walletAddress || '').trim();
            if (!walletAddress || !validateWalletAddress(walletAddress)) return;

            const mySeq = ++balanceSeq;
            try {
                const resp = await fetch(`/api/balances?wallet=${encodeURIComponent(walletAddress)}`);
                const data = await resp.json().catch(() => ({}));
                if (mySeq !== balanceSeq) return; // stale
                if (!data || !data.success || !data.balances) return;

                const amt = Number(data.balances.display_total ?? data.balances.total_gross ?? 0);
                const balanceAmount = document.querySelector('.token-display-mini .token-amount');
                if (balanceAmount) {
                    balanceAmount.textContent = formatNumber(Math.floor(amt));
                }
            } catch (e) {
                // Best-effort only; do not disrupt dashboard.
                console.warn('refreshStickyBalance failed:', e);
            }
        }
        
        
        // --- Telegram CTA (mobile-friendly) ---
        const TELEGRAM_CHANNEL_URL = 'https://t.me/opinion_token';

        function openTelegram(source) {
            source = (source || 'unknown').toString();
            try {
                if (window.currentWalletAddress) {
                    fetch('/api/telegram-click', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            wallet: window.currentWalletAddress,
                            source: source,
                            device_type: (mwpIsMobile() ? 'mobile' : 'desktop'),
                            deep_link: TELEGRAM_CHANNEL_URL
                        })
                    }).catch(() => {});
                }
            } catch (e) {}

            // Prefer same-tab navigation on mobile to reduce context-switch friction.
            if (mwpIsMobile()) {
                window.location.href = TELEGRAM_CHANNEL_URL;
            } else {
                window.open(TELEGRAM_CHANNEL_URL, '_blank', 'noopener');
            }
        }

        // --- "Next best action" engine (read-only guidance) ---
        async function refreshNextAction(walletAddress) {
            try {
                const card = document.getElementById('nextActionCard');
                if (!card) return;

                walletAddress = (walletAddress || '').trim().toLowerCase();
                if (!walletAddress) {
                    card.style.display = 'none';
                    return;
                }

                const resp = await fetch(`/api/next-action?wallet=${encodeURIComponent(walletAddress)}`);
                const payload = await resp.json().catch(() => ({}));
                if (!payload || !payload.success || !payload.data) {
                    card.style.display = 'none';
                    return;
                }

                const d = payload.data;
                const titleEl = document.getElementById('nextActionTitle');
                const bodyEl = document.getElementById('nextActionBody');
                const btn = document.getElementById('nextActionBtn');

                if (titleEl) titleEl.textContent = d.title || 'Your next step';
                if (bodyEl) bodyEl.textContent = d.body || '';

                // Severity styling (subtle; keeps mobile layout stable)
                card.style.border = (d.severity === 'success')
                    ? '1px solid rgba(0,255,170,0.18)'
                    : (d.severity === 'warning')
                        ? '1px solid rgba(255,210,70,0.22)'
                        : '1px solid rgba(255,255,255,0.08)';

                if (btn) {
                    btn.textContent = d.cta_text || 'Continue';
                    btn.onclick = function () {
                        const target = (d.cta_target || 'overview').toString();
                        if (target === 'telegram') return openTelegram('next_action');
                        if (target === 'claim') {
                            const claimBtn = document.getElementById('dashboardClaimBtn');
                            if (claimBtn) return claimBtn.click();
                            return openDashboardTab('overview');
                        }
                        return openDashboardTab(target);
                    };
                }

                card.style.display = 'block';
            } catch (e) {
                // Fail closed (do not disturb layout)
                const card = document.getElementById('nextActionCard');
                if (card) card.style.display = 'none';
            }
        }

        function openDashboardTab(tabName) {
            tabName = (tabName || '').toString();
            const btn = document.querySelector(`.dashboard-tab[data-tab="${tabName}"]`);
            if (btn) btn.click();
        }

        // --- Activity feed (Phase 3) ---
        async function refreshActivity(walletAddress) {
            try {
                const card = document.getElementById('activityCard');
                const list = document.getElementById('activityList');
                const empty = document.getElementById('activityEmpty');
                if (!card || !list || !empty) return;

                walletAddress = (walletAddress || '').trim().toLowerCase();
                if (!walletAddress) {
                    card.style.display = 'none';
                    return;
                }

                const resp = await fetch(`/api/activity?wallet=${encodeURIComponent(walletAddress)}&limit=5`);
                const payload = await resp.json().catch(() => ({}));
                if (!payload || !payload.success || !payload.data) {
                    card.style.display = 'none';
                    return;
                }

                const rows = payload.data.activity || [];
                list.innerHTML = '';

                if (!rows.length) {
                    empty.style.display = 'block';
                    card.style.display = 'block';
                    return;
                }

                empty.style.display = 'none';
                rows.forEach(r => {
                    const when = r.created_at ? new Date(r.created_at) : null;
                    const whenText = when ? when.toLocaleString() : '';
                    const item = document.createElement('div');
                    item.style.padding = '10px 12px';
                    item.style.borderRadius = '12px';
                    item.style.border = '1px solid rgba(255,255,255,0.08)';
                    item.style.background = 'rgba(255,255,255,0.03)';
                    item.innerHTML = `
                        <div style="display:flex; gap:10px; align-items:flex-start; justify-content:space-between; flex-wrap:wrap;">
                            <div style="flex:1; min-width:200px; color:var(--text); font-size:13px; line-height:1.4;">${escapeHtml(r.message || '')}</div>
                            <div style="color:var(--text-secondary); font-size:11px; white-space:nowrap;">${escapeHtml(whenText)}</div>
                        </div>
                    `;
                    list.appendChild(item);
                });

                card.style.display = 'block';
            } catch (e) {
                const card = document.getElementById('activityCard');
                if (card) card.style.display = 'none';
            }
        }

        // --- Milestones (Phase 4) ---
        async function refreshMilestones(walletAddress) {
            try {
                const card = document.getElementById('milestonesCard');
                const list = document.getElementById('milestonesList');
                const empty = document.getElementById('milestonesEmpty');
                if (!card || !list || !empty) return;

                walletAddress = (walletAddress || '').trim().toLowerCase();
                if (!walletAddress) {
                    card.style.display = 'none';
                    return;
                }

                const resp = await fetch(`/api/milestones?wallet=${encodeURIComponent(walletAddress)}`);
                const payload = await resp.json().catch(() => ({}));
                if (!payload || !payload.success || !payload.data) {
                    card.style.display = 'none';
                    return;
                }

                const items = (payload.data.items || []);
                list.innerHTML = '';

                if (!items.length) {
                    empty.style.display = 'block';
                    card.style.display = 'block';
                    return;
                }

                empty.style.display = 'none';

                items.forEach(it => {
                    const pct = Math.max(0, Math.min(100, Number(it.pct || 0)));
                    const done = !!it.done;
                    const title = escapeHtml(it.title || 'Milestone');
                    const subtitle = escapeHtml(it.subtitle || '');
                    const current = Number(it.current || 0);
                    const target = Number(it.target || 0);

                    const row = document.createElement('div');
                    row.style.padding = '10px 12px';
                    row.style.borderRadius = '12px';
                    row.style.border = '1px solid rgba(255,255,255,0.08)';
                    row.style.background = 'rgba(255,255,255,0.03)';

                    row.innerHTML = `
                        <div style="display:flex; align-items:flex-start; justify-content:space-between; gap:10px; flex-wrap:wrap;">
                            <div style="flex:1; min-width:220px;">
                                <div style="display:flex; align-items:center; gap:8px; font-weight:800; font-size:13px; color:var(--text); line-height:1.3;">
                                    <span style="font-size:14px;">${done ? '‚úÖ' : 'üéØ'}</span>
                                    <span>${title}</span>
                                </div>
                                ${subtitle ? `<div style="margin-top:4px; color:var(--text-secondary); font-size:12px; line-height:1.35;">${subtitle}</div>` : ''}
                            </div>
                            <div style="color:var(--text-secondary); font-size:12px; white-space:nowrap;">${formatNumber(current)} / ${formatNumber(target)}</div>
                        </div>
                        <div style="margin-top:8px; height:10px; border-radius:999px; background: rgba(255,255,255,0.08); overflow:hidden;">
                            <div style="height:100%; width:${pct}%; background: var(--primary); opacity:0.35;"></div>
                        </div>
                    `;

                    list.appendChild(row);
                });

                card.style.display = 'block';
            } catch (e) {
                const card = document.getElementById('milestonesCard');
                if (card) card.style.display = 'none';
            }
        }

        function escapeHtml(str) {
            return String(str)
                .replaceAll('&', '&amp;')
                .replaceAll('<', '&lt;')
                .replaceAll('>', '&gt;')
                .replaceAll('"', '&quot;')
                .replaceAll("'", '&#039;');
        }
function initDashboardTabs() {
            // Setup tab switching
            document.querySelectorAll('.dashboard-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    // Remove active class from all tabs
                    document.querySelectorAll('.dashboard-tab, .dashboard-tab-content')
                        .forEach(el => el.classList.remove('active'));
                    
                    // Add active to clicked tab
                    this.classList.add('active');
                    
                    // Update current dashboard tab
                    currentDashboardTab = this.dataset.tab;

                    // Persist last active tab for reloads
                    try { localStorage.setItem(TAB_STORAGE_KEY, currentDashboardTab); } catch (e) {}
                    
                    // Show corresponding content
                    document.getElementById(`${currentDashboardTab}Tab`).classList.add('active');
                    
                    // Update floating share button visibility
                    updateShareButtonVisibility();
                    
                    // Load specific tab data if needed
                    loadTabData(currentDashboardTab);
                });
            });
            
            // Initialize share button
            const shareBtn = document.getElementById('dashboardShareBtn');
            if (shareBtn) {
                shareBtn.addEventListener('click', function() {
                    shareReferralLink();
                });
            }
            
            // Initialize back button
            const backBtn = document.getElementById('dashboardBackBtn');
            if (backBtn) {
                backBtn.addEventListener('click', function () {
    const ok = confirm('Are you sure you want to log out? Your progress will not be lost.');
    if (ok) {
        showInitialForm();
    }
});
            }
            
            // Initialize copy wallet button
            const copyWalletBtn = document.getElementById('copyWalletBtn');
            if (copyWalletBtn) {
                copyWalletBtn.addEventListener('click', copyDashboardWalletAddress);
            }
            
            // Set initial share button visibility
            updateShareButtonVisibility();
        }
        
        function updateShareButtonVisibility() {
            const shareBtn = document.getElementById('dashboardShareBtn');
            if (shareBtn) {
                // Show share button only on referral and overview tabs
                if (currentDashboardTab === 'referral' || currentDashboardTab === 'overview') {
                    shareBtn.style.display = 'flex';
                } else {
                    shareBtn.style.display = 'none';
                }
            }
        }
        
        function loadTabData(tabId) {
            const walletAddress = getDashboardWalletAddress();
            
            if (!walletAddress || !validateWalletAddress(walletAddress)) {
                return;
            }

            // Always keep the sticky balance uniform across all dashboard subsections
            refreshStickyBalance(walletAddress);
            
            switch(tabId) {
                case 'overview':
                    // Overview data is loaded when dashboard is created
                    initClaimWindowBonus(walletAddress);
                    refreshActivity(walletAddress);
                    refreshMilestones(walletAddress);
                    break;
                    
                case 'referral':
                    loadReferralStats(walletAddress);
                    break;
                    
                case 'achievements':
                    loadAchievements(walletAddress);
                    break;
                    
                case 'tasks':
                    loadTasks(walletAddress);
                    break;
                    
                case 'network':
                    loadNetworkAnalysis(walletAddress);
                    break;
                    
                case 'leaderboard':
                    loadLeaderboard();
                    break;
                    
                case 'withdrawals':
                    checkWithdrawalProgress();
                    break;
            }
        }
        
        // ==================== SHARE REFERRAL LINK FUNCTION ====================
        
        function shareReferralLink() {
            const code = getReferralCode();
            const link = getReferralLink(code);
            
            // Show share options
            if (navigator.share) {
                // Use Web Share API if available
                navigator.share({
                    title: 'Claim FREE OPN Airdrop Tokens!',
                    text: `Claim your FREE OPN airdrop tokens! Use my referral code ${code} for bonus tokens!`,
                    url: link
                }).then(() => {
                    showToast('Shared successfully!', 'success');
                }).catch(err => {
                    console.log('Error sharing:', err);
                    copyToClipboard(link);
                });
            } else {
                // Fallback to copying to clipboard
                copyToClipboard(link);
            }
        }
        
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showToast('Referral link copied to clipboard!', 'success');
            });
        }
        
        // ==================== DASHBOARD TOGGLE FUNCTIONS ====================

        function setAirdropHeroVisible(isVisible) {
            const hero = document.getElementById('airdropHero');
            if (!hero) return;
            hero.style.display = isVisible ? '' : 'none';
        }
        
        function showDashboardView() {
            // Logged-in (dashboard) view: remove the public hero/header
            setAirdropHeroVisible(false);
            // Hide the initial form
            document.getElementById('airdropDashboard').style.display = 'none';
            // Show the dashboard container
            document.getElementById('hiddenDashboardContainer').style.display = 'block';
            // Initialize dashboard tabs
            setTimeout(initDashboardTabs, 100);
        }
        function handleLogoutClick() {
            const msg = "Log out? Your progress won\'t be lost. You can log back in anytime.";
            if (window.confirm(msg)) {
                showInitialForm();
            }
        }


        // Generic clipboard helper with custom success message
        function copyTextToClipboard(text, successMessage = 'Copied to clipboard!') {
            if (!text) return;
            const doToast = (msg, type='success') => {
                try { showToast(msg, type); } catch(e) {}
            };
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(text).then(() => {
                    doToast(successMessage, 'success');
                }).catch(() => {
                    fallbackCopy(text, successMessage);
                });
            } else {
                fallbackCopy(text, successMessage);
            }

            function fallbackCopy(t, msg) {
                const ta = document.createElement('textarea');
                ta.value = t;
                ta.style.position = 'fixed';
                ta.style.left = '-9999px';
                ta.style.top = '-9999px';
                document.body.appendChild(ta);
                ta.focus();
                ta.select();
                try {
                    document.execCommand('copy');
                    doToast(msg, 'success');
                } catch (err) {
                    doToast('Copy failed. Please copy manually.', 'error');
                }
                document.body.removeChild(ta);
            }
        }

        // Make partner cards open their websites
        function initPartnerCardLinks() {
            document.querySelectorAll('.partner-card').forEach(card => {
                // Don't double-bind
                if (card.dataset.bound === '1') return;
                card.dataset.bound = '1';
                card.addEventListener('click', () => {
                    const url = card.dataset.url;
                    if (!url) return;
                    window.open(url, '_blank', 'noopener');
                });
            });
        }

        // Floating Telegram support widget (button always visible; bubble shows once per 24h)
        function initSupportWidget() {
            const fab = document.getElementById('supportFab');
            const bubble = document.getElementById('supportBubble');
            const closeBtn = document.getElementById('supportBubbleClose');
            if (!fab || !bubble) return;

            const TELEGRAM_URL = 'https://t.me/opinion_labsxyz';
            const DISMISS_KEY = 'supportBubbleDismissedAt';
            const DAY_MS = 24 * 60 * 60 * 1000;

            const openSupport = () => window.open(TELEGRAM_URL, '_blank', 'noopener');

            fab.addEventListener('click', openSupport);
            bubble.addEventListener('click', openSupport);

            if (closeBtn) {
                closeBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    bubble.classList.remove('show');
                    try { localStorage.setItem(DISMISS_KEY, String(Date.now())); } catch (err) {}
                });
            }

            // Show bubble if not dismissed in the last 24h
            let lastDismiss = 0;
            try { lastDismiss = parseInt(localStorage.getItem(DISMISS_KEY) || '0', 10) || 0; } catch (err) {}
            const shouldShow = (Date.now() - lastDismiss) > DAY_MS;

            if (shouldShow) {
                setTimeout(() => {
                    bubble.classList.add('show');
                }, 5000);
            }
        }
        function showInitialForm() {
            // Clear persisted "login" so the Logout button ends the session
            clearWalletSession();
            // Invalidate any in-flight balance requests so stale async responses can't overwrite UI after logout
            try { balanceSeq++; } catch (e) {}
            // Logged-out (initial) view: restore the public hero/header
            setAirdropHeroVisible(true);
            // Show the initial form
            document.getElementById('airdropDashboard').style.display = 'block';
            // Hide the dashboard container
            document.getElementById('hiddenDashboardContainer').style.display = 'none';
            // Reset form fields
            document.getElementById('airdropWalletAddress').value = '';
            document.getElementById('airdropReferralCode').value = '';
            document.getElementById('airdropStatus').style.display = 'none';
            document.getElementById('airdropStatus').innerHTML = '';
        }
        
        
        // ==================== MOBILE WALLET-BROWSER PROMPT (WEB3 TAB ONLY) ====================

        const MWP_STORAGE_KEY = "mwp_web3_tab_dismissed_at";
        const MWP_COOLDOWN_DAYS = 7;

        function mwpIsMobile() {
            const ua = navigator.userAgent || "";
            // Includes iPadOS Safari (reports Macintosh) fallback via touch points
            return /Android|iPhone|iPad|iPod/i.test(ua) || (navigator.maxTouchPoints > 1 && /Macintosh/i.test(ua));
        }

        function mwpHasInjectedProvider() {
            return !!(window.ethereum || (window.phantom && window.phantom.solana));
        }

        function mwpInWalletBrowserHeuristic() {
            const ua = (navigator.userAgent || "").toLowerCase();
            if (ua.includes("metamask") || ua.includes("trustwallet") || ua.includes("phantom")) return true;
            if (window.ethereum && window.ethereum.isMetaMask) return true;
            if (window.phantom && window.phantom.solana && window.phantom.solana.isPhantom) return true;
            // If provider exists, user can usually connect ‚Äî don't nag.
            if (mwpHasInjectedProvider()) return true;
            return false;
        }

        function mwpDismissedRecently() {
            const ts = Number(localStorage.getItem(MWP_STORAGE_KEY) || "0");
            if (!ts) return false;
            const ageMs = Date.now() - ts;
            return ageMs < MWP_COOLDOWN_DAYS * 24 * 60 * 60 * 1000;
        }

        function maybeShowMobileWalletBrowserPromptForWeb3Tab() {
            // Strict: only mobile, only if not already in wallet browser, only if not recently dismissed
            if (!mwpIsMobile()) return;
            if (mwpInWalletBrowserHeuristic()) return;
            if (mwpDismissedRecently()) return;

            // Avoid duplicates
            if (document.getElementById("mwp-root")) return;

            const currentUrl = window.location.href;
            const encodedUrl = encodeURIComponent(currentUrl);

            // Deep links (easy to update later)
            const metamaskUrl =
                `https://metamask.app.link/dapp/${window.location.host}${window.location.pathname}${window.location.search}${window.location.hash}`;
            const trustUrl =
                `https://link.trustwallet.com/open_url?url=${encodedUrl}`;

            const root = document.createElement("div");
            root.id = "mwp-root";
            root.innerHTML = `
                <div class="mwp-backdrop" role="presentation"></div>
                <div class="mwp-sheet" role="dialog" aria-modal="true" aria-label="Wallet Browser Prompt">
                    <div class="mwp-head">
                        <div class="mwp-title">Better wallet connection on mobile</div>
                        <button class="mwp-x" type="button" aria-label="Close">√ó</button>
                    </div>
                    <div class="mwp-body">
                        To connect and pay smoothly, open this site inside your wallet‚Äôs built-in browser (MetaMask, Trust Wallet, or any wallet with a browser).
                        <div class="mwp-sub">This prevents connection issues in regular mobile browsers.</div>
                    </div>
                    <div class="mwp-actions">
                        <a class="mwp-btn primary" href="${metamaskUrl}" rel="noreferrer noopener">Open in MetaMask</a>
                        <a class="mwp-btn primary" href="${trustUrl}" rel="noreferrer noopener">Open in Trust Wallet</a>

                        <div class="mwp-copy-group">
                            <button class="mwp-btn ghost" type="button" data-mwp-copy>Copy link</button>
                            <div class="mwp-copy-hint">Paste inside your wallet browser</div>
                        </div>

                        <button class="mwp-btn ghost" type="button" data-mwp-continue>Continue in this browser</button>
                    </div>
                    <div class="mwp-foot">
                        <button class="mwp-link" type="button" data-mwp-dontshow>Don‚Äôt show again (7 days)</button>
                    </div>
                </div>
            `;
            document.body.appendChild(root);

            function close(saveCooldown) {
                if (saveCooldown) localStorage.setItem(MWP_STORAGE_KEY, String(Date.now()));
                root.remove();
            }

            root.querySelector(".mwp-backdrop").addEventListener("click", () => close(false));
            root.querySelector(".mwp-x").addEventListener("click", () => close(false));
            root.querySelector("[data-mwp-continue]").addEventListener("click", () => close(false));
            root.querySelector("[data-mwp-dontshow]").addEventListener("click", () => close(true));

            const copyBtn = root.querySelector("[data-mwp-copy]");
            copyBtn.addEventListener("click", async () => {
                try {
                    await navigator.clipboard.writeText(window.location.href);
                    copyBtn.textContent = "Copied!";
                    setTimeout(() => { copyBtn.textContent = "Copy link"; }, 1500);
                } catch (e) {
                    // Fallback
                    const input = document.createElement("input");
                    input.value = window.location.href;
                    document.body.appendChild(input);
                    input.select();
                    document.execCommand("copy");
                    document.body.removeChild(input);

                    copyBtn.textContent = "Copied!";
                    setTimeout(() => { copyBtn.textContent = "Copy link"; }, 1500);
                }
            });
        }

// ==================== PAYMENT TABS ====================
        
        function initPaymentTabs() {
            const tabs = document.querySelectorAll('.payment-tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    // Remove active class from all tabs
                    tabs.forEach(t => t.classList.remove('active'));
                    
                    // Add active class to clicked tab
                    this.classList.add('active');
                    
                    // Hide all payment content
                    document.querySelectorAll('.payment-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    
                    // Show selected payment content
                    const tabId = this.getAttribute('data-tab');
                    document.getElementById(`${tabId}Payment`).classList.add('active');
                    
                    // If switching to Web3 tab, check MetaMask
                    if (tabId === 'web3') {
                        checkMetaMaskAvailability();
                        maybeShowMobileWalletBrowserPromptForWeb3Tab();
                    }
                });
            });
        }
        
        // ==================== SIMPLIFIED PRESALE FUNCTION ====================
        
        function showPresaleInstructions() {
            const ethAmount = parseFloat(document.getElementById('ethAmount').value) || 0;
            
            if (ethAmount < 0.1) {
                showToast('Minimum contribution is 0.1 ETH', 'error');
                return;
            }
            
            // Calculate tokens with bonus
            const baseTokens = ethAmount * ETH_TO_APRO_RATE;
            let bonusPercentage = 0;
            if (ethAmount >= 5) bonusPercentage = 0.30;
            else if (ethAmount >= 1) bonusPercentage = 0.25;
            else if (ethAmount >= 0.1) bonusPercentage = 0.20;
            
            const totalTokens = baseTokens + (baseTokens * bonusPercentage);
            
            const presaleAddress = '0xa84e6D0Fa3B35b18FF7C65568C711A85Ac1A9FC7';
            
            // Show instructions
            const instructionsDiv = document.getElementById('manualInstructions');
            instructionsDiv.style.display = 'block';
            
            showToast(`
                <strong>Presale Contribution Instructions:</strong><br><br>
                1. Send <strong>${ethAmount} ETH</strong> to the address above<br>
                2. From your personal wallet (not exchange)<br><br>
                3. You will receive: <strong>${formatNumber(totalTokens)} OPN tokens</strong><br>
                (Base: ${formatNumber(baseTokens)} + Bonus: ${formatNumber(baseTokens * bonusPercentage)})
            `, 'info', 15000);
        }
        
        // ==================== WEB3 PAYMENT GATEWAY ====================
        
        function initWeb3Gateway() {
            // Setup event listeners for Web3 gateway
            const usdInput = document.getElementById('web3UsdAmount');
            const connectBtn = document.getElementById('web3ConnectWallet');
            const payBtn = document.getElementById('web3PayBtn');

            // mwp_web3_token_gate: Require token selection before allowing Connect Wallet
            if (connectBtn) {
                const hasToken = !!(window.web3State && web3State.selectedToken);
                if (!hasToken) {
                    connectBtn.disabled = true;
                    connectBtn.title = 'Select a crypto first';
                    connectBtn.innerHTML = '<i class="fas fa-hand-pointer"></i> Select crypto first';
                }
            }

            
            if (usdInput) {
                usdInput.addEventListener('input', handleWeb3UsdInput);
            }
            
	            if (connectBtn) {
	                // Open wallet selection modal (Browser wallet vs WalletConnect).
	                // Calling connectWeb3Wallet() directly here breaks when no mode is passed.
	                connectBtn.addEventListener('click', openWalletModal);
	            }
            
            if (payBtn) {
                payBtn.addEventListener('click', processWeb3Payment);
            }
            
            // Load prices initially
            fetchWeb3Prices();
            
            // Update prices periodically
            setInterval(fetchWeb3Prices, WEB3_CONFIG.PRICE_UPDATE_INTERVAL);
            
            // Check MetaMask availability
            checkMetaMaskAvailability();
        }
        
	        function checkMetaMaskAvailability() {
	            // Do NOT reference a global `mode` here (it may not exist).
	            // We simply detect whether an injected provider is present.
	            if (!window.ethereum) {
	                // Keep the main connect button enabled so users can still pick WalletConnect.
	                const injectedBtn = document.querySelector('button[onclick="connectInjectedWallet()"]');
	                if (injectedBtn) {
	                    injectedBtn.disabled = true;
	                    injectedBtn.style.opacity = '0.6';
	                    injectedBtn.title = 'No browser wallet detected';
	                }
	            }
	        }
        
        function isMetaMaskInstalled() {
            return typeof window.ethereum !== 'undefined';
        }
        
        async function fetchWeb3Prices() {
            // Prefer server-side cached prices to avoid CoinGecko 429 on clients.
            try {
                const resp = await fetch(WEB3_CONFIG.PRICES_API, { cache: 'no-store' });
                if (!resp.ok) throw new Error(`Prices API error: ${resp.status}`);
                const payload = await resp.json();
                if (payload?.success && payload?.prices) {
                    const p = payload.prices;
                    web3State.prices = {
                        ethereum: p.ethereum ?? web3State.prices.ethereum,
                        binancecoin: p.binancecoin ?? web3State.prices.binancecoin,
                        tether: p.tether ?? 1,
                        solana: p.solana ?? web3State.prices.solana
                    };
                    updateWeb3Conversions();
                    return;
                }
                throw new Error(payload?.error || 'Prices API returned no prices');
            } catch (error) {
                // Fallback (best-effort) ‚Äî rate limits may apply.
                console.warn('Failed to fetch server prices, falling back to CoinGecko:', error);
                try {
                    const response = await fetch(WEB3_CONFIG.COINGECKO_API);
                    if (!response.ok) throw new Error(`CoinGecko error: ${response.status}`);
                    const data = await response.json();
                    if (data) {
                        web3State.prices = {
                            ethereum: data.ethereum?.usd || web3State.prices.ethereum,
                            binancecoin: data.binancecoin?.usd || web3State.prices.binancecoin,
                            tether: data.tether?.usd || 1,
                            solana: data.solana?.usd || web3State.prices.solana
                        };
                        updateWeb3Conversions();
                    }
                } catch (e2) {
                    console.warn('Failed to fetch CoinGecko prices, using defaults:', e2);
                }
            }
        }
        
        function handleWeb3UsdInput() {
            const usdAmount = parseFloat(document.getElementById('web3UsdAmount').value) || 0;
            const minAmountNote = document.getElementById('web3MinAmountNote');
            
            // Validate minimum amount
            if (usdAmount < WEB3_CONFIG.MIN_USD_AMOUNT) {
                minAmountNote.style.display = 'block';
                document.getElementById('web3PayBtn').disabled = true;
            } else {
                minAmountNote.style.display = 'none';
                if (web3State.selectedToken && web3State.userAddress) {
                    document.getElementById('web3PayBtn').disabled = false;
                }
            }
            
            updateWeb3Conversions();
        }
        
        function updateWeb3Conversions() {
            const usdAmount = parseFloat(document.getElementById('web3UsdAmount').value) || 0;
            
            // Calculate conversions
            const ethAmount = usdAmount / web3State.prices.ethereum;
            const bnbAmount = usdAmount / web3State.prices.binancecoin;
            const usdtAmount = usdAmount; // USDT is pegged to $1
            
            // Update conversion display
            document.getElementById('web3EthAmount').textContent = ethAmount.toFixed(6);
            document.getElementById('web3BnbAmount').textContent = bnbAmount.toFixed(6);
            document.getElementById('web3UsdtErcAmount').textContent = usdtAmount.toFixed(2);
            document.getElementById('web3UsdtBepAmount').textContent = usdtAmount.toFixed(2);
            
            // Update button texts
            document.getElementById('web3EthText').textContent = ethAmount.toFixed(6);
            document.getElementById('web3BnbText').textContent = bnbAmount.toFixed(6);
            document.getElementById('web3UsdtErcText').textContent = usdtAmount.toFixed(2);
            document.getElementById('web3UsdtBepText').textContent = usdtAmount.toFixed(2);
        }
        
        function selectWeb3Token(button) {
            // Remove selection from all buttons
            document.querySelectorAll('.web3-payment-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            // Add selection to clicked button
            button.classList.add('selected');
            
            // Update selected token
            web3State.selectedToken = button.dataset.token;

            // Enable Connect Wallet now that a token is selected
            const connectBtn = document.getElementById('web3ConnectWallet');
            if (connectBtn && !web3State.userAddress) {
                connectBtn.disabled = false;
                connectBtn.title = '';
                const tokenLabel = (button.dataset.token || '').replace('_', ' ');
                connectBtn.innerHTML = `<i class="fas fa-plug"></i> Connect Wallet`;
            }

            
            // Update network info
            const network = button.dataset.network;
            const networkName = network === 'ethereum' ? 'Ethereum Mainnet' : 'Binance Smart Chain';
            const networkClass = network === 'ethereum' ? 'network-ethereum' : 'network-bsc';
            
            document.getElementById('web3NetworkInfo').innerHTML = 
                `<span class="network-indicator ${networkClass}">${networkName}</span>`;
            
            // Enable pay button if wallet is connected
            const usdAmount = parseFloat(document.getElementById('web3UsdAmount').value) || 0;
            if (web3State.userAddress && usdAmount >= WEB3_CONFIG.MIN_USD_AMOUNT) {
                document.getElementById('web3PayBtn').disabled = false;
            }
        }
        
        
        async function getEvmProvider(mode){
            if (mode === 'walletconnect'){
                if (!WALLETCONNECT_PROJECT_ID) throw new Error('WalletConnect Project ID not configured');
                // WalletConnect Ethereum Provider (v2)
                const WC = window.EthereumProvider || (window.WalletConnectEthereumProvider && (window.WalletConnectEthereumProvider.default || window.WalletConnectEthereumProvider));
                if (!WC) throw new Error('WalletConnect provider not available');
                const provider = await WC.init({
                    projectId: WALLETCONNECT_PROJECT_ID,
                    chains: [1, 56],
                    showQrModal: true,
                    optionalChains: [1,56]
                });
                await provider.connect();
                return provider;
            }
            // injected fallback
            if (!window.ethereum) throw new Error('No injected wallet found');
            return window.ethereum;
        }

    function openWalletModal(){ document.getElementById('walletConnectModal').classList.remove('hidden'); document.getElementById('walletConnectHint').textContent = WALLETCONNECT_PROJECT_ID ? '' : 'WalletConnect Project ID not configured yet.'; }
        function closeWalletModal(){ document.getElementById('walletConnectModal').classList.add('hidden'); }

        async function connectInjectedWallet(){ closeWalletModal(); return connectWeb3Wallet('injected'); }
        async function connectWithWalletConnect(){ closeWalletModal(); return connectWeb3Wallet('walletconnect'); }

        async function connectWeb3Wallet(mode) {
            if (mode === 'injected' && !window.ethereum) {
                showWeb3Status('No browser wallet detected. Use WalletConnect or install MetaMask/Trust.', 'error');
                return;
            }

            try {
                showWeb3Status('Connecting wallet...', 'pending');
                
                // Request account access
                const provider = await getEvmProvider(mode);
            web3State.provider = provider;
            const accounts = await provider.request({
                    method: 'eth_requestAccounts'
                });
                
                web3State.userAddress = accounts[0];
                web3State.provider = provider;
                
                // Update UI
                document.getElementById('web3WalletAddress').textContent = 
                    `${web3State.userAddress.substring(0, 6)}...${web3State.userAddress.substring(38)}`;
                
                const connectBtn = document.getElementById('web3ConnectWallet');
                connectBtn.innerHTML = '<i class="fas fa-check"></i> Connected';
                connectBtn.disabled = true;
                
                showWeb3Status('Wallet connected successfully!', 'success');
                
                // Get current network
                await updateWeb3CurrentNetwork();
                
                // Listen for account changes
                window.ethereum.on('accountsChanged', handleWeb3AccountsChanged);
                window.ethereum.on('chainChanged', handleWeb3ChainChanged);
                
                // Enable pay button if token is selected
                const usdAmount = parseFloat(document.getElementById('web3UsdAmount').value) || 0;
                if (web3State.selectedToken && usdAmount >= WEB3_CONFIG.MIN_USD_AMOUNT) {
                    document.getElementById('web3PayBtn').disabled = false;
                }
                
            } catch (error) {
                console.error('Error connecting wallet:', error);
                showWeb3Status(error.message || 'Failed to connect wallet', 'error');
            }
        }
        
        async function updateWeb3CurrentNetwork() {
            const chainId = await web3State.provider.request({ method: 'eth_chainId' });
            web3State.currentNetwork = chainId;
            
            // Update network display
            let networkName = 'Unknown Network';
            let networkClass = '';
            if (chainId === '0x1') {
                networkName = 'Ethereum Mainnet';
                networkClass = 'network-ethereum';
            } else if (chainId === '0x38') {
                networkName = 'Binance Smart Chain';
                networkClass = 'network-bsc';
            }
            
            document.getElementById('web3NetworkInfo').innerHTML = 
                `<span class="network-indicator ${networkClass}">${networkName}</span>`;
        }
        
        function handleWeb3AccountsChanged(accounts) {
            if (accounts.length === 0) {
                // User disconnected wallet
                web3State.userAddress = null;
                document.getElementById('web3WalletAddress').textContent = 'Not connected';
                const connectBtn = document.getElementById('web3ConnectWallet');
                connectBtn.innerHTML = '<i class="fas fa-plug"></i> Connect Wallet';
                // Keep Connect disabled until user selects a crypto
                if (!web3State.selectedToken) {
                    connectBtn.disabled = true;
                    connectBtn.title = 'Select a crypto first';
                    connectBtn.innerHTML = '<i class="fas fa-hand-pointer"></i> Select crypto first';
                } else {
                    connectBtn.disabled = false;
                    connectBtn.title = '';
                }
                document.getElementById('web3PayBtn').disabled = true;
                document.getElementById('web3NetworkInfo').innerHTML = '';
                showWeb3Status('Wallet disconnected', 'error');
            } else {
                // User switched accounts
                web3State.userAddress = accounts[0];
                document.getElementById('web3WalletAddress').textContent = 
                    `${web3State.userAddress.substring(0, 6)}...${web3State.userAddress.substring(38)}`;
            }
        }
        
        function handleWeb3ChainChanged(chainId) {
            web3State.currentNetwork = chainId;
            updateWeb3CurrentNetwork();
        }
        
        async function switchWeb3Network(targetNetwork) {
            const networkConfig = WEB3_CONFIG.NETWORKS[targetNetwork];
            
            try {
                await web3State.provider.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: networkConfig.chainId }],
                });
                return true;
            } catch (error) {
                if (error.code === 4902) {
                    // Network not added, try to add it
                    try {
                        await web3State.provider.request({
                            method: 'wallet_addEthereumChain',
                            params: [networkConfig],
                        });
                        return true;
                    } catch (addError) {
                        showWeb3Status(`Failed to add ${networkConfig.chainName}`, 'error');
                        return false;
                    }
                }
                showWeb3Status(`Failed to switch to ${networkConfig.chainName}`, 'error');
                return false;
            }
        }
        
        async function processWeb3Payment() {
            if (!web3State.userAddress) {
                showWeb3Status('Please connect your wallet first', 'error');
                return;
            }

            if (!web3State.selectedToken) {
                showWeb3Status('Please select a payment method', 'error');
                return;
            }

            const usdAmount = parseFloat(document.getElementById('web3UsdAmount').value) || 0;
            if (usdAmount < WEB3_CONFIG.MIN_USD_AMOUNT) {
                showWeb3Status(`Minimum amount is $${WEB3_CONFIG.MIN_USD_AMOUNT}`, 'error');
                return;
            }

            try {
                showWeb3Status('Preparing transaction...', 'pending');
                
                const tokenConfig = WEB3_CONFIG.TOKENS[web3State.selectedToken];
                const targetNetwork = tokenConfig.network;
                
                // Switch to correct network if needed
                const currentChainId = await web3State.provider.request({ method: 'eth_chainId' });
                const targetChainId = WEB3_CONFIG.NETWORKS[targetNetwork].chainId;
                
                if (currentChainId !== targetChainId) {
                    showWeb3Status(`Switching to ${tokenConfig.network.toUpperCase()} network...`, 'pending');
                    const switched = await switchWeb3Network(targetNetwork);
                    if (!switched) {
                        showWeb3Status('Please switch network manually in MetaMask', 'error');
                        return;
                    }
                }

                // Calculate crypto amount
                let cryptoAmount;
                if (web3State.selectedToken === 'ETH') {
                    cryptoAmount = usdAmount / web3State.prices.ethereum;
                } else if (web3State.selectedToken === 'BNB') {
                    cryptoAmount = usdAmount / web3State.prices.binancecoin;
                } else {
                    cryptoAmount = usdAmount; // USDT
                }

                // Prepare and send transaction
                if (tokenConfig.type === 'native') {
                    // Native token transfer (ETH, BNB)
                    await sendWeb3NativeToken(cryptoAmount, tokenConfig);
                } else {
                    // ERC20/BEP20 token transfer
                    await sendWeb3Token(cryptoAmount, tokenConfig);
                }

            } catch (error) {
                console.error('Payment error:', error);
                showWeb3Status(error.message || 'Transaction failed', 'error');
            }
        }
        
        async function sendWeb3NativeToken(amount, tokenConfig) {
            // Convert to wei (ETH/BNB have 18 decimals)
            const decimals = tokenConfig.decimals;
            const amountInWei = BigInt(Math.floor(amount * Math.pow(10, decimals)));
            
            const transactionParameters = {
                from: web3State.userAddress,
                to: WEB3_CONFIG.PRESALE_ADDRESS,
                value: '0x' + amountInWei.toString(16),
                gas: '0x5208', // 21000 Gwei for simple transfers
            };

            try {
                const txHash = await web3State.provider.request({
                    method: 'eth_sendTransaction',
                    params: [transactionParameters]
                });

                showWeb3Status(`Transaction sent! Hash: ${txHash}`, 'success');
                await recordWeb3Transaction(txHash, amount, tokenConfig);
                
            } catch (error) {
                throw error;
            }
        }
        
        async function sendWeb3Token(amount, tokenConfig) {
            const usdAmount = parseFloat(document.getElementById('web3UsdAmount').value) || 0;
            
            // Convert to token units (USDT ERC20: 6 decimals, BEP20: 18 decimals)
            const decimals = tokenConfig.decimals;
            const amountInUnits = BigInt(Math.floor(usdAmount * Math.pow(10, decimals)));
            
            // Simple ABI for transfer function
            const transferABI = {
                "constant": false,
                "inputs": [
                    {
                        "name": "_to",
                        "type": "address"
                    },
                    {
                        "name": "_value",
                        "type": "uint256"
                    }
                ],
                "name": "transfer",
                "outputs": [
                    {
                        "name": "",
                        "type": "bool"
                    }
                ],
                "type": "function"
            };

            const contractAddress = tokenConfig.contract;
            const data = '0x' + 
                'a9059cbb' + // transfer function signature
                WEB3_CONFIG.PRESALE_ADDRESS.substring(2).padStart(64, '0') + // to address
                amountInUnits.toString(16).padStart(64, '0'); // amount

            const transactionParameters = {
                from: web3State.userAddress,
                to: contractAddress,
                data: data,
                gas: '0x186a0', // 100,000 gas - enough for token transfers
            };

            try {
                const txHash = await web3State.provider.request({
                    method: 'eth_sendTransaction',
                    params: [transactionParameters]
                });

                showWeb3Status(`Token transfer sent! Hash: ${txHash}`, 'success');
                await recordWeb3Transaction(txHash, usdAmount, tokenConfig);
                
            } catch (error) {
                throw error;
            }
        }
        
        async function recordWeb3Transaction(txHash, amount, tokenConfig) {
            const usdAmount = parseFloat(document.getElementById('web3UsdAmount').value) || 0;
            const cryptoAmount = amount;
            
            const transactionData = {
                user_address: web3State.userAddress,
                usd_amount: usdAmount,
                crypto_amount: cryptoAmount.toString(),
                token: web3State.selectedToken,
                token_name: tokenConfig.name,
                tx_hash: txHash,
                network: tokenConfig.network,
                timestamp: new Date().toISOString()
            };

            try {
                // Send to backend
                const response = await fetch('/api/transaction', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(transactionData)
                });

                const data = await response.json();
                
                if (data.success) {
                    showWeb3Status('Transaction recorded successfully!', 'success');
                    showToast('‚úÖ Presale contribution recorded! Tokens will be sent to your wallet.', 'success');
                } else {
                    showWeb3Status('Failed to save transaction to backend', 'error');
                }
            } catch (error) {
                console.warn('Could not connect to backend:', error);
                showWeb3Status('Transaction sent but could not be recorded', 'warning');
            }
        }
        
        function showWeb3Status(message, type = 'info') {
            const statusDiv = document.getElementById('web3Status');
            statusDiv.textContent = message;
            statusDiv.className = `web3-status ${type}`;
            statusDiv.style.display = 'block';
            
            // Auto-hide success messages after 10 seconds
            if (type === 'success') {
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 100000);
            }
        }
        
        // ==================== NAVIGATION ====================
        // Real URL routing (History API)
        // Presale stays canonical at '/'
        const SECTION_TO_PATH = {
            presale: '/',
            tokenomics: '/tokenomics',
            roadmap: '/roadmap',
            partners: '/partners',
            team: '/team',
            airdrop: '/airdrop'
        };

        function pathToSection(pathname) {
            const path = (pathname || '/').replace(/\/+$/, '') || '/';
            switch (path) {
                case '/':
                case '/presale':
                    return 'presale';
                case '/tokenomics':
                    return 'tokenomics';
                case '/roadmap':
                    return 'roadmap';
                case '/partners':
                    return 'partners';
                case '/team':
                    return 'team';
                case '/airdrop':
                    return 'airdrop';
                default:
                    // Unknown path: keep homepage
                    return 'presale';
            }
        }

        function sectionToPath(sectionId) {
            return SECTION_TO_PATH[sectionId] || '/';
        }

        function navigateToSection(sectionId, { replace = false } = {}) {
            const path = sectionToPath(sectionId);

            // Preserve existing querystring/hash on initial load (e.g., ?ref=XXXX)
            // so referral codes and other parameters are not lost by router navigation.
            const currentSearch = window.location.search || '';
            const currentHash = window.location.hash || '';
            const url = replace ? `${path}${currentSearch}${currentHash}` : path;

            if (replace) {
                history.replaceState({ section: sectionId }, '', url);
            } else {
                history.pushState({ section: sectionId }, '', url);
            }
            showSection(sectionId);
        }

        function initRouter() {
            // Initial route
            const initialSection = pathToSection(window.location.pathname);
            // Replace state so back/forward works cleanly
            navigateToSection(initialSection, { replace: true });

            // Back/forward
            window.addEventListener('popstate', () => {
                const section = pathToSection(window.location.pathname);
                showSection(section);
            });
        }

        function initNavigation() {
            // Desktop navigation
            const desktopNavLinks = document.querySelectorAll('.desktop-nav .nav-link');
            desktopNavLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    const href = this.getAttribute('href') || '';
                    const isExternal = (this.getAttribute('data-external') === 'stake') || (href === '/stake');
                    if (isExternal) {
                        // Allow normal navigation for staking page
                        return;
                    }
                    e.preventDefault();
                    const section = this.getAttribute('data-section');
                    navigateToSection(section);
                });
            });

            // Mobile navigation buttons
            const mobileNavBtns = document.querySelectorAll('.mobile-nav-btn');
            mobileNavBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const section = this.getAttribute('data-section');
                    navigateToSection(section);
                });
            });
            
            // Mobile menu overlay
            const mobileMenuBtn = document.getElementById('mobileMenuBtn');
            const mobileMenuOverlay = document.getElementById('mobileMenuOverlay');
            const closeMenuBtn = document.getElementById('closeMenuBtn');
            const mobileMenuLinks = document.querySelectorAll('.mobile-menu-link');
            
            mobileMenuBtn.addEventListener('click', () => {
                mobileMenuOverlay.classList.add('active');
            });
            
            closeMenuBtn.addEventListener('click', () => {
                mobileMenuOverlay.classList.remove('active');
            });
            
            mobileMenuLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    const href = this.getAttribute('href') || '';
                    const section = this.getAttribute('data-section');
                    if (href === '/stake' || !section) {
                        mobileMenuOverlay.classList.remove('active');
                        return;
                    }
                    e.preventDefault();
                    navigateToSection(section);
                    mobileMenuOverlay.classList.remove('active');
                });
            });
        }
        
        function showSection(sectionId) {
            // Hide all sections
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Show selected section
            const targetSection = document.getElementById(sectionId);
            if (targetSection) {
                targetSection.classList.add('active');
                currentSection = sectionId;

                // If user navigates to the Airdrop section later, keep the referral code filled
                if (sectionId === 'airdrop') {
                    const storedRef = readPersistedReferralCode();
                    if (storedRef) applyReferralCodeToAirdropInput(storedRef);
                }
                
                // Update desktop nav links
                document.querySelectorAll('.desktop-nav .nav-link').forEach(link => {
                    link.classList.remove('active');
                });
                document.querySelector(`.desktop-nav .nav-link[data-section="${sectionId}"]`)?.classList.add('active');
                
                // Update mobile nav buttons
                document.querySelectorAll('.mobile-nav-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.querySelector(`.mobile-nav-btn[data-section="${sectionId}"]`)?.classList.add('active');
                
                // Scroll to top
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        // ==================== TOKEN STATUS ====================
        function initTokenStatus() {
            const tokenStatusContainer = document.getElementById('tokenStatusContainer');
            const now = new Date();
            
            if (now >= PRESALE_END_DATE) {
                showTokenListedStatus(tokenStatusContainer);
            } else {
                startPresaleCountdown(tokenStatusContainer);
            }
        }
        
        function showTokenListedStatus(container) {
            container.innerHTML = `
                <div style="text-align: center;">
                    <div class="status-badge success">
                        <i class="fas fa-check-circle"></i> TOKEN LISTED!
                    </div>
                    
                    <div style="background: rgba(255, 255, 255, 0.05); border-radius: 15px; padding: 20px; margin: 20px 0; border: 1px solid rgba(255, 255, 255, 0.1);">
                        <div style="color: var(--text-secondary); font-size: 14px; margin-bottom: 8px;">Current Price</div>
                        <div style="font-size: 28px; font-weight: 700; color: var(--primary); margin-bottom: 15px;">1 ETH = ${formatNumber(ETH_TO_APRO_RATE)} OPN</div>
                        <div>
                            <span style="color: var(--text-secondary); margin-right: 15px; font-size: 14px;">$${(0.05).toFixed(4)} USD</span>
                            <span style="background: rgba(0, 255, 136, 0.1); color: var(--primary); padding: 4px 12px; border-radius: 20px; font-size: 13px; font-weight: 600;">+5.2%</span>
                        </div>
                    </div>
                    
                    <div style="margin: 25px 0;">
                        <div style="color: var(--text-secondary); font-size: 14px; margin-bottom: 15px;">Available on:</div>
                        <div style="display: flex; flex-wrap: wrap; justify-content: center; gap: 15px;">
                            <div style="display: flex; flex-direction: column; align-items: center; gap: 8px; padding: 15px; background: rgba(255, 255, 255, 0.03); border-radius: 12px; min-width: 90px;">
                                <i class="fab fa-ethereum" style="font-size: 24px; color: var(--primary);"></i>
                                <span style="font-size: 13px; color: var(--text-secondary);">Uniswap</span>
                            </div>
                            <div style="display: flex; flex-direction: column; align-items: center; gap: 8px; padding: 15px; background: rgba(255, 255, 255, 0.03); border-radius: 12px; min-width: 90px;">
                                <i class="fas fa-exchange-alt" style="font-size: 24px; color: var(--primary);"></i>
                                <span style="font-size: 13px; color: var(--text-secondary);">PancakeSwap</span>
                            </div>
                            <div style="display: flex; flex-direction=column; align-items: center; gap: 8px; padding: 15px; background: rgba(255, 255, 255, 0.03); border-radius: 12px; min-width: 90px;">
                                <i class="fas fa-chart-line" style="font-size: 24px; color: var(--primary);"></i>
                                <span style="font-size: 13px; color: var(--text-secondary);">Gate.io</span>
                            </div>
                        </div>
                    </div>
                    
                    <button class="btn" onclick="openDex()" style="max-width: 250px; margin: 0 auto;">
                        <i class="fas fa-shopping-cart"></i> Buy Now on DEX
                    </button>
                </div>
            `;
            
            startPriceSimulation();
        }
        
        function startPresaleCountdown(container) {
            const updateCountdown = () => {
                const now = new Date();
                const diff = PRESALE_END_DATE - now;
                
                if (diff <= 0) {
                    showTokenListedStatus(container);
                    return;
                }
                
                const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((diff % (1000 * 60)) / 1000);
                
                container.innerHTML = `
                    <div style="text-align: center;">
                        <div class="status-badge warning">
                            <i class="fas fa-clock"></i> PRESALE ENDS IN
                        </div>
                        
                        <div class="countdown-timer">
                            <div class="time-unit">
                                <div class="time-value">${String(days).padStart(2, '0')}</div>
                                <div class="time-label">Days</div>
                            </div>
                            <div class="time-sep">:</div>
                            <div class="time-unit">
                                <div class="time-value">${String(hours).padStart(2, '0')}</div>
                                <div class="time-label">Hours</div>
                            </div>
                            <div class="time-sep">:</div>
                            <div class="time-unit">
                                <div class="time-value">${String(minutes).padStart(2, '0')}</div>
                                <div class="time-label">Minutes</div>
                            </div>
                            <div class="time-sep">:</div>
                            <div class="time-unit">
                                <div class="time-value">${String(seconds).padStart(2, '0')}</div>
                                <div class="time-label">Seconds</div>
                            </div>
                        </div>
                        
                        <div style="margin: 20px auto; max-width: 400px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 13px; color: var(--text-secondary);">
                                <span>Presale Progress</span>
                                <span>${Math.floor(((30 - days) / 30) * 100)}%</span>
                            </div>
                            <div style="height: 6px; background: rgba(255, 255, 255, 0.1); border-radius: 3px; overflow: hidden;">
                                <div style="height: 100%; background: linear-gradient(90deg, var(--primary), var(--primary-dark)); border-radius: 3px; width: ${Math.floor(((30 - days) / 30) * 100)}%; transition: width 1s;"></div>
                            </div>
                        </div>
                        
                        <div style="display: flex; align-items: center; justify-content: center; gap: 10px; background: rgba(255, 170, 0, 0.1); border: 1px solid rgba(255, 170, 0, 0.3); padding: 12px 20px; border-radius: 12px; margin-top: 20px; color: var(--warning); max-width: 400px; margin-left: auto; margin-right: auto; font-size: 14px;">
                            <i class="fas fa-exclamation-triangle"></i>
                            <span>Presale price: 1 ETH = ${formatNumber(ETH_TO_APRO_RATE)} OPN (50% discount)</span>
                        </div>
                    </div>
                `;
            };
            
            updateCountdown();
            setInterval(updateCountdown, 1000);
        }
        
        function startPriceSimulation() {
            setInterval(() => {
                const changeElements = document.querySelectorAll('[style*="background: rgba(0, 255, 136, 0.1)"]');
                changeElements.forEach(el => {
                    if (el.textContent.includes('%')) {
                        const change = (Math.random() - 0.5) * 10;
                        const isPositive = change >= 0;
                        el.textContent = `${isPositive ? '+' : ''}${change.toFixed(1)}%`;
                        el.style.background = isPositive ? 'rgba(0, 255, 136, 0.1)' : 'rgba(255, 107, 107, 0.1)';
                        el.style.color = isPositive ? 'var(--primary)' : 'var(--error)';
                    }
                });
            }, 5000);
        }
        
        function openDex() {
            // Temporary generic Uniswap link (no token prefilled). Update later with OPN contract swap URL.
            const uniswapUrl = 'https://app.uniswap.org/swap';
            window.location.href = uniswapUrl;
        }
        
        // ==================== PRESALE CALCULATOR ====================
        function initPresaleCalculator() {
            const ethInput = document.getElementById('ethAmount');
            
            if (ethInput) {
                ethInput.addEventListener('input', updatePresaleCalculation);
                updatePresaleCalculation(); // Initial calculation
            }
        }
        
        function updatePresaleCalculation() {
            const ethAmount = parseFloat(document.getElementById('ethAmount').value) || 0;
            
            let bonusPercentage = 0;
            if (ethAmount >= 5) bonusPercentage = 0.30;
            else if (ethAmount >= 1) bonusPercentage = 0.25;
            else if (ethAmount >= 0.1) bonusPercentage = 0.20;
            
            const baseTokens = ethAmount * ETH_TO_APRO_RATE;
            const bonusTokens = baseTokens * bonusPercentage;
            const totalTokens = baseTokens + bonusTokens;
            
            document.getElementById('tokensReceived').textContent = formatNumber(Math.floor(baseTokens)) + ' OPN';
            document.getElementById('bonusTokens').textContent = formatNumber(Math.floor(bonusTokens)) + ' OPN';
            document.getElementById('totalTokens').textContent = formatNumber(Math.floor(totalTokens)) + ' OPN';
        }
        
        // ==================== TOKENOMICS CHART ====================
        function initTokenomicsChart() {
            const ctx = document.getElementById('tokenomicsChart');
            if (!ctx) return;
            
            new Chart(ctx.getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: ['Ecosystem & Development', 'Community & Airdrop', 'Team & Advisors', 'Liquidity & Exchange', 'Marketing & Partnerships'],
                    datasets: [{
                        data: [40, 20, 15, 15, 10],
                        backgroundColor: ['#00ff88', '#667eea', '#764ba2', '#ff6b6b', '#ffaa00'],
                        borderWidth: 0,
                        borderRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    return `${label}: ${value}% (${formatNumber(value * 10000000)} OPN)`;
                                }
                            }
                        }
                    },
                    cutout: '65%'
                }
            });
        }
        
        // ==================== ENHANCED REFERRAL SHARING FUNCTIONS ====================
        
        // Generate referral code if not provided
        function generateReferralCode() {
            return 'REF-' + Math.random().toString(36).substring(2, 10).toUpperCase();
        }

        // Get current domain for dynamic link generation
        function getReferralLink(code) {
            const baseUrl = window.location.origin;
            // Phase 2: dedicated mobile-first onboarding page keeps attribution stable.
            return `${baseUrl}/r/${encodeURIComponent(code)}`;
        }

        // Initialize referral link display
        function initReferralLink() {
            const codeElement = document.getElementById('referralCodeValue') || 
                               document.getElementById('referralCodeDisplay');
            if (codeElement) {
                const code = (codeElement.textContent || '').trim();
                const link = getReferralLink(code);
                const linkDisplay = document.getElementById('referralLinkDisplay');
                if (linkDisplay) {
                    linkDisplay.textContent = link;
                    
                    // Update QR code if visible
                    const qrContainer = document.getElementById('qrContainer');
                    if (qrContainer && qrContainer.style.display === 'block') {
                        qrContainer.innerHTML = '<div style="margin-bottom: 10px; color: var(--text-secondary); font-size: 12px;">Scan QR Code:</div>';
                        new QRCode(qrContainer, {
                            text: link,
                            width: 120,
                            height: 120,
                            colorDark: "#00ff88",
                            colorLight: "transparent",
                            correctLevel: QRCode.CorrectLevel.H
                        });
                    }
                }
            }
        }

        // Platform-specific sharing functions with YOUR exact message format
        function shareOnTwitter() {
            const code = getReferralCode();
            const link = getReferralLink(code);
            const text = `Claim your FREE OPN airdrop tokens! Use my referral code ${code} for bonus tokens! ${link} #OPN #Airdrop #Crypto`;
            const url = `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}`;
            window.open(url, '_blank', 'width=550,height=420');
            trackShare('twitter');
        }

        function shareOnTelegram() {
            const code = getReferralCode();
            const link = getReferralLink(code);
            const text = `Claim your FREE OPN airdrop tokens! Use my referral code ${code} for bonus tokens! ${link} #OPN #Airdrop #Crypto`;
            const url = `https://t.me/share/url?url=${encodeURIComponent(link)}&text=${encodeURIComponent(text)}`;
            window.open(url, '_blank', 'width=550,height=420');
            trackShare('telegram');
        }

        function shareOnDiscord() {
            const code = getReferralCode();
            const link = getReferralLink(code);
            const message = `**üéÅ Claim FREE OPN Airdrop Tokens!**\n\nUse my referral code \`${code}\` for bonus tokens!\n\n${link}\n\n#OPN #Airdrop #Crypto`;
            
            navigator.clipboard.writeText(message).then(() => {
                showToast('Discord message copied! Paste it in your Discord server/channel.', 'success');
            });
            trackShare('discord');
        }

        function shareOnReddit() {
            const code = getReferralCode();
            const link = getReferralLink(code);
            const title = "Claim FREE OPN Airdrop Tokens!";
            const text = `Claim your FREE OPN airdrop tokens! Use my referral code **${code}** for bonus tokens!\n\n${link}\n\n#OPN #Airdrop #Crypto`;
            const url = `https://www.reddit.com/submit?title=${encodeURIComponent(title)}&text=${encodeURIComponent(text)}`;
            window.open(url, '_blank', 'width=750,height=600');
            trackShare('reddit');
        }

        // Helper function to get referral code
        function getReferralCode() {
            const codeElement = document.getElementById('referralCodeDisplay');
            return codeElement ? (codeElement.textContent || '').trim() : generateReferralCode();
        }

        // Copy functions
        function copyReferralCode() {
            const code = getReferralCode();
            navigator.clipboard.writeText(code).then(() => {
                showToast('Referral code copied to clipboard!', 'success');
            });
        }

        function copyReferralLink() {
            const link = document.getElementById('referralLinkDisplay').textContent;
            navigator.clipboard.writeText(link).then(() => {
                showToast('Referral link copied to clipboard!', 'success');
            });
        }

        // QR Code functionality
        function initQRCodeButton() {
            const qrBtn = document.getElementById('showQrBtn');
            if (qrBtn) {
                qrBtn.addEventListener('click', function() {
                    const qrContainer = document.getElementById('qrContainer');
                    const showQrBtn = document.getElementById('showQrBtn');
                    
                    if (qrContainer.style.display === 'none' || !qrContainer.style.display) {
                        const link = document.getElementById('referralLinkDisplay').textContent;
                        qrContainer.innerHTML = '<div style="margin-bottom: 10px; color: var(--text-secondary); font-size: 12px;">Scan QR Code:</div>';
                        
                        // Generate QR code
                        new QRCode(qrContainer, {
                            text: link,
                            width: 120,
                            height: 120,
                            colorDark: "#00ff88",
                            colorLight: "transparent",
                            correctLevel: QRCode.CorrectLevel.H
                        });
                        
                        qrContainer.style.display = 'block';
                        showQrBtn.innerHTML = '<i class="fas fa-times"></i> Hide QR Code';
                    } else {
                        qrContainer.style.display = 'none';
                        qrContainer.innerHTML = '';
                        showQrBtn.innerHTML = '<i class="fas fa-qrcode"></i> Show QR Code';
                    }
                });
            }
        }

        // Track shares for analytics
        function trackShare(platform) {
            const code = getReferralCode();
            
            fetch('/api/track-share', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    referral_code: code,
                    platform: platform,
                    timestamp: new Date().toISOString()
                })
            });
            
            // Update share count in UI
            const shareBtn = document.querySelector(`[data-platform="${platform}"]`);
            if (shareBtn) {
                const originalHTML = shareBtn.innerHTML;
                shareBtn.innerHTML = '<i class="fas fa-check"></i> Shared!';
                shareBtn.style.background = 'rgba(0, 255, 136, 0.1)';
                
                setTimeout(() => {
                    shareBtn.innerHTML = originalHTML;
                    shareBtn.style.background = '';
                }, 2000);
            }
        }
        
        // ==================== AIRDROP FUNCTIONS ====================
        async function checkAirdropEligibility() {
            const walletAddress = document.getElementById('airdropWalletAddress').value.trim();
            const referralCode = document.getElementById('airdropReferralCode').value.trim();
            
            if (!validateWalletAddress(walletAddress)) {
                showToast('Please enter a valid Ethereum wallet address (0x followed by 40 hex characters)', 'error');
                return;
            }
            
            showLoading(true);
            
            try {
                const response = await fetch('/api/check-wallet', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        wallet_address: walletAddress,
                        referral_code: referralCode
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Store user data globally
                    currentUserData = data;
                    
                    if (data.eligible) {
                        showAirdropStatus('üéâ You are eligible for the airdrop!', 'success');

                        // Persist "login" so reload keeps the user in dashboard
                        saveWalletSession(walletAddress);
                        
                        // Load the hidden dashboard with claim button
                        await loadHiddenDashboard(walletAddress, data);
                        window.currentWalletAddress = walletAddress;
                        refreshNextAction(walletAddress);
                        window.currentWalletAddress = walletAddress;
                        refreshNextAction(walletAddress);
                        
                    } else if (data.already_claimed) {
                        showAirdropStatus('This wallet has already claimed airdrop tokens.', 'warning');

                        // Persist "login" so reload keeps the user in dashboard
                        saveWalletSession(walletAddress);
                        
                        // Store referral count for achievements
                        currentReferralCount = data.claim_data.referral_count;
                        
                        // Load the hidden dashboard with existing claim data (no claim button)
                        await loadHiddenDashboard(walletAddress, data);
                        window.currentWalletAddress = walletAddress;
                        refreshNextAction(walletAddress);
                        window.currentWalletAddress = walletAddress;
                        refreshNextAction(walletAddress);
                        
                    } else {
                        showAirdropStatus(data.message || 'This wallet is not eligible.', 'error');
                    }
                } else {
                    showAirdropStatus(data.message || 'Error checking eligibility', 'error');
                }
                
            } catch (error) {
                console.error('Error:', error);
                showAirdropStatus('Error checking eligibility. Please try again.', 'error');
            } finally {
                showLoading(false);
            }
        }
        
        async function loadHiddenDashboard(walletAddress, data) {
            const container = document.getElementById('hiddenDashboardContainer');
            const claimData = data.claim_data || null;
            const referralCode = data.referral_code || generateReferralCode();
            const isEligible = data.eligible || false;
            const alreadyClaimed = data.already_claimed || false;
            // Sticky balance is now sourced from /api/balances for consistency across tabs.
            // We render a placeholder initially and refresh it after dashboard mounts.
            const currentBalance = claimData ? claimData.amount : 0;
            
            // Calculate achievement badge
            const achievementsUnlocked = data.claim_data ? Math.floor(data.claim_data.achievement_rewards / 100) : 0;
            const achievementBadge = achievementsUnlocked > 0 ? `<span class="tab-badge">${achievementsUnlocked}/5</span>` : '';
            
            // Build the tabbed dashboard HTML
            container.innerHTML = `
                <!-- Dashboard Header -->
                <div class="dashboard-header">
                    <button class="back-to-form-btn" id="dashboardBackBtn">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                    
                    <h3 style="color: var(--primary); margin: 0; font-size: 22px;">Portfolio</h3>
                    
                    <button class="share-floating-btn" id="dashboardShareBtn" style="display: none;">
                        <i class="fas fa-share-alt"></i>
                    </button>
                </div>
                
                <!-- Horizontal Tabs Navigation -->
                <div class="dashboard-tabs-container">
                    <nav class="dashboard-tabs-nav">
                        <button class="dashboard-tab active" data-tab="overview">
                            <i class="fas fa-chart-pie"></i>
                            <span>Overview</span>
                        </button>
                        
                        <button class="dashboard-tab" data-tab="referral">
                            <i class="fas fa-link"></i>
                            <span>Referral</span>
                        </button>
                        
                        <button class="dashboard-tab" data-tab="achievements">
                            <i class="fas fa-trophy"></i>
                            <span>Achievements</span>
                            <span id="achievementsTabBadgeWrap">${achievementBadge}</span>
                        </button>
                        
                        <button class="dashboard-tab" data-tab="tasks">
                            <i class="fas fa-tasks"></i>
                            <span>Tasks</span>
                        </button>
                        
                        <button class="dashboard-tab" data-tab="network">
                            <i class="fas fa-chart-network"></i>
                            <span>Network</span>
                        </button>
                        
                        <button class="dashboard-tab" data-tab="leaderboard">
                            <i class="fas fa-trophy"></i>
                            <span>Leaderboard</span>
                        </button>
                        
                        <button class="dashboard-tab" data-tab="withdrawals">
                            <i class="fas fa-wallet"></i>
                            <span>Withdrawals</span>
                        </button>
                    </nav>
                </div>
                
                <!-- Sticky Balance Bar -->
                <div class="sticky-balance-bar">
                    <div class="token-display-mini">
                        <div class="token-amount">${formatNumber(currentBalance)}</div>
                        <div class="token-symbol">OPN</div>
                    </div>
                    <div class="balance-status">Available to Claim</div>
                </div>
                
                <!-- Wallet Address Display -->
                <div class="wallet-address-display">
                    <i class="fas fa-wallet"></i>
                    <code id="dashboardWalletAddress" data-full="${walletAddress}" title="${walletAddress}">${shortenWalletAddress(walletAddress)}</code>
                    <button class="copy-wallet-btn" id="copyWalletBtn">
                        <i class="fas fa-copy"></i> Copy
                    </button>
                </div>
                
                <!-- Dashboard Content -->
                <div class="dashboard-content">
                    
                    <!-- Tab 1: Overview -->
	                    <div id="overviewTab" class="dashboard-tab-content active">

                        
                        <!-- 1-Hour Claim Bonus -->
<div class="card" id="claimWindowCard" style="margin-bottom: 14px; background: rgba(102, 126, 234, 0.08); border: 1px solid rgba(102, 126, 234, 0.25);">
                                    <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:12px;">
                                        <div style="display:flex; align-items:center; gap:10px; min-width:0;">
                                            <div style="width: 40px; height: 40px; border-radius: 12px; display:flex; align-items:center; justify-content:center; background: rgba(102, 126, 234, 0.18); color: var(--secondary); flex: 0 0 auto;">
                                                <i class="fas fa-clock"></i>
                                            </div>
                                            <div style="min-width:0;">
                                                <div style="font-weight: 800; color: var(--text-primary);">1-Hour Claim Bonus</div>
                                                <div style="color: var(--text-secondary); font-size: 12px; line-height: 1.35;">Claim rewards every 1 hour ‚Ä¢ Streak bonuses included</div>
                                            </div>
                                        </div>
                                        <div style="text-align:right;">
                                            <div id="claimWindowTimer" style="color: var(--primary); font-weight: 800;">Loading...</div>
                                            <div style="color: var(--text-secondary); font-size: 12px;"><span id="claimWindowMeta">...</span></div>
                                        </div>
                                    </div>

                                    <div style="margin-top: 12px; display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
                                        <button class="btn" id="claimWindowBtn" style="padding: 10px 14px; background: linear-gradient(90deg, #667eea, #764ba2);" disabled>
                                            <i class="fas fa-hand-holding-usd"></i> Claim
                                        </button>
                                        <div id="claimWindowStatus" style="color: var(--text-secondary); font-size: 13px;"></div>
                                    </div>
                                </div>
                                
                                
                        
                        <div id="nextActionCard" class="card" style="margin-bottom: 14px; display:none;">
                            <div style="display:flex; gap:12px; align-items:flex-start; justify-content:space-between; flex-wrap:wrap;">
                                <div style="min-width: 220px; flex: 1;">
                                    <div id="nextActionTitle" style="font-weight:800; font-size:16px; margin-bottom:6px; color: var(--text);">Your next step</div>
                                    <div id="nextActionBody" style="color: var(--text-secondary); font-size:13px; line-height:1.45;"></div>
                                </div>
                                <button class="btn" id="nextActionBtn" style="min-width: 180px; width: 100%; max-width: 240px; align-self:stretch;">
                                    Continue
                                </button>
                            </div>
                        </div>
                        
                        <!-- Recent activity (Phase 3) -->
                        <div id="activityCard" class="card" style="margin-bottom: 14px; display:none;">
                            <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;">
                                <div style="font-weight:800; font-size:15px; color:var(--text);">
                                    <i class="fas fa-bolt" style="color: var(--secondary);"></i> Recent activity
                                </div>
                                <button class="btn btn-secondary" id="activityRefreshBtn" style="padding:8px 12px; min-width: 110px;">
                                    <i class="fas fa-sync-alt"></i> Refresh
                                </button>
                            </div>
                            <div id="activityList" style="margin-top: 10px; display:flex; flex-direction:column; gap:10px;"></div>
                            <div id="activityEmpty" style="margin-top: 10px; color: var(--text-secondary); font-size: 13px; display:none;">
                                No activity yet. Once you claim, refer friends, or submit a withdrawal request, updates will appear here.
                            </div>
                        </div>

                        <!-- Milestones (Phase 4) -->
                        <div id="milestonesCard" class="card" style="margin-bottom: 14px; display:none;">
                            <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;">
                                <div style="font-weight:800; font-size:15px; color:var(--text);">
                                    <i class="fas fa-flag-checkered" style="color: var(--primary);"></i> Milestones
                                </div>
                                <button class="btn btn-secondary" id="milestonesRefreshBtn" style="padding:8px 12px; min-width: 110px;">
                                    <i class="fas fa-sync-alt"></i> Refresh
                                </button>
                            </div>
                            <div id="milestonesList" style="margin-top: 10px; display:flex; flex-direction:column; gap:10px;"></div>
                            <div id="milestonesEmpty" style="margin-top: 10px; color: var(--text-secondary); font-size: 13px; display:none;">
                                Milestones help you track progress toward withdrawal eligibility.
                            </div>
                        </div>
	                        <!-- Welcome bonus card (pinned to top for unclaimed wallets via JS) -->
	<div class="card" id="welcomeBonusCard">
                            <div style="text-align: center;">
                                <div style="font-size: 48px; color: var(--primary); margin-bottom: 20px;">
                                    <i class="fas fa-gift"></i>
                                </div>
                                
                                <!-- CLAIM AIRDROP BUTTON - Only show if eligible and not already claimed -->
                                ${isEligible && !alreadyClaimed ? `
                                    <button class="btn" id="dashboardClaimBtn" style="margin-bottom: 20px; background: linear-gradient(90deg, var(--primary), var(--primary-dark));">
                                        <i class="fas fa-gift"></i> Claim ${formatNumber((data && data.base_amount) ? data.base_amount : 0)} OPN Welcome Bonus
                                    </button>
                                    
                                    <div style="margin-bottom: 15px; color: var(--text-secondary); font-size: 13px;">
                                        <i class="fas fa-info-circle"></i> You can earn more through referrals and achievements
                                    </div>
                                ` : ''}
                                
                                ${alreadyClaimed ? `
                                    <div style="margin-bottom: 20px; padding: 15px; background: rgba(0, 255, 136, 0.1); border-radius: 10px; border: 1px solid rgba(0, 255, 136, 0.3);">
                                        <div style="display: flex; align-items: center; gap: 10px; justify-content: center; color: var(--primary);">
                                            <i class="fas fa-check-circle"></i>
                                            <span>Airdrop Already Claimed</span>
                                        </div>
                                    </div>
                                ` : ''}
                                
                                <!-- Quick Stats -->
                                <div class="overview-quick-stats">
                                    <div class="stat-item">
                                        <div class="stat-value">${data.claim_data ? formatNumber(data.claim_data.referral_count) : 0}</div>
                                        <div class="stat-label">Referrals</div>
                                    </div>
                                    <div class="stat-item">
                                        <div class="stat-value" id="overviewAchievementsValue">${achievementsUnlocked}</div>
                                        <div class="stat-label">Achievements</div>
                                    </div>
                                    <div class="stat-item">
                                        <div class="stat-value">${data.claim_data ? formatNumber(data.claim_data.referral_bonus) : 0}</div>
                                        <div class="stat-label">Bonus</div>
                                    </div>
                                    <div class="stat-item">
                                        <div class="stat-value">${formatNumber(currentBalance)}</div>
                                        <div class="stat-label">Total</div>
                                    </div>
                                </div>

                                <!-- Referral Code Quick View -->
                                <div style="margin-top: 25px;">
                                    <div style="color: var(--text-secondary); font-size: 14px; margin-bottom: 8px;">
                                        <i class="fas fa-link"></i> Your Referral Code:
                                    </div>
                                    <div class="code-display" style="font-size: 20px; letter-spacing: 2px;">
                                        ${referralCode}
                                    </div>
                                    <button class="btn-secondary" onclick="copyReferralCode()" style="margin-top: 10px; padding: 8px 15px; font-size: 13px;">
                                        <i class="fas fa-copy"></i> Copy Code
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div id="airdropStatusDetails" style="display: ${claimData ? 'block' : 'none'}">
                            ${claimData ? `
                                <div class="card" style="background: rgba(0, 255, 136, 0.1); border: 1px solid rgba(0, 255, 136, 0.3);">
                                    <h4 style="color: var(--primary); margin-bottom: 10px;">‚úÖ Airdrop Already Claimed</h4>
                                    <div style="margin: 10px 0;">
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                            <span style="color: var(--text-secondary);">Total Amount:</span>
                                            <strong style="color: var(--primary);">${formatNumber(claimData.amount)} OPN</strong>
                                        </div>
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                            <span style="color: var(--text-secondary);">Base Amount:</span>
                                            <strong>${formatNumber(claimData.base_amount)} OPN</strong>
                                        </div>
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                            <span style="color: var(--text-secondary);">Referral Bonus:</span>
                                            <strong style="color: var(--warning);">${formatNumber(claimData.referral_bonus)} OPN</strong>
                                        </div>
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                            <span style="color: var(--text-secondary);">Achievements:</span>
                                            <strong style="color: var(--secondary);">${formatNumber(claimData.achievement_rewards)} OPN</strong>
                                        </div>
                                        <div style="display: flex; justify-content: space-between; margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(255, 255, 255, 0.1);">
                                            <span style="color: var(--text-secondary);">Transaction:</span>
                                            <code style="color: var(--primary); font-size: 12px;">${claimData.tx_hash.substring(0, 20)}...</code>
                                        </div>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                    
                    <!-- Tab 2: Referral Center -->
                    <div id="referralTab" class="dashboard-tab-content">
                        <div class="card">
                            <div style="display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 15px;">
                                <i class="fas fa-link" style="color: var(--primary); font-size: 20px;"></i>
                                <h3 style="color: var(--primary); margin: 0; font-size: 20px;">Your Referral Code</h3>
                            </div>
                            
                            <!-- Referral Code Display -->
                            <div class="code-display" id="referralCodeDisplay" style="font-size: 22px; letter-spacing: 3px;">${referralCode}</div>
                            
                            <!-- Referral Link -->
                            <div style="margin: 20px 0;">
                                <div style="color: var(--text-secondary); font-size: 14px; margin-bottom: 8px; text-align: center;">
                                    <i class="fas fa-external-link-alt"></i> Your Referral Link:
                                </div>
                                <div class="referral-link-container">
                                    <div class="address-display" id="referralLinkDisplay" style="text-align: center; font-size: 14px; cursor: pointer;">
                                        Loading...
                                    </div>
                                </div>
                            </div>
                            
                            <!-- QR Code Option -->
                            <div style="text-align: center; margin: 15px 0;">
                                <button id="showQrBtn" class="btn-secondary" style="padding: 8px 15px; font-size: 13px;">
                                    <i class="fas fa-qrcode"></i> Show QR Code
                                </button>
                                <div id="qrContainer" style="display: none; margin-top: 15px;"></div>
                            </div>
                            
                            <!-- Share on Platforms -->
                            <div style="margin: 18px 0;">
                                <div style="color: var(--text-secondary); font-size: 12px; margin-bottom: 10px; text-align: center; letter-spacing: 0.2px;">
                                    <i class="fas fa-share-alt"></i> Share
                                </div>
                                
                                <div class="share-platforms-grid">
                                    <!-- X Button -->
                                    <button class="share-platform-btn" data-platform="twitter" onclick="shareOnTwitter()" aria-label="Share on X">
                                        <div class="platform-icon">
                                            <i class="fab fa-x-twitter"></i>
                                        </div>
                                        <span>X</span>
                                    </button>
                                    
                                    <!-- Telegram Button -->
                                    <button class="share-platform-btn" data-platform="telegram" onclick="shareOnTelegram()" aria-label="Share on Telegram">
                                        <div class="platform-icon">
                                            <i class="fab fa-telegram"></i>
                                        </div>
                                        <span>Telegram</span>
                                    </button>
                                    
                                    <!-- Discord Button -->
                                    <button class="share-platform-btn" data-platform="discord" onclick="shareOnDiscord()" aria-label="Share on Discord">
                                        <div class="platform-icon">
                                            <i class="fab fa-discord"></i>
                                        </div>
                                        <span>Discord</span>
                                    </button>
                                    
                                    <!-- Reddit Button (Optional) -->
                                    <button class="share-platform-btn" data-platform="reddit" onclick="shareOnReddit()" aria-label="Share on Reddit">
                                        <div class="platform-icon">
                                            <i class="fab fa-reddit"></i>
                                        </div>
                                        <span>Reddit</span>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Copy Buttons -->
                            <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                                <button class="btn" id="copyCodeBtn" style="flex: 1;">
                                    <i class="fas fa-copy"></i> Copy Code
                                </button>
                                <button class="btn btn-secondary" id="copyLinkBtn" style="flex: 1;">
                                    <i class="fas fa-link"></i> Copy Link
                                </button>
                            </div>
                            
                            <!-- Incentive Message -->
                            <div style="background: rgba(0, 255, 136, 0.1); padding: 12px; border-radius: 8px; text-align: center; border: 1px solid rgba(0, 255, 136, 0.3);">
                                <div style="color: var(--primary); font-weight: 600; font-size: 14px; display: flex; align-items: center; justify-content: center; gap: 8px;">
                                    <i class="fas fa-gift"></i>
                                    Share to earn 121 bonus tokens per referral
                                </div>
                                <div style="color: var(--text-secondary); font-size: 12px; margin-top: 5px;">
                                    Minimum 7 referrals required for withdrawal
                                </div>
                            </div>
                            
                            <div class="stats-grid" style="margin-top: 20px;">
                                <div class="stat-item">
                                    <div class="stat-value" id="totalReferrals">0</div>
                                    <div class="stat-label">Total Referrals</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-value" id="totalBonus">0</div>
                                    <div class="stat-label">Total Bonus</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-value" id="linkClicks">0</div>
                                    <div class="stat-label">Link Clicks</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-value" id="conversionRate">0%</div>
                                    <div class="stat-label">Conversion Rate</div>
                                </div>
                            </div>
                            
                            <button class="btn btn-secondary" id="refreshStatsBtn" style="margin-top: 10px; width: 100%;">
                                <i class="fas fa-sync-alt"></i> Refresh Stats
                            </button>
                        </div>
                    </div>
                    
                    <!-- Tab 3: Achievements -->
                    <div id="achievementsTab" class="dashboard-tab-content">
                        <div class="card">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                                <h3 style="color: var(--primary); margin: 0; font-size: 20px;">
                                    <i class="fas fa-trophy" style="margin-right: 10px;"></i> Your Achievements
                                </h3>
                                <div style="display: flex; align-items: center; gap: 15px;">
                                    <div style="background: rgba(0, 255, 136, 0.1); padding: 8px 15px; border-radius: 20px; border: 1px solid rgba(0, 255, 136, 0.3);">
                                        <span style="color: var(--primary); font-weight: 600; font-size: 14px;">
                                            <span id="achievementsUnlocked">0</span>/5 Unlocked
                                        </span>
                                    </div>
                                    <div style="background: rgba(102, 126, 234, 0.1); padding: 8px 15px; border-radius: 20px; border: 1px solid rgba(102, 126, 234, 0.3);">
                                        <span style="color: var(--secondary); font-weight: 600; font-size: 14px;">
                                            +<span id="achievementsRewards">0</span> OPN Bonus
                                        </span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Achievement Progress Bar -->
                            <div style="margin-bottom: 25px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 13px; color: var(--text-secondary);">
                                    <span>Achievement Progress</span>
                                    <span id="achievementsProgress">0%</span>
                                </div>
                                <div style="height: 6px; background: rgba(255, 255, 255, 0.1); border-radius: 3px; overflow: hidden; margin-bottom: 5px;">
                                    <div id="achievementsProgressBar" style="height: 100%; background: linear-gradient(90deg, var(--primary), var(--secondary)); border-radius: 3px; width: 0%; transition: width 0.5s ease;"></div>
                                </div>
                            </div>
                            
                            <!-- Achievements Grid -->
                            <div id="achievementsGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px;">
                                <!-- Achievement cards will be dynamically inserted here -->
                            </div>
                            
                            <!-- Achievement Info -->
                            <div style="margin-top: 25px; padding-top: 20px; border-top: 1px solid rgba(255, 255, 255, 0.1);">
                                <div style="display: flex; align-items: flex-start; gap: 10px; background: rgba(255, 255, 255, 0.03); padding: 15px; border-radius: 10px; border: 1px solid rgba(255, 255, 255, 0.1);">
                                    <div style="color: var(--primary); font-size: 18px;">
                                        <i class="fas fa-lightbulb"></i>
                                    </div>
                                    <div style="flex: 1;">
                                        <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 5px; font-size: 14px;">How Achievements Work</div>
                                        <div style="color: var(--text-secondary); font-size: 13px;">
                                            Complete tasks to unlock achievements and earn bonus OPN tokens. Each achievement gives permanent bonus rewards added to your total balance.
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tab 4: Tasks (Placeholder) -->
                    <div id="tasksTab" class="dashboard-tab-content">
                        <div class="card">
                            <h3 style="color: var(--primary); margin-bottom: 16px; font-size: 20px;">
                                <i class="fas fa-tasks"></i> Tasks
                            </h3>

                            <div style="display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap; margin-bottom: 16px;">
                                <div style="color: var(--text-secondary); font-size: 14px;">
                                    Complete tasks and submit your proof URL. Admin will approve/decline.
                                </div>
                                <div style="background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.12); padding: 8px 12px; border-radius: 999px;">
                                    <span style="color: var(--text-secondary); font-size: 13px;">Task Points:</span>
                                    <span id="taskPointsValue" style="color: var(--primary); font-weight: 700; margin-left: 6px;">0</span>
                                </div>
                            </div>

                            <div id="tasksList" class="tasks-grid"></div>
                            <div id="tasksEmpty" style="display:none; color: var(--text-secondary); text-align:center; padding: 20px;">
                                No tasks available right now.
                            </div>

                            <!-- Ultra-minimal completed archive (approved tasks auto-move here) -->
                            <div id="tasksArchiveWrap" style="display:none; margin-top: 16px;">
                                <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom: 8px;">
                                    <div style="color: var(--text-secondary); font-size: 13px; font-weight: 600; letter-spacing: 0.2px;">
                                        Completed
                                        <span id="tasksArchiveCount" style="margin-left: 6px; color: var(--primary); font-weight: 800;">0</span>
                                    </div>
                                    <button class="btn btn-secondary" id="toggleArchiveBtn" style="padding: 8px 10px; font-size: 12px;">
                                        <i class="fas fa-chevron-down"></i> Show
                                    </button>
                                </div>
                                <div id="tasksArchive" style="display:none; border: 1px solid rgba(255,255,255,0.10); background: rgba(255,255,255,0.03); border-radius: 12px; overflow:hidden;"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tab 5: Network Analysis -->
                    <div id="networkTab" class="dashboard-tab-content">
                        <div class="card">
                            <h3 style="color: var(--primary); margin-bottom: 20px; font-size: 20px;">
                                <i class="fas fa-chart-network"></i> Network Analysis
                            </h3>
                            <div id="networkAnalysisContent">
                                <!-- Network analysis will be loaded here -->
                            </div>
                        
                            <div id="telegramCtaNetwork" style="margin-top: 14px; border: 1px solid rgba(255,255,255,0.08); border-radius: 12px; padding: 14px; background: rgba(255,255,255,0.02);">
                                <div style="display:flex; align-items:flex-start; justify-content:space-between; gap:12px; flex-wrap:wrap;">
                                    <div style="flex:1; min-width:220px;">
                                        <div style="font-weight:800; margin-bottom:6px; color: var(--primary);">
                                            <i class="fab fa-telegram-plane"></i> Need help activating referrals?
                                        </div>
                                        <div style="color: var(--text-secondary); font-size:13px; line-height:1.45;">
                                            Join the official channel for guidance and announcements.
                                        </div>
                                    </div>
                                    <button class="btn" type="button" onclick="openTelegram('network_block')" style="min-width:180px; width:100%; max-width:240px;">
                                        Open Telegram
                                    </button>
                                </div>
                            </div>
</div>
                    </div>
                    
                    <!-- Tab 6: Leaderboard -->
                    <div id="leaderboardTab" class="dashboard-tab-content">
                        <div class="card">
                            <h3 style="color: var(--primary); margin-bottom: 20px; font-size: 20px;">üèÜ Top Referrers</h3>
                            <div id="leaderboardContent">
                                <!-- Leaderboard will be loaded here -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tab 7: Withdrawals -->
                    <div id="withdrawalsTab" class="dashboard-tab-content">
                        <div class="card">
                            <h3 style="color: var(--primary); margin-bottom: 20px; font-size: 20px;">
                                <i class="fas fa-wallet"></i> Withdrawal
                            </h3>

                            <!-- Balance Breakdown (populated via /api/simulate-withdrawal) -->
                            <div id="withdrawalBalancesMini" style="margin-bottom: 18px;"></div>
                            
                            
                            <div id="telegramCtaWithdrawals" class="card" style="margin: 12px 0 18px 0; padding: 14px;">
                                <div style="display:flex; align-items:flex-start; justify-content:space-between; gap:12px; flex-wrap:wrap;">
                                    <div style="flex:1; min-width:220px;">
                                        <div style="font-weight:800; margin-bottom:6px; color: var(--primary);">
                                            <i class="fab fa-telegram-plane"></i> Official Telegram
                                        </div>
                                        <div style="color: var(--text-secondary); font-size:13px; line-height:1.45;">
                                            Get withdrawal status updates, anti-scam alerts, and fastest support.
                                        </div>
                                    </div>
                                    <button class="btn" type="button" onclick="openTelegram('withdrawals_block')" style="min-width:180px; width:100%; max-width:240px;">
                                        Open Telegram
                                    </button>
                                </div>
                            </div>
<div style="margin-bottom: 20px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                    <span style="color: var(--text-secondary); font-size: 14px;">
                                        <i class="fas fa-users"></i> Referral Progress to Unlock Withdrawals
                                    </span>
                                    <span style="color: var(--primary); font-weight: 600; font-size: 14px;" id="referralProgressText">0/7</span>
                                </div>
                                <div style="height: 10px; background: rgba(255, 255, 255, 0.1); border-radius: 5px; overflow: hidden; margin-bottom: 10px;">
                                    <div id="referralProgressBar" style="height: 100%; background: linear-gradient(90deg, var(--primary), var(--secondary)); border-radius: 5px; width: 0%; transition: width 0.5s ease;"></div>
                                </div>
                            </div>
                            
                            <button class="btn" id="withdrawBtn" style="background: linear-gradient(90deg, #667eea, #764ba2); width: 100%;">
                                <i class="fas fa-paper-plane"></i> Check Withdrawal Status
                            </button>
                            
                            <div id="withdrawalStatus" style="margin-top: 15px; display: none;"></div>
                            
                            <button class="btn btn-secondary" id="viewLeaderboardBtn" style="margin-top: 10px; width: 100%;">
                                <i class="fas fa-trophy"></i> View Leaderboard
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            // Show the dashboard view
            showDashboardView();
            
            // Initialize event listeners for the dashboard
            setTimeout(() => {
                // Initialize dashboard tabs
                initDashboardTabs();

                    // Pin welcome bonus card to the top of the Overview tab for wallets
                    // that have not yet claimed the welcome bonus.
                    pinWelcomeBonusCardIfUnclaimed();
                
                // Initialize referral link
                initReferralLink();
                
                // Initialize buttons
                document.getElementById('copyCodeBtn')?.addEventListener('click', copyReferralCode);
                document.getElementById('copyLinkBtn')?.addEventListener('click', copyReferralLink);
                document.getElementById('refreshStatsBtn')?.addEventListener('click', refreshReferralStats);
                document.getElementById('viewLeaderboardBtn')?.addEventListener('click', () => {
                    const lbTab = document.querySelector('.dashboard-tab[data-tab="leaderboard"]');
                    if (lbTab) {
                        lbTab.click();
                    } else {
                        // Fallback: just load data (shouldn't happen if dashboard tabs are present)
                        loadLeaderboard();
                    }
                });
                document.getElementById('withdrawBtn')?.addEventListener('click', checkWithdrawalProgress);
                document.getElementById('dashboardClaimBtn')?.addEventListener('click', claimAirdrop);
                
                // Initialize QR code button
                initQRCodeButton();

                // Activity feed
                document.getElementById('activityRefreshBtn')?.addEventListener('click', () => {
                    const w = getDashboardWalletAddress();
                    if (w) refreshActivity(w);
                });

                // Milestones
                document.getElementById('milestonesRefreshBtn')?.addEventListener('click', () => {
                    const w = getDashboardWalletAddress();
                    if (w) refreshMilestones(w);
                });
                
                // Load initial data for the current tab
                if (walletAddress && validateWalletAddress(walletAddress)) {
                    refreshStickyBalance(walletAddress);
                    loadTabData(currentDashboardTab);
                    // Keep the 1-hour claim bonus ready on first load
                    initClaimWindowBonus(walletAddress);
                    refreshActivity(walletAddress);
                    refreshMilestones(walletAddress);
                    loadAchievements(walletAddress);
                }
            }, 100);
        }

            // Move the welcome bonus card to the top of the Overview tab ONLY when the
            // welcome bonus is still unclaimed (detected by presence of the claim button).
            function pinWelcomeBonusCardIfUnclaimed() {
                const overview = document.getElementById('overviewTab');
                const welcomeCard = document.getElementById('welcomeBonusCard');
                const claimBtn = document.getElementById('dashboardClaimBtn');
                const anchor = document.getElementById('claimWindowCard');
                if (!overview || !welcomeCard) return;

                // Only pin for unclaimed welcome bonus state.
                if (!claimBtn) return;

                // Insert before the 1-hour claim bonus card (top of Overview stack).
                if (anchor) {
                    overview.insertBefore(welcomeCard, anchor);
                } else {
                    overview.prepend(welcomeCard);
                }
            }
        
        // ==================== CLAIM AIRDROP FUNCTION ====================
        async function claimAirdrop() {
            // Get wallet address from dashboard, not initial form
            const walletAddress = getDashboardWalletAddress() || 
                                 document.getElementById('airdropWalletAddress')?.value.trim();
            const referralCode = document.getElementById('airdropReferralCode')?.value.trim() || '';
            
            if (!validateWalletAddress(walletAddress)) {
                showToast('Please enter a valid Ethereum wallet address', 'error');
                return;
            }
            
            // Get claim button and show loading state
            const claimBtn = document.getElementById('dashboardClaimBtn');
            const originalText = claimBtn?.innerHTML || '';
            
            try {
                if (claimBtn) {
                    claimBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Claiming...';
                    claimBtn.disabled = true;
                }
                
                const response = await fetch('/api/claim-airdrop', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        wallet_address: walletAddress,
                        referral_code: referralCode
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    if (data.already_claimed) {
                        showToast('‚úÖ Airdrop already claimed!', 'info');
                        
                        // Update UI for already claimed
                        if (claimBtn) {
                            claimBtn.style.display = 'none';
                        }
                        
	                    } else {
                        showToast(`‚úÖ Successfully claimed ${formatNumber(data.data.amount)} OPN tokens!`, 'success');
                        
                        // Refresh the canonical sticky balance (prevents inconsistencies)
                        refreshStickyBalance(walletAddress);
                        
                        // Remove claim button (since already claimed)
                        if (claimBtn) {
                            claimBtn.style.display = 'none';
                        }
                        
                        // Store referral count for achievements
                        currentReferralCount = data.data.referral_count;
                        
                        // Reload dashboard sections with new data
                        const walletAddress = getDashboardWalletAddress();
                        if (walletAddress) {
                            await loadReferralStats(walletAddress);
                            await loadNetworkAnalysis(walletAddress);
                            await loadAchievements(walletAddress);
                        }
                        
                        // Show success animation
                        showConfetti();
                        
                        // Update airdrop status details
                        const txHash = (data?.data?.tx_hash || '').toString();
                        const txShort = txHash ? `${txHash.substring(0, 20)}...` : '‚Äî';

                        document.getElementById('airdropStatusDetails').style.display = 'block';
                        document.getElementById('airdropStatusDetails').innerHTML = `
                            <div class="card" style="background: rgba(0, 255, 136, 0.1); border: 1px solid rgba(0, 255, 136, 0.3);">
                                <h4 style="color: var(--primary); margin-bottom: 10px;">‚úÖ Airdrop Claimed Successfully!</h4>
                                <div style="margin: 10px 0;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                        <span style="color: var(--text-secondary);">Total Amount:</span>
                                        <strong style="color: var(--primary);">${formatNumber(data.data.amount)} OPN</strong>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                        <span style="color: var(--text-secondary);">Base Amount:</span>
                                        <strong>${formatNumber(data.data.base_amount)} OPN</strong>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                        <span style="color: var(--text-secondary);">Referral Bonus:</span>
                                        <strong style="color: var(--warning);">${formatNumber(data.data.referral_bonus)} OPN</strong>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                        <span style="color: var(--text-secondary);">Achievements:</span>
                                        <strong style="color: var(--secondary);">${formatNumber(data.data.achievement_rewards)} OPN</strong>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(255, 255, 255, 0.1);">
                                        <span style="color: var(--text-secondary);">Transaction:</span>
                                        <code style="color: var(--primary); font-size: 12px;">${txShort}</code>
                                    </div>
                                </div>
                            </div>
                        `;

	                        // Full refresh is the simplest way to ensure the welcome bonus card
	                        // returns to its normal (bottom) position and all stats reconcile.
	                        setTimeout(() => {
	                            window.location.reload();
	                        }, 900);
                    }
                } else {
                    showToast(data.message || 'Error claiming airdrop', 'error');
                    if (claimBtn) {
                        claimBtn.innerHTML = originalText;
                        claimBtn.disabled = false;
                    }
                }
                
            } catch (error) {
                console.error('Error:', error);
                showToast('Error claiming airdrop. Please try again.', 'error');
                if (claimBtn) {
                    claimBtn.innerHTML = originalText;
                    claimBtn.disabled = false;
                }
            }
        }
        
        // ==================== DASHBOARD UTILITY FUNCTIONS ====================
        function copyDashboardWalletAddress() {
            const walletAddress = getDashboardWalletAddress();
            navigator.clipboard.writeText(walletAddress).then(() => {
                showToast('Wallet address copied to clipboard!', 'success');
            });
        }
        
        // ==================== WITHDRAWAL FUNCTIONS ====================
        async function checkWithdrawalProgress() {
            const walletAddress = getDashboardWalletAddress() || 
                                 document.getElementById('airdropWalletAddress')?.value.trim();
            
            if (!validateWalletAddress(walletAddress)) {
                showToast('Please enter a valid wallet address first', 'error');
                return;
            }
            
            await loadWithdrawalUI(walletAddress);
        }
        
        async function loadWithdrawalUI(walletAddress) {
            const withdrawBtn = document.getElementById('withdrawBtn');
            const statusEl = document.getElementById('withdrawalStatus');
            if (!statusEl) return;

            try {
                if (withdrawBtn) {
                    withdrawBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
                    withdrawBtn.disabled = true;
                }

                const res = await fetch(`/api/withdrawal/config?wallet=${walletAddress}`);
                const cfg = await res.json();
                if (!cfg.success) {
                    showToast(cfg.message || 'Failed to load withdrawals', 'error');
                    return;
                }

                // Update progress UI
                const required = Number(cfg.min_referrals_to_withdraw || 7);
                const refs = Number(cfg.referral_count || 0);
                document.getElementById('referralProgressText').textContent = `${refs}/${required}`;
                const progress = Math.min((refs / Math.max(required, 1)) * 100, 100);
                document.getElementById('referralProgressBar').style.width = `${progress}%`;

                // Balance card
                if (cfg.balances) {
                    renderWithdrawalBalances({
                        welcome_bonus: cfg.balances.welcome_bonus,
                        referral_earnings: cfg.balances.referral_earnings,
                        achievement_earnings: cfg.balances.achievement_earnings,
                        task_earnings: cfg.balances.task_earnings,
                        claim_window_earnings: cfg.balances.claim_window_earnings,
                        total_balance: cfg.balances.total_earned,
                        available_for_withdrawal: cfg.balances.withdrawable,
                        total_withdrawn: cfg.balances.total_withdrawn,
                    });
                }

                const openAt = new Date(cfg.withdrawal_open_at);
                const openAtStr = openAt.toLocaleString(undefined, { year: 'numeric', month: 'long', day: 'numeric' });

                if (cfg.banned_until) {
                    const banUntil = new Date(cfg.banned_until);
                    statusEl.innerHTML = `
                        <div style="background: rgba(255, 80, 80, 0.10); padding: 18px; border-radius: 12px; border: 1px solid rgba(255, 80, 80, 0.30);">
                            <strong style="color: #ff8b8b;">‚ö†Ô∏è Too many attempts</strong>
                            <div style="color: var(--text-secondary); margin-top: 6px;">Try again at <strong>${banUntil.toLocaleString()}</strong></div>
                        </div>
                    `;
                    statusEl.style.display = 'block';
                    return;
                }

                if (!cfg.withdrawals_open) {
                    statusEl.innerHTML = `
                        <div style="background: rgba(255,255,255,0.05); padding: 18px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.12);">
                            <strong style="color: var(--primary);">üîí Withdrawals are not open yet</strong>
                            <div style="color: var(--text-secondary); margin-top: 6px;">Withdrawals open on <strong>${openAtStr}</strong></div>
                        </div>
                    `;
                    statusEl.style.display = 'block';
                    return;
                }

                if (!cfg.eligible_by_referrals) {
                    const remaining = Math.max(0, required - refs);
                    statusEl.innerHTML = `
                        <div style="background: rgba(255, 170, 0, 0.10); padding: 18px; border-radius: 12px; border: 1px solid rgba(255, 170, 0, 0.30);">
                            <strong style="color: var(--warning);">‚ö†Ô∏è Withdrawal Locked</strong>
                            <div style="color: var(--text-secondary); margin-top: 6px;">You need <strong>${remaining}</strong> more active referrals to withdraw.</div>
                        </div>
                    `;
                    statusEl.style.display = 'block';
                    return;
                }

                if (cfg.pending_withdrawal) {
                    statusEl.innerHTML = `
                        <div style="background: rgba(255,255,255,0.05); padding: 18px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.12);">
                            <strong style="color: var(--primary);">‚è≥ Pending withdrawal</strong>
                            <div style="color: var(--text-secondary); margin-top: 6px;">You already have a pending request (ID: <strong>${cfg.pending_withdrawal}</strong>).</div>
                        </div>
                    `;
                    statusEl.style.display = 'block';
                    return;
                }

                // Show withdraw wizard (step-by-step flow)
                const feeWallet = cfg.fee_wallet;
                const withdrawable = Number(cfg?.balances?.withdrawable || 0);
                const fees = cfg?.fees || {};

                // Convert wei (string) -> human value string
                const formatWeiToEth = (weiStr) => {
                    try {
                        const wei = BigInt(String(weiStr || '0'));
                        const base = 10n ** 18n;
                        const whole = wei / base;
                        const frac = wei % base;
                        const fracStr = frac.toString().padStart(18, '0').replace(/0+$/, '');
                        return fracStr ? `${whole}.${fracStr.slice(0, 6)}` : `${whole}`;
                    } catch (e) {
                        return '0';
                    }
                };

                const getFeeDisplay = (chain) => {
                    if (chain === 'eth') {
                        return {
                            amount: formatWeiToEth(fees.eth_fee_wei),
                            symbol: 'ETH'
                        };
                    }
                    return {
                        amount: formatWeiToEth(fees.bsc_fee_wei),
                        symbol: 'BNB'
                    };
                };

                statusEl.innerHTML = `
                    <div style="background: rgba(0, 255, 136, 0.08); padding: 18px; border-radius: 12px; border: 1px solid rgba(0, 255, 136, 0.22);">
                        <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom: 12px;">
                            <strong style="color: var(--primary);">‚úÖ Withdraw</strong>
                            <span style="color: var(--text-secondary); font-size: 13px;">Guided flow ‚Ä¢ 4 steps</span>
                        </div>

                        <div id="withdrawWizardProgress" style="margin-bottom: 12px;">
                            <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
                                <div style="color: var(--text-secondary); font-size: 12px;">Step <strong id="withdrawWizardStep">1</strong> of 4</div>
                                <div style="color: var(--text-secondary); font-size: 12px;">Available: <strong>${formatNumber(withdrawable)}</strong> OPN</div>
                            </div>
                            <div style="height: 6px; border-radius: 999px; background: rgba(255,255,255,0.10); margin-top: 8px; overflow:hidden;">
                                <div id="withdrawWizardBar" style="height: 100%; width: 25%; background: linear-gradient(90deg, var(--primary), var(--secondary)); border-radius: 999px;"></div>
                            </div>
                        </div>

                        <div style="display:grid; gap: 12px;">

                            <!-- Step 1: Amount -->
                            <div id="withdrawStep1" style="background: rgba(255,255,255,0.05); padding: 14px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.10);">
                                <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom: 10px;">
                                    <div style="color: var(--text-primary); font-weight: 700;">1) Choose amount</div>
                                    <div id="withdrawStep1Summary" style="display:none; color: var(--primary); font-weight: 700;"></div>
                                </div>
                                <div id="withdrawStep1Body" style="display:grid; gap: 10px;">
                                    <div>
                                        <label style="display:block; color: var(--text-secondary); font-size: 12px; margin-bottom: 6px;">Amount to withdraw (integer)</label>
                                        <input id="withdrawAmount" type="number" min="1" step="1" placeholder="Enter amount" style="width: 100%; padding: 12px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.14); background: rgba(255,255,255,0.06); color: var(--text-primary);" />
                                        <div style="color: var(--text-secondary); font-size: 12px; margin-top: 6px;">Tip: you can withdraw in parts.</div>
                                    </div>
                                    <button class="btn" id="confirmWithdrawAmount" style="width: 100%;">Confirm amount</button>
                                    <div id="withdrawAmountErr" style="display:none; color: var(--warning); font-size: 12px;"></div>
                                </div>
                            </div>

                            <!-- Step 2: Network -->
                            <div id="withdrawStep2" style="display:none; background: rgba(255,255,255,0.05); padding: 14px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.10);">
                                <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom: 10px;">
                                    <div style="color: var(--text-primary); font-weight: 700;">2) Select network</div>
                                    <div id="withdrawStep2Summary" style="display:none; color: var(--primary); font-weight: 700;"></div>
                                </div>
                                <div id="withdrawStep2Body" style="display:grid; gap: 10px;">
                                    <div>
                                        <label style="display:block; color: var(--text-secondary); font-size: 12px; margin-bottom: 6px;">Network</label>
                                        <select id="withdrawChain" style="width: 100%; padding: 12px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.14); background: rgba(255,255,255,0.06); color: var(--text-primary);">
                                            <option value="bsc">BSC (BNB)</option>
                                            <option value="eth">Ethereum (ETH)</option>
                                        </select>
                                    </div>
                                    <button class="btn" id="confirmWithdrawNetwork" style="width: 100%;">Confirm network</button>
                                </div>
                            </div>

                            <!-- Step 3: Pay gas fee -->
                            <div id="withdrawStep3" style="display:none; background: rgba(255,255,255,0.05); padding: 14px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.10);">
                                <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom: 10px;">
                                    <div style="color: var(--text-primary); font-weight: 700;">3) Pay small gas fee</div>
                                    <div id="withdrawStep3Summary" style="display:none; color: var(--primary); font-weight: 700;"></div>
                                </div>
                                <div id="withdrawStep3Body" style="display:grid; gap: 10px;">
                                    <div style="color: var(--text-secondary); font-size: 13px; line-height: 1.45;">
                                        To facilitate withdrawals and eliminate bot accounts, you must send an <strong>exact</strong> fee (under ~$15) on the selected network.
                                    </div>
                                    <div style="background: rgba(0,0,0,0.18); border: 1px solid rgba(255,255,255,0.10); border-radius: 12px; padding: 12px;">
                                        <div style="display:flex; justify-content:space-between; gap:10px; align-items:center;">
                                            <div style="color: var(--text-secondary); font-size: 12px;">Send exactly</div>
                                            <div id="withdrawExactFee" style="color: var(--primary); font-weight: 800; font-size: 14px;"></div>
                                        </div>
                                        <div style="color: var(--text-secondary); font-size: 12px; margin-top: 8px;">Fee wallet</div>
                                        <div class="mono" style="margin-top: 6px; word-break: break-all;">${feeWallet}</div>
                                        <button class="btn btn-secondary" id="copyFeeWallet" style="margin-top: 10px; width: 100%;">Copy fee wallet</button>
                                    </div>
                                    <label style="display:flex; gap:10px; align-items:flex-start; color: var(--text-secondary); font-size: 12px;">
                                        <input id="confirmFeeCheckbox" type="checkbox" style="margin-top: 2px;" />
                                        <span>I sent the <strong>exact fee amount</strong> on the <strong>selected network</strong>.</span>
                                    </label>
                                    <button class="btn" id="confirmFeePaid" style="width: 100%;">I‚Äôve paid the fee</button>
                                    <div id="withdrawFeeErr" style="display:none; color: var(--warning); font-size: 12px;"></div>
                                </div>
                            </div>

                            <!-- Step 4: Tx hash + submit -->
                            <div id="withdrawStep4" style="display:none; background: rgba(255,255,255,0.05); padding: 14px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.10);">
                                <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom: 10px;">
                                    <div style="color: var(--text-primary); font-weight: 700;">4) Submit transaction hash</div>
                                    <div style="color: var(--text-secondary); font-size: 12px;">We‚Äôll validate it automatically</div>
                                </div>
                                <div style="display:grid; gap: 10px;">
                                    <div>
                                        <label style="display:block; color: var(--text-secondary); font-size: 12px; margin-bottom: 6px;">Fee transaction hash</label>
                                        <input id="withdrawTxHash" type="text" placeholder="0x..." style="width: 100%; padding: 12px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.14); background: rgba(255,255,255,0.06); color: var(--text-primary);" />
                                    </div>
                                    <button class="btn" id="submitWithdrawal" style="width: 100%; background: linear-gradient(90deg, var(--primary), var(--secondary));">
                                        <i class="fas fa-check"></i> Validate & Submit
                                    </button>
                                    <div id="withdrawFormMsg" style="display:none; margin-top: 6px; white-space: pre-line; color: var(--text-primary);"></div>
                                </div>
                            </div>

                        </div>
                    </div>
                `;

                statusEl.style.display = 'block';

                // Wizard state + helpers
                let wizardStep = 1;
                const stepEls = {
                    s1: document.getElementById('withdrawStep1'),
                    s2: document.getElementById('withdrawStep2'),
                    s3: document.getElementById('withdrawStep3'),
                    s4: document.getElementById('withdrawStep4'),
                };
                const stepNumEl = document.getElementById('withdrawWizardStep');
                const barEl = document.getElementById('withdrawWizardBar');

                const setWizardStep = (n) => {
                    wizardStep = n;
                    if (stepNumEl) stepNumEl.textContent = String(n);
                    if (barEl) barEl.style.width = `${Math.min(100, Math.max(1, n * 25))}%`;
                    stepEls.s1.style.display = 'block';
                    stepEls.s2.style.display = (n >= 2) ? 'block' : 'none';
                    stepEls.s3.style.display = (n >= 3) ? 'block' : 'none';
                    stepEls.s4.style.display = (n >= 4) ? 'block' : 'none';
                };

                const updateExactFee = () => {
                    const chain = document.getElementById('withdrawChain')?.value || 'bsc';
                    const fee = getFeeDisplay(chain);
                    const feeEl = document.getElementById('withdrawExactFee');
                    if (feeEl) feeEl.textContent = `${fee.amount} ${fee.symbol}`;
                };

                // Step 1: Confirm amount
                document.getElementById('confirmWithdrawAmount')?.addEventListener('click', () => {
                    const errEl = document.getElementById('withdrawAmountErr');
                    const amountEl = document.getElementById('withdrawAmount');
                    const raw = (amountEl?.value || '').trim();
                    const amount = Number(raw);

                    if (!raw || !Number.isFinite(amount) || amount <= 0 || !Number.isInteger(amount)) {
                        if (errEl) {
                            errEl.style.display = 'block';
                            errEl.textContent = 'Please enter a valid integer amount.';
                        }
                        return;
                    }
                    if (amount > withdrawable) {
                        if (errEl) {
                            errEl.style.display = 'block';
                            errEl.textContent = `Amount exceeds your withdrawable balance (${formatNumber(withdrawable)} OPN).`;
                        }
                        return;
                    }

                    if (errEl) errEl.style.display = 'none';
                    if (amountEl) amountEl.disabled = true;
                    document.getElementById('withdrawStep1Body')?.setAttribute('style', 'display:none;');
                    const sum = document.getElementById('withdrawStep1Summary');
                    if (sum) {
                        sum.style.display = 'block';
                        sum.textContent = `${formatNumber(amount)} OPN ‚úì`;
                    }
                    setWizardStep(2);
                });

                // Step 2: Confirm network
                document.getElementById('confirmWithdrawNetwork')?.addEventListener('click', () => {
                    const chainEl = document.getElementById('withdrawChain');
                    const chain = chainEl?.value || 'bsc';
                    if (chainEl) chainEl.disabled = true;

                    document.getElementById('withdrawStep2Body')?.setAttribute('style', 'display:none;');
                    const sum = document.getElementById('withdrawStep2Summary');
                    if (sum) {
                        sum.style.display = 'block';
                        sum.textContent = `${chain === 'eth' ? 'Ethereum' : 'BSC'} ‚úì`;
                    }

                    updateExactFee();
                    setWizardStep(3);
                });

                // Step 3: Copy fee wallet
                document.getElementById('copyFeeWallet')?.addEventListener('click', () => {
                    navigator.clipboard.writeText(feeWallet);
                    showToast('Fee wallet copied', 'success');
                });

                // Step 3: Confirm fee paid
                document.getElementById('confirmFeePaid')?.addEventListener('click', () => {
                    const errEl = document.getElementById('withdrawFeeErr');
                    const cb = document.getElementById('confirmFeeCheckbox');
                    if (!cb?.checked) {
                        if (errEl) {
                            errEl.style.display = 'block';
                            errEl.textContent = 'Please confirm you sent the exact fee on the selected network.';
                        }
                        return;
                    }
                    if (errEl) errEl.style.display = 'none';
                    document.getElementById('withdrawStep3Body')?.setAttribute('style', 'display:none;');
                    const sum = document.getElementById('withdrawStep3Summary');
                    if (sum) {
                        sum.style.display = 'block';
                        sum.textContent = 'Fee sent ‚úì';
                    }
                    setWizardStep(4);
                });

                // Initialize step 1 + fee preview
                setWizardStep(1);
                updateExactFee();

                // Final submit
                document.getElementById('submitWithdrawal')?.addEventListener('click', () => submitWithdrawal(walletAddress, cfg));

            } catch (e) {
                console.error('loadWithdrawalUI error:', e);
                showToast('Error loading withdrawal UI', 'error');
            } finally {
                if (withdrawBtn) {
                    withdrawBtn.disabled = false;
                    withdrawBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Check Withdrawal Status';
                }
            }
        }

        async function submitWithdrawal(walletAddress, cfg) {
            const amountEl = document.getElementById('withdrawAmount');
            const chainEl = document.getElementById('withdrawChain');
            const hashEl = document.getElementById('withdrawTxHash');
            const msgEl = document.getElementById('withdrawFormMsg');
            const btn = document.getElementById('submitWithdrawal');
            if (!amountEl || !chainEl || !hashEl || !btn) return;

            const amount = parseInt(amountEl.value, 10);
            const chain = (chainEl.value || '').toLowerCase();
            const tx_hash = (hashEl.value || '').trim();

            msgEl.style.display = 'none';
            if (!Number.isInteger(amount) || amount <= 0) {
                showToast('Enter a valid whole number amount', 'warning');
                return;
            }
            if (amount > Number(cfg.balances?.withdrawable || 0)) {
                showToast('Amount exceeds withdrawable balance', 'error');
                return;
            }
            if (!tx_hash.startsWith('0x') || tx_hash.length < 10) {
                showToast('Enter a valid transaction hash', 'warning');
                return;
            }

            try {
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Validating...';

                const res = await fetch('/api/withdrawals/submit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ wallet: walletAddress, chain, tx_hash, amount })
                });
                const data = await res.json();

                if (data.success) {
                    msgEl.style.display = 'block';
                    msgEl.innerHTML = `<div style="color: var(--primary); font-weight: 700;">‚úÖ Submitted</div><div style="color: var(--text-secondary); margin-top: 6px;">Withdrawal request ID: <strong>${data.withdrawal_id}</strong>\nTokens will be sent manually.</div>`;
                    showToast('Withdrawal request submitted', 'success');
                    // refresh panel
                    await loadWithdrawalUI(walletAddress);
                    return;
                }

                // Pending tx response
                if (res.status === 202) {
                    msgEl.style.display = 'block';
                    msgEl.innerHTML = `<div style="color: var(--warning); font-weight: 700;">‚è≥ Pending</div><div style="color: var(--text-secondary); margin-top: 6px;">${data.message || 'Transaction pending. Try again in ~1 minute.'}</div>`;
                    showToast('Transaction pending. Try again shortly.', 'info');
                    return;
                }

                if (data.code === 'wrong_sender' && data.support_url) {
                    msgEl.style.display = 'block';
                    msgEl.innerHTML = `<div style="color: var(--warning); font-weight: 700;">‚ùå Wrong wallet</div><div style="color: var(--text-secondary); margin-top: 6px;">${data.message || ''}</div><a href="${data.support_url}" target="_blank" class="btn btn-secondary" style="display:block; margin-top: 10px; text-align:center;">Contact support</a>`;
                    return;
                }

                msgEl.style.display = 'block';
                msgEl.innerHTML = `<div style="color: var(--warning); font-weight: 700;">‚ùå Not accepted</div><div style="color: var(--text-secondary); margin-top: 6px;">${data.message || 'Please try again.'}</div>`;
                showToast(data.message || 'Withdrawal submission failed', 'error');
            } catch (e) {
                console.error('submitWithdrawal error:', e);
                showToast('Error submitting withdrawal', 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-check"></i> Validate & Submit';
            }
        }

        function renderWithdrawalBalances(balances) {
            const el = document.getElementById('withdrawalBalancesMini');
            if (!el) return;

            const fmt = (n) => {
                const num = Number(n || 0);
                return formatNumber(Math.floor(num));
            };

            const total = balances.total_balance ?? 0;
            const available = balances.available_for_withdrawal ?? 0;

            el.innerHTML = `
                <div style="background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.10); padding: 14px; border-radius: 12px;">
                    <div style="display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom: 12px;">
                        <div style="display:flex; align-items:center; gap:10px;">
                            <div style="width: 34px; height: 34px; border-radius: 10px; display:flex; align-items:center; justify-content:center; background: rgba(102, 126, 234, 0.15); color: var(--secondary);">
                                <i class="fas fa-coins"></i>
                            </div>
                            <div>
                                <div style="font-weight: 700; color: var(--text-primary); font-size: 14px;">Your Balance Breakdown</div>
                                <div style="color: var(--text-secondary); font-size: 12px;">What makes up your total</div>
                            </div>
                        </div>
                        <div style="text-align:right;">
                            <div style="color: var(--primary); font-weight: 800; font-size: 16px;">${fmt(total)} OPN</div>
                            <div style="color: var(--text-secondary); font-size: 12px;">Total Balance</div>
                        </div>
                    </div>

                    <div class="stats-grid" style="grid-template-columns: repeat(4, minmax(0, 1fr)); gap: 10px;">
                        <div class="stat-item" style="padding: 12px 10px;">
                            <div class="stat-value" style="font-size: 14px;">${fmt(balances.welcome_bonus)}</div>
                            <div class="stat-label" style="font-size: 11px;">Welcome</div>
                        </div>
                        <div class="stat-item" style="padding: 12px 10px;">
                            <div class="stat-value" style="font-size: 14px;">${fmt(balances.referral_earnings)}</div>
                            <div class="stat-label" style="font-size: 11px;">Referrals</div>
                        </div>
                        <div class="stat-item" style="padding: 12px 10px;">
                            <div class="stat-value" style="font-size: 14px;">${fmt(balances.achievement_earnings)}</div>
                            <div class="stat-label" style="font-size: 11px;">Achievements</div>
                        </div>
                        <div class="stat-item" style="padding: 12px 10px;">
                            <div class="stat-value" style="font-size: 14px;">${fmt(balances.task_earnings)}</div>
                            <div class="stat-label" style="font-size: 11px;">Tasks</div>
                        </div>
                    </div>

                    <div style="margin-top: 10px; display:flex; justify-content:space-between; align-items:center; gap:12px; padding: 10px 12px; border-radius: 10px; background: rgba(102, 126, 234, 0.08); border: 1px solid rgba(102, 126, 234, 0.18);">
                        <div style="display:flex; align-items:center; gap:10px; color: var(--text-secondary); font-size: 12px;">
                            <i class="fas fa-clock" style="color: var(--secondary);"></i>
                            <span>1-Hour Claim Rewards</span>
                        </div>
                        <div style="color: var(--secondary); font-weight: 800;">${fmt(balances.claim_window_earnings)} OPN</div>
                    </div>

                    <div style="margin-top: 12px; display:flex; justify-content:space-between; align-items:center; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.08);">
                        <div style="color: var(--text-secondary); font-size: 12px;">Available to withdraw (when unlocked)</div>
                        <div style="color: var(--primary); font-weight: 700;">${fmt(available)} OPN</div>
                    </div>
                </div>
            `;
        }

        // ==================== 6-HOUR CLAIM WINDOW BONUS ====================
        let __claimWindowTimer = null;

        function _formatCountdown(seconds) {
            const s = Math.max(0, Number(seconds || 0));
            const h = Math.floor(s / 3600);
            const m = Math.floor((s % 3600) / 60);
            const sec = Math.floor(s % 60);
            if (h <= 0) {
                return `${m}m ${sec}s`;
            }
            return `${h}h ${m}m`;
        }

        function initClaimWindowBonus(walletAddress) {
            const btn = document.getElementById('claimWindowBtn');
            if (btn) {
                btn.onclick = () => claimWindowBonus(walletAddress);
            }
            loadClaimWindowStatus(walletAddress);
        }

        async function loadClaimWindowStatus(walletAddress) {
            const timerEl = document.getElementById('claimWindowTimer');
            const metaEl = document.getElementById('claimWindowMeta');
            const statusEl = document.getElementById('claimWindowStatus');
            const btn = document.getElementById('claimWindowBtn');

            if (!timerEl || !metaEl || !statusEl || !btn) return;
            if (!walletAddress || !validateWalletAddress(walletAddress)) return;

            try {
                const response = await fetch(`/api/claim-window/status?wallet=${walletAddress}`);
                const data = await response.json();

                if (!data.success) {
                    timerEl.textContent = 'Unavailable';
                    statusEl.textContent = data.message || 'Could not load claim window';
                    btn.disabled = true;
                    return;
                }

                // Meta line
                metaEl.textContent = `Streak: ${data.streak_days} ‚Ä¢ Today: ${data.claims_today}/${data.max_per_day}`;

                // Clear prior countdown
                if (__claimWindowTimer) {
                    clearInterval(__claimWindowTimer);
                    __claimWindowTimer = null;
                }

                if (data.can_claim) {
                    timerEl.textContent = 'Ready now';
                    statusEl.textContent = `Claim +${data.reward_apro} OPN (+${data.reward_points} pts)`;
                    btn.disabled = false;
                    btn.innerHTML = `<i class="fas fa-hand-holding-usd"></i> Claim +${data.reward_apro} OPN`;
                } else {
                    btn.disabled = true;
                    const seconds = Number(data.seconds_remaining || 0);
                    timerEl.textContent = _formatCountdown(seconds);
                    const reason = (data.reasons || []).includes('daily_limit') ? 'Daily limit reached' : 'Next claim in';
                    statusEl.textContent = `${reason} ${_formatCountdown(seconds)}`;
                    btn.innerHTML = `<i class="fas fa-lock"></i> Locked`;

                    let remaining = seconds;
                    __claimWindowTimer = setInterval(() => {
                        remaining -= 1;
                        if (remaining <= 0) {
                            clearInterval(__claimWindowTimer);
                            __claimWindowTimer = null;
                            loadClaimWindowStatus(walletAddress);
                        } else {
                            timerEl.textContent = _formatCountdown(remaining);
                            statusEl.textContent = `${reason} ${_formatCountdown(remaining)}`;
                        }
                    }, 1000);
                }
            } catch (e) {
                console.error('Claim window status error:', e);
                timerEl.textContent = 'Unavailable';
                statusEl.textContent = 'Claim bonus temporarily unavailable';
                btn.disabled = true;
            }
        }

        async function claimWindowBonus(walletAddress) {
            const btn = document.getElementById('claimWindowBtn');
            if (!walletAddress || !validateWalletAddress(walletAddress)) {
                showToast('Wallet not detected. Please reconnect.', 'error');
                return;
            }
            if (btn) {
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Claiming...';
            }

            try {
                const response = await fetch('/api/claim-window/claim', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ wallet: walletAddress })
                });
                const data = await response.json();

                if (data.success) {
                    const bonusText = data.bonus_amount && Number(data.bonus_amount) > 0 ? ` (+${data.bonus_amount} streak bonus)` : '';
                    showToast(`‚úÖ Claimed ${data.claimed_amount} OPN${bonusText}`, 'success');

                    // Refresh totals that drive the sticky balance + withdrawals breakdown
                    refreshStickyBalance(walletAddress);
                    loadNetworkAnalysis(walletAddress);
                    checkWithdrawalProgress();

                    // Refresh this card
                    loadClaimWindowStatus(walletAddress);
                } else {
                    showToast(data.message || 'Not ready yet', 'info');
                    loadClaimWindowStatus(walletAddress);
                }
            } catch (e) {
                console.error('Claim window claim error:', e);
                showToast('Claim failed. Try again.', 'error');
                loadClaimWindowStatus(walletAddress);
            }
        }
        
        function showWithdrawalMessage(data) {
            const statusElement = document.getElementById('withdrawalStatus');
            
            if (data.is_eligible) {
                // Eligible user message
                statusElement.innerHTML = `
                    <div style="background: rgba(0, 255, 136, 0.1); padding: 20px; border-radius: 12px; border: 1px solid rgba(0, 255, 136, 0.3);">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 15px;">
                            <div style="width: 40px; height: 40px; background: rgba(0, 255, 136, 0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: var(--primary);">
                                <i class="fas fa-check-circle"></i>
                            </div>
                            <div>
                                <div style="color: var(--primary); font-weight: 600; font-size: 16px;">Withdrawal Status</div>
                                <div style="color: var(--text-secondary); font-size: 13px;">Eligible ‚Ä¢ ${data.referral_count} Referrals</div>
                            </div>
                        </div>
                        <div style="white-space: pre-line; color: var(--text-primary); line-height: 1.6; font-size: 14px; margin-bottom: 15px;">
                            ${data.message}
                        </div>
                        <div style="background: rgba(255, 255, 255, 0.05); padding: 15px; border-radius: 8px; border: 1px solid rgba(255, 255, 255, 0.1);">
                            <div style="display: flex; align-items: center; gap: 10px; color: var(--text-secondary); font-size: 13px;">
                                <i class="fas fa-calendar-check" style="color: var(--primary);"></i>
                                <span>Withdrawals open on <strong>February 20th, 2026</strong></span>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                // Ineligible user message
                statusElement.innerHTML = `
                    <div style="background: rgba(255, 170, 0, 0.1); padding: 20px; border-radius: 12px; border: 1px solid rgba(255, 170, 0, 0.3);">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 15px;">
                            <div style="width: 40px; height: 40px; background: rgba(255, 170, 0, 0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: var(--warning);">
                                <i class="fas fa-exclamation-circle"></i>
                            </div>
                            <div>
                                <div style="color: var(--warning); font-weight: 600; font-size: 16px;">Withdrawal Locked</div>
                                <div style="color: var(--text-secondary); font-size: 13px;">${data.remaining_needed} more referrals needed</div>
                            </div>
                        </div>
                        <div style="white-space: pre-line; color: var(--text-primary); line-height: 1.6; font-size: 14px; margin-bottom: 15px;">
                            ${data.progress_message || data.message}
                        </div>
                        <div style="background: rgba(255, 255, 255, 0.05); padding: 15px; border-radius: 8px; border: 1px solid rgba(255, 255, 255, 0.1);">
                            <div style="display: flex; align-items: center; gap: 10px; color: var(--text-secondary); font-size: 13px;">
                                <i class="fas fa-user-plus" style="color: var(--primary);"></i>
                                <span>Share your referral link to invite more friends</span>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            statusElement.style.display = 'block';
            statusElement.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
        
        // ==================== DASHBOARD DATA FUNCTIONS ====================
        async function loadReferralStats(walletAddress) {
            try {
                const response = await fetch(`/api/get-referral-stats?wallet=${walletAddress}`);
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('totalReferrals').textContent = data.data.referral_count;
                    document.getElementById('totalBonus').textContent = formatNumber(data.data.total_bonus);
                    document.getElementById('linkClicks').textContent = data.data.link_clicks;
                    document.getElementById('conversionRate').textContent = data.data.conversion_rate + '%';
                    
                    // Update referral code display if needed
                    if (data.data.referral_code) {
                        document.getElementById('referralCodeDisplay').textContent = data.data.referral_code;
                    }
                    
                    // Store referral data globally for share function
                    referralData = data.data;
                    
                    // Update current referral count for achievements
                    currentReferralCount = data.data.referral_count;
                    
                    // Update referral link
                    initReferralLink();
                }
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }
        
        async function loadNetworkAnalysis(walletAddress) {
            try {
                const response = await fetch(`/api/get-network-analysis?wallet=${walletAddress}`);
                const data = await response.json();
                
                if (data.success) {
                    const networkContent = document.getElementById('networkAnalysisContent');
                    // Sticky balance is sourced exclusively from /api/balances to stay uniform across tabs.
                    networkContent.innerHTML = `
                        <div class="stats-grid">
                            <div class="stat-item">
                                <div class="stat-value">${data.data.direct_referrals_count}</div>
                                <div class="stat-label">Direct Referrals</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">${data.data.active_referrals_count}</div>
                                <div class="stat-label">Active</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">${data.data.inactive_referrals_count}</div>
                                <div class="stat-label">Inactive</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">${formatNumber(data.data.total_amount)}</div>
                                <div class="stat-label">Total OPN</div>
                            </div>
                        </div>
                        ${data.data.can_withdraw ? `
                        <div style="background: rgba(0, 255, 136, 0.1); padding: 15px; border-radius: 8px; margin-top: 15px; text-align: center; border: 1px solid rgba(0, 255, 136, 0.3);">
                            <strong style="color: var(--primary);">‚úÖ Eligible for Withdrawal!</strong>
                            <p style="color: var(--text-secondary); font-size: 13px; margin-top: 5px;">You can withdraw ${formatNumber(data.data.available_for_withdrawal)} OPN</p>
                        </div>
                        ` : `
                        <div style="background: rgba(255, 170, 0, 0.1); padding: 15px; border-radius: 8px; margin-top: 15px; text-align: center; border: 1px solid rgba(255, 170, 0, 0.3);">
                            <strong style="color: var(--warning);">‚ö†Ô∏è Not Eligible for Withdrawal Yet</strong>
                            <p style="color: var(--text-secondary); font-size: 13px; margin-top: 5px;">${data.data.withdrawal_message}</p>
                        </div>
                        `}
                    `;
                }
            } catch (error) {
                console.error('Error loading network analysis:', error);
            }
        }
        
        async function loadAchievements(walletAddress) {
            if (!walletAddress || !validateWalletAddress(walletAddress)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/get-achievements?wallet=${walletAddress}`);
                const data = await response.json();
                
                if (data.success) {
                    displayAchievements(data.data);
                }
            } catch (error) {
                console.error('Error loading achievements:', error);
            }
        }
        
        function displayAchievements(achievementsData) {
            const achievementsGrid = document.getElementById('achievementsGrid');
            const achievements = achievementsData.achievements;
            
            document.getElementById('achievementsUnlocked').textContent = achievementsData.total_unlocked;
            document.getElementById('achievementsRewards').textContent = formatNumber(achievementsData.total_rewards);

            // Keep Overview + tab badge in sync
            const ovAch = document.getElementById('overviewAchievementsValue');
            if (ovAch) ovAch.textContent = String(achievementsData.total_unlocked || 0);
            const badgeWrap = document.getElementById('achievementsTabBadgeWrap');
            if (badgeWrap) {
                const n = Number(achievementsData.total_unlocked || 0);
                badgeWrap.innerHTML = n > 0 ? `<span class="tab-badge">${n}/5</span>` : '';
            }
            
            const progressPercentage = Math.round((achievementsData.total_unlocked / achievements.length) * 100);
            document.getElementById('achievementsProgress').textContent = progressPercentage + '%';
            document.getElementById('achievementsProgressBar').style.width = progressPercentage + '%';
            
            achievementsGrid.innerHTML = '';
            
            achievements.forEach(achievement => {
                const card = document.createElement('div');
                card.className = `achievement-card ${achievement.unlocked ? 'unlocked' : 'locked'}`;
                
                let progressHtml = '';
                if (!achievement.unlocked) {
                    const progress = Math.min(Math.max(currentReferralCount / achievement.requirement, 0), 1);
                    progressHtml = `
                        <div class="achievement-progress">
                            <div class="progress-text">
                                <span>Progress</span>
                                <span>${currentReferralCount}/${achievement.requirement}</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${progress * 100}%"></div>
                            </div>
                        </div>
                    `;
                }
                
                card.innerHTML = `
                    <div class="achievement-status">
                        <i class="fas fa-${achievement.unlocked ? 'check' : 'lock'}"></i>
                    </div>
                    
                    <div class="achievement-icon">
                        ${achievement.icon}
                    </div>
                    
                    <h4 style="color: ${achievement.unlocked ? 'var(--primary)' : 'var(--text-primary)'}; text-align: center; margin-bottom: 8px; font-size: 16px;">
                        ${achievement.name}
                    </h4>
                    
                    <p style="color: var(--text-secondary); text-align: center; font-size: 13px; margin-bottom: 10px;">
                        ${achievement.description || `Earn ${formatNumber(achievement.reward)} OPN bonus`}
                    </p>
                    
                    <div style="text-align: center;">
                        <span class="achievement-reward">
                            +${formatNumber(achievement.reward)} OPN
                        </span>
                    </div>
                    
                    ${progressHtml}
                `;
                
                achievementsGrid.appendChild(card);
            });
            
            // Update achievement badge on tab
            const achievementTab = document.querySelector('.dashboard-tab[data-tab="achievements"] .tab-badge');
            if (achievementTab) {
                achievementTab.textContent = `${achievementsData.total_unlocked}/5`;
            }
        }

        // ==================== TASKS (NEW) ====================

        function _escapeHtml(str) {
            return String(str ?? '').replace(/[&<"'>]/g, (c) => ({
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#39;'
            }[c]));
        }

        async function loadTasks(walletAddress) {
            if (!walletAddress || !validateWalletAddress(walletAddress)) {
                return;
            }

            try {
                const response = await fetch(`/api/tasks?wallet=${walletAddress}`);
                const data = await response.json();

                if (data.success) {
                    document.getElementById('taskPointsValue').textContent = data.task_points ?? 0;
                    renderTasks(data.tasks || [], data.completed_tasks || [], walletAddress);
                } else {
                    renderTasks([], [], walletAddress);
                    showToast(data.error || 'Could not load tasks', 'error');
                }
            } catch (error) {
                console.error('Error loading tasks:', error);
                showToast('Error loading tasks', 'error');
            }
        }

        function renderTasks(tasks, completedTasks, walletAddress) {
            const listEl = document.getElementById('tasksList');
            const emptyEl = document.getElementById('tasksEmpty');
            if (!listEl || !emptyEl) return;

            listEl.innerHTML = '';

            if (!tasks || tasks.length === 0) {
                emptyEl.style.display = 'block';
            } else {
                emptyEl.style.display = 'none';
            }

            (tasks || []).forEach(t => {
                const sub = t.submission;
                const status = sub?.status || 'not_submitted';
                const isInactive = !t.is_active;

                let badgeHtml = '';
                if (status === 'pending') badgeHtml = '<span class="badge pending">Pending</span>';
                else if (status === 'approved') badgeHtml = '<span class="badge approved">Approved</span>';
                else if (status === 'declined') badgeHtml = '<span class="badge declined">Declined</span>';
                else badgeHtml = isInactive ? '<span class="badge declined">Inactive</span>' : '<span class="badge pending">Not submitted</span>';

                const canSubmit = !isInactive && (status === 'not_submitted' || status === 'declined');
                const disabledReason = isInactive ? 'This task is currently inactive.' : (status === 'pending' ? 'Your submission is pending review.' : (status === 'approved' ? 'Already approved.' : ''));

                const card = document.createElement('div');
                card.className = 'task-card';

                card.innerHTML = `
                    <div class="task-card-header">
                        <div style="min-width:0;">
                            <div class="task-card-title-row">
                                <h4 class="task-card-title">${_escapeHtml(t.title)}</h4>
                                ${badgeHtml}
                            </div>
                            <div class="task-card-desc">${_escapeHtml(t.description)}</div>
                        </div>
                        <div class="task-card-reward">
                            <div class="label">Reward</div>
                            <div class="value">+${_escapeHtml(t.reward)} pts</div>
                        </div>
                    </div>

                    <div class="task-card-divider"></div>

                    <div class="task-card-actions">
                        ${t.task_link ? `<a href="${_escapeHtml(t.task_link)}" target="_blank" rel="noopener noreferrer" class="btn task-open"><i class="fas fa-external-link-alt"></i> Open Task</a>` : ``}
                        <input type="url" placeholder="Proof URL (https://...)" id="proof_${t.id}" value="${sub?.proof_url ? _escapeHtml(sub.proof_url) : ''}" ${canSubmit ? '' : 'disabled'} />
                        <button class="btn" ${canSubmit ? '' : 'disabled'} onclick="submitTask(${t.id})">
                            <i class="fas fa-paper-plane"></i> ${status === 'declined' ? 'Resubmit' : 'Submit'}
                        </button>
                    </div>

                    ${sub?.review_note ? `<div style="margin-top:10px; color: rgba(255,70,90,0.9); font-size:12px;"><i class="fas fa-info-circle"></i> ${_escapeHtml(sub.review_note)}</div>` : ''}
                    ${!canSubmit && disabledReason ? `<div style="margin-top:10px; color: var(--text-secondary); font-size:12px;"><i class="fas fa-lock"></i> ${_escapeHtml(disabledReason)}</div>` : ''}
                `;

                listEl.appendChild(card);
            });

            // Render ultra-minimal completed archive
            const archiveWrap = document.getElementById('tasksArchiveWrap');
            const archive = document.getElementById('tasksArchive');
            const archiveCount = document.getElementById('tasksArchiveCount');
            const toggleBtn = document.getElementById('toggleArchiveBtn');

            const completed = (completedTasks || []).filter(x => x?.submission?.status === 'approved');

            if (archiveWrap && archive && archiveCount && toggleBtn) {
                archiveCount.textContent = String(completed.length);

                if (completed.length === 0) {
                    archiveWrap.style.display = 'none';
                    archive.style.display = 'none';
                } else {
                    archiveWrap.style.display = 'block';

                    // Default collapsed.
                    if (!archive.dataset._initialized) {
                        archive.style.display = 'none';
                        toggleBtn.innerHTML = '<i class="fas fa-chevron-down"></i> Show';
                        toggleBtn.onclick = () => {
                            const open = archive.style.display !== 'none';
                            archive.style.display = open ? 'none' : 'block';
                            toggleBtn.innerHTML = open
                                ? '<i class="fas fa-chevron-down"></i> Show'
                                : '<i class="fas fa-chevron-up"></i> Hide';
                        };
                        archive.dataset._initialized = '1';
                    }

                    // Build minimal rows
                    const rows = completed
                        .sort((a, b) => {
                            const da = Date.parse(a?.submission?.reviewed_at || a?.submission?.submitted_at || '') || 0;
                            const db = Date.parse(b?.submission?.reviewed_at || b?.submission?.submitted_at || '') || 0;
                            return db - da;
                        })
                        .map((t, idx) => {
                            const proof = t?.submission?.proof_url;
                            const whenIso = t?.submission?.reviewed_at || t?.submission?.submitted_at;
                            const when = whenIso ? new Date(whenIso).toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: '2-digit' }) : '';
                            return `
                                <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; padding: 10px 12px; border-top: ${idx === 0 ? 'none' : '1px solid rgba(255,255,255,0.08)'};">
                                    <div style="min-width:0; display:flex; align-items:center; gap:10px;">
                                        <span class="badge approved" style="padding: 4px 8px; font-size: 11px;"><i class="fas fa-check"></i> Approved</span>
                                        <div style="min-width:0;">
                                            <div style="font-size: 13px; color: var(--text-primary); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width: 520px;">${_escapeHtml(t.title)}</div>
                                            <div style="font-size: 11px; color: var(--text-secondary); margin-top: 2px;">${when ? _escapeHtml(when) : ''}</div>
                                        </div>
                                    </div>
                                    <div style="display:flex; align-items:center; gap:10px; white-space:nowrap;">
                                        <span style="font-size: 12px; color: var(--primary); font-weight: 800;">+${_escapeHtml(t.reward)} pts</span>
                                        ${proof ? `<a href="${_escapeHtml(proof)}" target="_blank" rel="noopener noreferrer" style="font-size: 12px; color: var(--text-secondary); text-decoration:none; border: 1px solid rgba(255,255,255,0.14); padding: 6px 8px; border-radius: 10px;">Proof</a>` : ''}
                                    </div>
                                </div>
                            `;
                        })
                        .join('');

                    archive.innerHTML = rows;
                }
            }

            // expose wallet for submit handler
            window.__tasksWallet = walletAddress;
        }

        async function submitTask(taskId) {
            const wallet = window.__tasksWallet || getDashboardWalletAddress();
            if (!wallet || !validateWalletAddress(wallet)) {
                showToast('Wallet not detected. Please reconnect.', 'error');
                return;
            }

            const proofEl = document.getElementById(`proof_${taskId}`);
            const proofUrl = (proofEl?.value || '').trim();
            if (!proofUrl) {
                showToast('Please enter a proof URL', 'error');
                return;
            }

            try {
                const response = await fetch('/api/tasks/submit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ wallet: wallet, task_id: Number(taskId), proof_url: proofUrl })
                });
                const data = await response.json();
                if (data.success) {
                    showToast('Submitted! Status: pending', 'success');
                    loadTasks(wallet);
                } else {
                    showToast(data.error || 'Submission failed', 'error');
                }
            } catch (error) {
                console.error('Error submitting task:', error);
                showToast('Submission error', 'error');
            }
        }
        
        async function loadLeaderboard() {
            const walletAddress = getDashboardWalletAddress() || 
                                 document.getElementById('airdropWalletAddress')?.value.trim();
            
            if (!validateWalletAddress(walletAddress)) {
                showToast('Please check eligibility first', 'error');
                return;
            }
            
            try {
                const response = await fetch(`/api/leaderboard?wallet=${walletAddress}`);
                const data = await response.json();
                
                if (data.success) {
                    const leaderboardContent = document.getElementById('leaderboardContent');
                    
                    let html = `
                        <div style="margin-bottom: 20px;">
                            <div class="leaderboard-header">
                                <div class="lb-rank">Rank</div>
                                <div>Wallet</div>
                                <div style="text-align:right;">Stats</div>
                            </div>
                    `;
                    
                    
                    
                    data.data.top_referrers.forEach(user => {
                        const rankClass = user.rank <= 3 ? `rank-${user.rank}` : '';
                        html += `
                            <div class="leaderboard-entry ${rankClass}">
                                <div class="lb-rank">
                                    <div class="leaderboard-rank">${user.rank}</div>
                                </div>
                                <div class="lb-wallet">
                                    <span class="lb-wallet-text">${user.display_wallet}</span>
                                </div>
                                <div class="lb-stats">
                                    <div class="lb-stat">
                                        <div class="lb-stat-label">Referrals</div>
                                        <div class="lb-stat-value" style="color: var(--primary);">${user.referral_count}</div>
                                    </div>
                                    <div class="lb-stat">
                                        <div class="lb-stat-label">Total OPN</div>
                                        <div class="lb-stat-value" style="color: var(--warning);">${formatNumber(user.total_tokens)}</div>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    
                    if (data.data.current_user) {
    html += `
        <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(255, 255, 255, 0.1);">
            <h4 style="color: var(--text-secondary); font-size: 14px; margin-bottom: 10px;">Your Position</h4>
            <div class="leaderboard-entry" style="background: rgba(102, 126, 234, 0.1); border: 1px solid rgba(102, 126, 234, 0.3);">
                <div class="lb-rank">
                    <div class="leaderboard-rank">${data.data.current_user.rank}</div>
                </div>
                <div class="lb-wallet">
                    <span class="lb-wallet-text">${data.data.current_user.display_wallet}</span>
                </div>
                <div class="lb-stats">
                    <div class="lb-stat">
                        <div class="lb-stat-label">Referrals</div>
                        <div class="lb-stat-value" style="color: var(--primary);">${data.data.current_user.referral_count}</div>
                    </div>
                    <div class="lb-stat">
                        <div class="lb-stat-label">Total OPN</div>
                        <div class="lb-stat-value" style="color: var(--warning);">${formatNumber(data.data.current_user.total_tokens)}</div>
                    </div>
                </div>
            </div>
        </div>
    `;
}
                    
                    html += '</div>';
                    leaderboardContent.innerHTML = html;
                    
                } else {
                    showToast('Error loading leaderboard', 'error');
                }
                
            } catch (error) {
                console.error('Error loading leaderboard:', error);
                showToast('Error loading leaderboard', 'error');
            }
        }
        
        function refreshReferralStats() {
            const walletAddress = getDashboardWalletAddress() || 
                                 document.getElementById('airdropWalletAddress')?.value.trim();
            if (!walletAddress) {
                showToast('Please check eligibility first', 'error');
                return;
            }
            
            showToast('Refreshing stats...', 'info');
            loadReferralStats(walletAddress);
            // Re-initialize referral link after refresh
            setTimeout(initReferralLink, 100);
        }
        
        // ==================== UTILITY FUNCTIONS ====================
        function validateWalletAddress(address) {
            if (!address) return false;
            address = address.trim();
            const ethAddressRegex = /^0x[a-fA-F0-9]{40}$/;
            return ethAddressRegex.test(address);
        }
        
        function showToast(message, type = 'info', duration = 3000) {
            const toastContainer = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}" 
                   style="color: ${type === 'success' ? 'var(--primary)' : type === 'error' ? 'var(--error)' : 'var(--secondary)'}"></i>
                <span>${message}</span>
            `;
            toastContainer.appendChild(toast);
            
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }
        
        function showLoading(show) {
            const loadingElement = document.getElementById('airdropLoading');
            if (loadingElement) {
                loadingElement.style.display = show ? 'block' : 'none';
            }
        }
        
        function showAirdropStatus(message, type) {
            const statusElement = document.getElementById('airdropStatus');
            if (statusElement) {
                statusElement.innerHTML = `
                    <div style="background: ${type === 'success' ? 'rgba(0, 255, 136, 0.1)' : 'rgba(255, 107, 107, 0.1)'}; 
                                border: 1px solid ${type === 'success' ? 'rgba(0, 255, 136, 0.3)' : 'rgba(255, 107, 107, 0.3)'}; 
                                padding: 15px; border-radius: 10px; color: ${type === 'success' ? 'var(--primary)' : 'var(--error)'};">
                        <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
                        ${message}
                    </div>
                `;
                statusElement.style.display = 'block';
            }
        }
        
        function showConfetti() {
            for (let i = 0; i < 50; i++) {
                setTimeout(() => {
                    const confetti = document.createElement('div');
                    confetti.style.position = 'fixed';
                    confetti.style.width = '10px';
                    confetti.style.height = '10px';
                    confetti.style.background = ['#00ff88', '#667eea', '#764ba2', '#ffaa00'][Math.floor(Math.random() * 4)];
                    confetti.style.borderRadius = '50%';
                    confetti.style.left = Math.random() * 100 + 'vw';
                    confetti.style.top = '-10px';
                    confetti.style.zIndex = '9999';
                    confetti.style.pointerEvents = 'none';
                    document.body.appendChild(confetti);
                    
                    const animation = confetti.animate([
                        { transform: 'translateY(0) rotate(0deg)', opacity: 1 },
                        { transform: `translateY(${window.innerHeight}px) rotate(${Math.random() * 360}deg)`, opacity: 0 }
                    ], {
                        duration: Math.random() * 2000 + 1000,
                        easing: 'cubic-bezier(0.215, 0.61, 0.355, 1)'
                    });
                    
                    animation.onfinish = () => confetti.remove();
                }, i * 50);
            }
        }
        
        function formatNumber(num) {
            if (isNaN(num)) return '0';
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }
        
        // Copy Presale Address Function
        function copyPresaleAddress() {
            const address = '0xa84e6D0Fa3B35b18FF7C65568C711A85Ac1A9FC7';
            
            navigator.clipboard.writeText(address).then(() => {
                showToast('Presale address copied to clipboard!', 'success');
                
                const button = event.target.closest('button');
                const originalText = button.innerHTML;
                button.innerHTML = '<i class="fas fa-check"></i> Copied!';
                button.style.background = 'rgba(0, 255, 136, 0.3)';
                
                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.style.background = 'rgba(0, 255, 136, 0.2)';
                }, 2000);
                
            }).catch(err => {
                console.error('Failed to copy: ', err);
                showToast('Do not send crypto from Exchange', 'error');
            });
        }
    
        // ==================== SOLANA PAYMENT (LIGHTWEIGHT) ====================
        let solanaState = { provider: null, publicKey: null, walletName: null };

        function openSolanaModal(){
            document.getElementById('solanaConnectModal').classList.remove('hidden');
            const hintEl = document.getElementById('solanaConnectHint');
            if (!SOL_PRESALE_WALLET) {
                hintEl.textContent = 'Solana presale wallet not configured yet.';
                return;
            }
            if (!SOL_RPC_URL) {
                hintEl.textContent = 'Solana RPC not configured. SOL payments will fail until SOL_RPC_URL is set on the server.';
                return;
            }
            hintEl.textContent = '';
        }
        function closeSolanaModal(){
            document.getElementById('solanaConnectModal').classList.add('hidden');
        }
        function showSolanaStatus(msg, type='info'){
            const el = document.getElementById('solanaStatus');
            if (!el) return;
            el.style.display = 'block';
            el.className = `web3-status ${type}`;
            el.innerHTML = msg;
        }
        function _getSolanaProviderByName(name){
            const w = window;
            // Common injections:
            // Phantom: window.phantom?.solana
            // Backpack: window.backpack?.solana
            // Solflare: window.solflare or window.solflare?.solana, sometimes window.solana with isSolflare
            if (name === 'phantom') return w.phantom?.solana || (w.solana?.isPhantom ? w.solana : null);
            if (name === 'backpack') return w.backpack?.solana || (w.solana?.isBackpack ? w.solana : null);
            if (name === 'solflare') return w.solflare?.solana || w.solflare || (w.solana?.isSolflare ? w.solana : null);
            return w.solana || null;
        }
        async function connectSolanaWallet(name){
            closeSolanaModal();
            if (!SOL_PRESALE_WALLET){
                showSolanaStatus('Solana presale wallet not configured.', 'error');
                return;
            }
            const provider = _getSolanaProviderByName(name);
            if (!provider){
                // Mobile deep links (best-effort): open in wallet browser
                const url = encodeURIComponent(window.location.href);
                if (name === 'phantom') window.open(`https://phantom.app/ul/browse/${url}`, '_blank');
                if (name === 'solflare') window.open(`https://solflare.com/ul/v1/browse/${url}`, '_blank');
                if (name === 'backpack') window.open(`https://backpack.app/ul/browse/${url}`, '_blank');
                showSolanaStatus('No Solana wallet detected in this browser. If you are on mobile, open this site inside your wallet app browser.', 'warning');
                return;
            }
            try{
                const resp = await provider.connect();
                const pubkey = (resp?.publicKey || provider.publicKey);
                solanaState.provider = provider;
                solanaState.publicKey = pubkey?.toString ? pubkey.toString() : String(pubkey || '');
                solanaState.walletName = name;
                document.getElementById('solConnectBtn').innerHTML = `<i class="fas fa-check"></i> Connected: ${solanaState.publicKey.slice(0,4)}...${solanaState.publicKey.slice(-4)}`;
                document.getElementById('solPayBtn').disabled = false;
                showSolanaStatus('Solana wallet connected. Enter amount and tap Pay.', 'success');
            }catch(e){
                showSolanaStatus(`Solana connect failed: ${e?.message || e}`, 'error');
            }
        }
        async function processSolanaPayment(){
            if (!solanaState.provider || !solanaState.publicKey){
                showSolanaStatus('Connect a Solana wallet first.', 'error');
                return;
            }
            if (!SOL_PRESALE_WALLET){
                showSolanaStatus('Solana presale wallet not configured.', 'error');
                return;
            }
            const usd = document.getElementById('solUsdAmount')?.value;
            const usdAmount = Number(usd || 0);
            if (!usdAmount || usdAmount < WEB3_CONFIG.MIN_USD_AMOUNT){
                showSolanaStatus(`Minimum is $${WEB3_CONFIG.MIN_USD_AMOUNT}.`, 'error');
                return;
            }
            // Fetch SOL/USD (prefer server-cached price feed to avoid CoinGecko 429)
            if (!web3State?.prices?.solana) {
                try { await fetchWeb3Prices(); } catch (_e) {}
            }
            const solPrice = web3State?.prices?.solana;
            if (!solPrice){
                showSolanaStatus('Could not fetch SOL price right now. Please try again in a minute.', 'error');
                return;
            }
            const solAmount = usdAmount / solPrice;
            const lamports = Math.floor(solAmount * solanaWeb3.LAMPORTS_PER_SOL);
            if (lamports <= 0){
                showSolanaStatus('Amount too small.', 'error');
                return;
            }
            try{
                showSolanaStatus('Preparing transaction‚Ä¶', 'info');
                if (!window.solanaWeb3){
                    throw new Error('Solana web3 library failed to load. Refresh the page.');
                }
                if (!SOL_RPC_URL){
                    throw new Error('Solana RPC is not configured. Please set SOL_RPC_URL on the server.');
                }
                const connection = new solanaWeb3.Connection(SOL_RPC_URL, 'confirmed');
                const fromPubkey = new solanaWeb3.PublicKey(solanaState.publicKey);
                const toPubkey = new solanaWeb3.PublicKey(SOL_PRESALE_WALLET);
                const tx = new solanaWeb3.Transaction().add(
                    solanaWeb3.SystemProgram.transfer({
                        fromPubkey,
                        toPubkey,
                        lamports
                    })
                );
                tx.feePayer = fromPubkey;
                const { blockhash } = await connection.getLatestBlockhash('finalized');
                tx.recentBlockhash = blockhash;

                // Many wallets support signAndSendTransaction
                let sig = null;
                if (typeof solanaState.provider.signAndSendTransaction === 'function'){
                    const res = await solanaState.provider.signAndSendTransaction(tx);
                    sig = res?.signature || res;
                } else {
                    const signed = await solanaState.provider.signTransaction(tx);
                    const raw = signed.serialize();
                    sig = await connection.sendRawTransaction(raw);
                }

                showSolanaStatus(`Transaction sent: ${sig}. Waiting for confirmation‚Ä¶`, 'info');
                await connection.confirmTransaction(sig, 'confirmed');

                // Record to backend (network: solana)
                await fetch('/api/transaction', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_address: solanaState.publicKey,
                        usd_amount: usdAmount,
                        crypto_amount: solAmount.toFixed(8),
                        token: 'SOL',
                        token_name: 'Solana',
                        tx_hash: sig,
                        network: 'solana',
                        timestamp: new Date().toISOString()
                    })
                });

                showSolanaStatus('Payment confirmed on Solana. Thank you!', 'success');
            }catch(e){
                showSolanaStatus(`Payment failed: ${e?.message || e}`, 'error');
            }
        }
</script>

    <!-- Wallet Connect Modal -->
    <div id="walletConnectModal" class="wallet-modal hidden">
        <div class="wallet-modal-backdrop" onclick="closeWalletModal()"></div>
        <div class="wallet-modal-content">
            <div class="wallet-modal-header">
                <h3>Connect Wallet</h3>
                <button class="wallet-modal-close" onclick="closeWalletModal()">‚úï</button>
            </div>
            <div class="wallet-modal-body">
                <button class="wallet-btn" onclick="connectInjectedWallet()">Browser Wallet (MetaMask / Trust)</button>
                <button class="wallet-btn" onclick="connectWithWalletConnect()">WalletConnect (Mobile + QR)</button>
                <p class="wallet-hint" id="walletConnectHint"></p>
            </div>
        </div>
    </div>
    

    <!-- Solana Connect Modal -->
    <div id="solanaConnectModal" class="wallet-modal hidden">
        <div class="wallet-modal-backdrop" onclick="closeSolanaModal()"></div>
        <div class="wallet-modal-content">
            <div class="wallet-modal-header">
                <h3>Connect Solana Wallet</h3>
                <button class="wallet-modal-close" onclick="closeSolanaModal()">‚úï</button>
            </div>
            <div class="wallet-modal-body">
                <button class="wallet-btn" onclick="connectSolanaWallet('phantom')">Phantom</button>
                <button class="wallet-btn" onclick="connectSolanaWallet('solflare')">Solflare</button>
                <button class="wallet-btn" onclick="connectSolanaWallet('backpack')">Backpack</button>
                <p class="wallet-hint" id="solanaConnectHint"></p>
            </div>
        </div>
    </div>

    <!-- KYC Announcement (Delayed Toast) -->
    <div id="kycToast" class="kyc-toast" role="dialog" aria-live="polite" aria-label="KYC announcement">
        <div class="kyc-toast-header">
            <div class="kyc-toast-title"><i class="fas fa-shield-alt"></i> KYC Verification ‚Äî Coming Soon</div>
            <button id="kycClose" class="kyc-toast-close" aria-label="Dismiss">√ó</button>
        </div>
        <div class="kyc-toast-body">
            <p>
                To strengthen security, prevent abuse, and ensure fair participation, identity verification (KYC) will be introduced in an upcoming phase of the OPN platform.
            </p>
            <p>
                KYC is <strong>not required right now</strong>, but it will be needed later to unlock certain features such as withdrawals and advanced rewards.
            </p>
            <div class="kyc-toast-bullets">
                <div>‚úÖ Quick (typically 2‚Äì3 minutes)</div>
                <div>‚úÖ Trusted third-party provider</div>
                <div>‚úÖ Privacy-focused (we don‚Äôt store documents)</div>
            </div>

            <div id="kycFaq" class="kyc-faq" aria-hidden="true">
                <div class="kyc-faq-inner">
                    <div class="kyc-faq-title">KYC ‚Äî Frequently Asked Questions</div>

                    <div class="kyc-acc">
                        <button class="kyc-acc-btn" type="button">Why is KYC being introduced? <span>+</span></button>
                        <div class="kyc-acc-panel">
                            KYC helps protect users from bots, multi-account abuse, and fraud; ensures fair reward distribution; supports compliance as the platform grows; and prepares for future integrations.
                        </div>
                    </div>

                    <div class="kyc-acc">
                        <button class="kyc-acc-btn" type="button">Is KYC required right now? <span>+</span></button>
                        <div class="kyc-acc-panel">
                            No. KYC is not active yet and isn‚Äôt required at this stage. We‚Äôll provide clear notice before any KYC-gated features are enforced.
                        </div>
                    </div>

                    <div class="kyc-acc">
                        <button class="kyc-acc-btn" type="button">What information will I need to provide? <span>+</span></button>
                        <div class="kyc-acc-panel">
                            Typically a government-issued ID (passport/national ID/driver‚Äôs license) plus a quick liveness check (selfie or short video).
                        </div>
                    </div>

                    <div class="kyc-acc">
                        <button class="kyc-acc-btn" type="button">Is my personal data safe? <span>+</span></button>
                        <div class="kyc-acc-panel">
                            Yes. Verification will be handled by a certified third-party provider. The platform receives only your verification status ‚Äî not your raw documents.
                        </div>
                    </div>

                    <div class="kyc-acc">
                        <button class="kyc-acc-btn" type="button">Which countries will be supported? <span>+</span></button>
                        <div class="kyc-acc-panel">
                            Most countries will be supported. Some jurisdictions may be restricted due to regulatory requirements. Full details will be shared before launch.
                        </div>
                    </div>

                    <div class="kyc-acc">
                        <button class="kyc-acc-btn" type="button">How long does verification take? <span>+</span></button>
                        <div class="kyc-acc-panel">
                            Most verifications take about 2‚Äì3 minutes and approve instantly or near-instantly. Rare manual reviews may take longer.
                        </div>
                    </div>

                    <div class="kyc-acc">
                        <button class="kyc-acc-btn" type="button">Will KYC be required for everyone? <span>+</span></button>
                        <div class="kyc-acc-panel">
                            Only users who want to use KYC-gated features (like withdrawals or advanced rewards) will need to verify.
                        </div>
                    </div>

                </div>
            </div>
        </div>
        <div class="kyc-toast-actions">
            <button id="kycLearnMore" class="kyc-link" type="button">Learn more</button>
            <button id="kycGotIt" class="kyc-btn primary" type="button">Got it</button>
        </div>
    </div>
    <div id="kycPill" class="kyc-pill" role="button" tabindex="0" aria-label="Open KYC announcement">
        <i class="fas fa-lock"></i> KYC coming soon
    </div>

<!-- Push Notification Prompt -->
<div id="pushPrompt" class="push-prompt hidden" role="dialog" aria-live="polite">
  <div class="push-text">
    <p class="push-title">Get updates</p>
    <p class="push-desc">Enable notifications to receive important presale and airdrop updates (max 1 per day).</p>
  </div>
  <div class="push-actions">
    <button id="pushEnableBtn" class="btn-enable" type="button">Enable</button>
    <button id="pushDismissBtn" class="btn-dismiss" type="button">Not now</button>
  </div>
</div>


    <!-- Floating Support Button -->
    <div id="supportWidget">
        <div id="supportBubble" class="support-bubble" role="dialog" aria-live="polite">
            <button id="supportBubbleClose" class="support-bubble-close" aria-label="Dismiss">√ó</button>
            <div class="support-bubble-title">Hi üëã</div>
            <div class="support-bubble-text">How can I help you?</div>
        </div>
        <button id="supportFab" class="support-fab" aria-label="Contact support">
            <i class="fab fa-telegram-plane"></i>
        </button>
    </div>

    <script>
        // ==================== KYC Announcement Logic ====================
        (function(){
            const TOAST_ID = 'kycToast';
            const PILL_ID = 'kycPill';
            const KEY_SEEN = 'apro_kyc_note_seen_v1';
            const KEY_DISMISS_UNTIL = 'apro_kyc_note_dismissed_until_v1';
            const DISMISS_DAYS = 14;
            const ACTIVE_SECONDS_TO_SHOW = 45; // delayed trigger

            const toast = document.getElementById(TOAST_ID);
            const pill = document.getElementById(PILL_ID);
            const closeBtn = document.getElementById('kycClose');
            const gotItBtn = document.getElementById('kycGotIt');
            const learnMoreBtn = document.getElementById('kycLearnMore');
            const faq = document.getElementById('kycFaq');

            if (!toast || !pill) return;

            const now = () => Date.now();
            const getDismissUntil = () => Number(localStorage.getItem(KEY_DISMISS_UNTIL) || 0);
            const isDismissed = () => now() < getDismissUntil();
            const markSeen = () => localStorage.setItem(KEY_SEEN, '1');
            const hasSeen = () => localStorage.getItem(KEY_SEEN) === '1';
            const setDismissForDays = (days) => {
                const until = now() + days * 24 * 60 * 60 * 1000;
                localStorage.setItem(KEY_DISMISS_UNTIL, String(until));
            };

            function showToast(){
                if (isDismissed()) return;
                toast.classList.add('show');
                pill.style.display = 'none';
                markSeen();
            }
            function hideToast(minimize){
                toast.classList.remove('show');
                if (minimize) {
                    pill.style.display = 'flex';
                }
            }
            function dismiss(){
                setDismissForDays(DISMISS_DAYS);
                hideToast(false);
                pill.style.display = 'none';
            }

            // Accordion behavior
            function initFaqAccordions(){
                const acc = toast.querySelectorAll('.kyc-acc');
                acc.forEach((item) => {
                    const btn = item.querySelector('.kyc-acc-btn');
                    const sign = btn ? btn.querySelector('span') : null;
                    if (!btn) return;
                    btn.addEventListener('click', () => {
                        const isOpen = item.classList.contains('open');
                        // close others
                        acc.forEach((x) => {
                            x.classList.remove('open');
                            const s = x.querySelector('.kyc-acc-btn span');
                            if (s) s.textContent = '+';
                        });
                        if (!isOpen) {
                            item.classList.add('open');
                            if (sign) sign.textContent = '‚Äì';
                        }
                    });
                });
            }
            initFaqAccordions();

            // Learn more toggle
            function toggleFaq(forceOpen){
                const open = typeof forceOpen === 'boolean' ? forceOpen : !faq.classList.contains('open');
                faq.classList.toggle('open', open);
                faq.setAttribute('aria-hidden', open ? 'false' : 'true');
                learnMoreBtn.textContent = open ? 'Hide details' : 'Learn more';
            }

            // Buttons
            closeBtn?.addEventListener('click', () => hideToast(true));
            gotItBtn?.addEventListener('click', () => dismiss());
            learnMoreBtn?.addEventListener('click', () => toggleFaq());

            pill.addEventListener('click', () => showToast());
            pill.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' || e.key === ' ') showToast();
            });

            // Intent-based triggers
            function attachIntentTriggers(){
                const ids = ['web3ConnectWallet', 'solConnectBtn', 'dashboardClaimBtn', 'withdrawBtn'];
                ids.forEach((id) => {
                    const el = document.getElementById(id);
                    if (!el) return;
                    el.addEventListener('click', () => {
                        if (isDismissed()) return;
                        // show immediately on intent
                        showToast();
                    }, { passive: true });
                });
            }
            // Some elements (like dashboardClaimBtn) appear after wallet connection; observe DOM changes.
            const obs = new MutationObserver(() => attachIntentTriggers());
            obs.observe(document.documentElement, { childList: true, subtree: true });
            attachIntentTriggers();

            // Delayed trigger (active engagement)
            let lastInteraction = now();
            let activeSeconds = 0;
            const bump = () => { lastInteraction = now(); };
            ['mousemove','mousedown','keydown','touchstart','scroll'].forEach(evt => window.addEventListener(evt, bump, { passive: true }));

            function tick(){
                if (toast.classList.contains('show')) return;
                if (isDismissed()) return;
                if (document.visibilityState !== 'visible') return;
                // Count only if the user interacted recently (last 10s)
                if (now() - lastInteraction < 10000) {
                    activeSeconds += 1;
                }
                if (activeSeconds >= ACTIVE_SECONDS_TO_SHOW) {
                    showToast();
                }
            }
            // Only run timer if user hasn't seen it yet or the dismissal expired
            if (!hasSeen() && !isDismissed()) {
                setInterval(tick, 1000);
            }

            // If previously minimized but not dismissed, keep pill visible on reload
            if (hasSeen() && !isDismissed()) {
                pill.style.display = 'flex';
            }
        })();
    </script>


    <!-- Google Translate (hidden widget + custom controller) -->
    <script>
        function googleTranslateElementInit() {
            try {
                new google.translate.TranslateElement(
                    { pageLanguage: 'en', autoDisplay: false },
                    'google_translate_element'
                );
            } catch (e) {}
        }

        (function () {
            const STORAGE_KEY = 'apro_lang';
            const btn = document.getElementById('langBtn');
            const dropdown = document.getElementById('langDropdown');
            const label = document.getElementById('currentLang');

            const langToLabel = {
                'en': 'EN', 'es': 'ES', 'fr': 'FR', 'de': 'DE', 'pt': 'PT',
                'ru': 'RU', 'tr': 'TR', 'ar': 'AR', 'hi': 'HI', 'id': 'ID',
                'zh-CN': 'ZH', 'ja': 'JA'
            };

            function setCookie(name, value, days) {
                const d = new Date();
                d.setTime(d.getTime() + (days * 24 * 60 * 60 * 1000));
                document.cookie = name + '=' + value + ';expires=' + d.toUTCString() + ';path=/';
            }

            function getCookie(name) {
                const m = document.cookie.match(new RegExp('(?:^|; )' + name.replace(/([.$?*|{}()\[\]\\\/\+^])/g, '\\$1') + '=([^;]*)'));
                return m ? decodeURIComponent(m[1]) : null;
            }

            function openDropdown(open) {
                if (!dropdown) return;
                if (open) dropdown.classList.add('open');
                else dropdown.classList.remove('open');
            }

            function applyLanguage(lang) {
                if (!lang) return;

                try { localStorage.setItem(STORAGE_KEY, lang); } catch (e) {}
                setCookie('googtrans', '/en/' + lang, 365);

                if (label) label.textContent = langToLabel[lang] || lang.toUpperCase().slice(0, 2);

                const start = Date.now();
                (function trySet() {
                    const select = document.querySelector('.goog-te-combo');
                    if (select) {
                        select.value = lang;
                        select.dispatchEvent(new Event('change'));
                        return;
                    }
                    if (Date.now() - start < 6000) setTimeout(trySet, 150);
                })();
            }

            function detectInitialLang() {
                const cookie = getCookie('googtrans');
                if (cookie && cookie.indexOf('/en/') === 0) return cookie.replace('/en/', '');
                try {
                    const stored = localStorage.getItem(STORAGE_KEY);
                    if (stored) return stored;
                } catch (e) {}
                const b = (navigator.language || 'en').toLowerCase();
                if (b.startsWith('es')) return 'es';
                if (b.startsWith('fr')) return 'fr';
                if (b.startsWith('de')) return 'de';
                if (b.startsWith('pt')) return 'pt';
                if (b.startsWith('ru')) return 'ru';
                if (b.startsWith('tr')) return 'tr';
                if (b.startsWith('ar')) return 'ar';
                if (b.startsWith('hi')) return 'hi';
                if (b.startsWith('id')) return 'id';
                if (b.startsWith('zh')) return 'zh-CN';
                if (b.startsWith('ja')) return 'ja';
                return 'en';
            }

            if (btn && dropdown) {
                btn.addEventListener('click', function (e) {
                    e.stopPropagation();
                    openDropdown(!dropdown.classList.contains('open'));
                });

                dropdown.addEventListener('click', function (e) {
                    const t = e.target.closest('[data-lang]');
                    if (!t) return;
                    const lang = t.getAttribute('data-lang');
                    openDropdown(false);
                    applyLanguage(lang);
                });

                document.addEventListener('click', function () { openDropdown(false); });
                document.addEventListener('keydown', function (e) {
                    if (e.key === 'Escape') openDropdown(false);
                });
            }

            const initial = detectInitialLang();
            if (label) label.textContent = langToLabel[initial] || 'EN';
            setTimeout(function(){ applyLanguage(initial); }, 800);
        })();
    </script>
    <script src="https://translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>


    <script src="/static/theme.js?v={{ static_ver }}"></script>
    <script>
      // Theme dropdown wiring (button stays as a t-shirt icon)
      (function(){
        const btn = document.getElementById("themeBtn");
        const dd = document.getElementById("themeDropdown");
        if(!btn || !dd || !window.APROTheme) return;

        // Mark active theme on load
        const current = window.APROTheme.getCurrent();
        document.querySelectorAll("[data-theme-option]").forEach((el) => {
          el.classList.toggle("active", el.getAttribute("data-theme-option") === current);
        });

        const close = () => dd.classList.remove("open");
        const toggle = () => dd.classList.toggle("open");

        btn.addEventListener("click", (e) => {
          e.stopPropagation();
          toggle();
        });

        dd.addEventListener("click", (e) => e.stopPropagation());

        document.addEventListener("click", close);
        document.addEventListener("keydown", (e) => { if(e.key === "Escape") close(); });

        document.querySelectorAll("[data-theme-option]").forEach((opt) => {
          opt.addEventListener("click", () => {
            const id = opt.getAttribute("data-theme-option");
            window.APROTheme.applyTheme(id);
            close();
          });
        });
      })();
    </script>

    {% include "partials/announcements_widget.html" %}
{% include "partials/a2hs_widget.html" %}

<script src="/static/themes/story_mode/story.js" defer></script>
</body>
</html>
